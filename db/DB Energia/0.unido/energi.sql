CREATE SCHEMA IF NOT EXISTS raw;
CREATE SCHEMA IF NOT EXISTS ods;
------------------------------------
CREATE TABLE public.log_sp (
	id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	id_sp int4 NULL,
	sp varchar(125) NULL,
	inicio timestamp(0) NULL,
	fin timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	inserted int4 NULL,
	updated int4 NULL,
	deleted int4 NULL,
	"nulls" int4 NULL,
	estado varchar(50) NULL,
	msj_error text NULL,
	usr_cre text DEFAULT CURRENT_USER NULL,
	CONSTRAINT log_sp_pkey PRIMARY KEY (id)
);
CREATE INDEX ix_log_sp_norm_fin_id ON public.log_sp USING btree (regexp_replace(btrim(lower((sp)::text)), '\\(\\)$'::text, ''::text), fin DESC, id DESC);
------------------------------------------------------------
CREATE TABLE public.error_energia (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL,
	fecha_carga timestamptz NOT NULL,
	tabla_origen text NOT NULL
);
-------------------------------------------

CREATE OR REPLACE PROCEDURE public.sp_grabar_log_sp(IN p_id_sp integer DEFAULT NULL::integer, IN p_inicio timestamp without time zone DEFAULT NULL::timestamp without time zone, IN p_fin timestamp without time zone DEFAULT NULL::timestamp without time zone, IN p_inserted integer DEFAULT NULL::integer, IN p_updated integer DEFAULT NULL::integer, IN p_deleted integer DEFAULT NULL::integer, IN p_nulls integer DEFAULT NULL::integer, IN p_estado character varying DEFAULT NULL::character varying, IN p_msj_error text DEFAULT NULL::text, IN p_sp text DEFAULT NULL::text)
 LANGUAGE plpgsql
AS $procedure$
BEGIN
  IF p_inicio IS NULL THEN p_inicio := clock_timestamp()::timestamp(0); END IF;
  IF p_fin    IS NULL THEN p_fin    := clock_timestamp()::timestamp(0); END IF;

  INSERT INTO public.log_sp (
    id_sp, sp, inicio, fin,
    inserted, updated, deleted, nulls, estado, msj_error
  ) VALUES (
    p_id_sp, p_sp, p_inicio, p_fin,
    p_inserted, p_updated, p_deleted, p_nulls, p_estado, p_msj_error
  );
END;
$procedure$
;
----------------------------------

CREATE OR REPLACE FUNCTION public.try_numeric(p_text text)
 RETURNS numeric
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
DECLARE
  v text;
BEGIN
  IF p_text IS NULL THEN
    RETURN NULL;
  END IF;

  -- Limpia espacios y cualquier símbolo que no sea dígito, coma, punto o guion
  v := regexp_replace(btrim(p_text), '[^0-9,.\-]', '', 'g');

  -- Caso 1: sin comas, decimal con punto (US)
  IF v ~ '^\-?\d+(\.\d+)?$' THEN
    RETURN v::numeric;
  END IF;

  -- Caso 2: con separador de miles por comas correctas, y decimal con punto
  -- Ej: -1,234,567.89  ó  1,234  ó  1,234.0
  IF v ~ '^\-?\d{1,3}(,\d{3})+(\.\d+)?$' THEN
    v := replace(v, ',', '');       -- quitamos miles
    RETURN v::numeric;              -- ya queda con decimal '.'
  END IF;

  RETURN NULL;
EXCEPTION
  WHEN OTHERS THEN
    RETURN NULL;
END;
$function$
;
-----------------

CREATE OR REPLACE FUNCTION public.log_sp_ultimo_fn(p_sp text)
 RETURNS TABLE(id integer, id_sp integer, sp text, inicio timestamp without time zone, fin timestamp without time zone, inserted integer, updated integer, deleted integer, nulls integer, estado character varying, msj_error text, usr_cre text)
 LANGUAGE sql
AS $function$
  SELECT
    id, id_sp, sp, inicio, fin, inserted, updated, deleted, "nulls",
    estado, msj_error, usr_cre
  FROM public.log_sp
  WHERE sp = p_sp
  ORDER BY COALESCE(fin, inicio, 'epoch'::timestamp) DESC, id DESC
  LIMIT 1
$function$
;
------------------------

CREATE OR REPLACE FUNCTION public.error_energia_ultimo_lote(p_tabla text)
 RETURNS SETOF error_energia
 LANGUAGE sql
 STABLE
AS $function$
  SELECT e.*
  FROM public.error_energia e
  WHERE lower(btrim(e.tabla_origen)) = lower(btrim(p_tabla))
    AND e.fecha_carga::date = CURRENT_DATE
    AND e.fecha_carga = (
      SELECT MAX(fecha_carga)
      FROM public.error_energia
      WHERE lower(btrim(tabla_origen)) = lower(btrim(p_tabla))
        AND fecha_carga::date = CURRENT_DATE
    );
$function$
;

-----RAW------------

CREATE TABLE raw.fs_mm_base_de_sitios (
	codigo_unico varchar(250) NULL,
	nombre_local varchar(250) NULL,
	direccion varchar(400) NULL,
	latitud varchar(250) NULL,
	longitud varchar(250) NULL,
	ubigeo varchar(250) NULL,
	departamento varchar(250) NULL,
	provincia varchar(250) NULL,
	distrito varchar(250) NULL,
	tipo_local varchar(250) NULL,
	proveedor_flm varchar(250) NULL,
	atencion varchar(250) NULL,
	zona varchar(250) NULL,
	tipo_zona_flm varchar(250) NULL,
	propietario_de_torre varchar(250) NULL,
	propietario_de_piso varchar(250) NULL,
	tipo_estacion varchar(250) NULL,
	tipo_torre varchar(250) NULL,
	clasificacion_instalacion varchar(250) NULL,
	fecha_puesta_en_servicio varchar(250) NULL,
	bucket varchar(250) NULL,
	sla varchar(250) NULL,
	tipo_vip varchar(250) NULL,
	criticidad_local varchar(250) NULL,
	observacion varchar(250) NULL,
	priorizacion varchar(250) NULL,
	ubigeotoa varchar(250) NULL
);
---------------------

CREATE TABLE raw.fs_mm_bitacora_base_sitios (
	codigo_unico varchar(250) NULL,
	nombre_local varchar(250) NULL,
	direccion varchar(350) NULL,
	latitud varchar(250) NULL,
	longitud varchar(250) NULL,
	ubigeo varchar(250) NULL,
	departamento varchar(250) NULL,
	provincia varchar(250) NULL,
	distrito varchar(250) NULL,
	tipo_local varchar(250) NULL,
	proveedor_flm varchar(250) NULL,
	atencion varchar(250) NULL,
	zona varchar(250) NULL,
	tipo_zona_flm varchar(250) NULL,
	propietario_de_torre varchar(250) NULL,
	propietario_de_piso varchar(250) NULL,
	tipo_estacion varchar(250) NULL,
	tipo_torre varchar(250) NULL,
	clasificacion_instalacion varchar(250) NULL,
	fecha_puesta_en_servicio varchar(250) NULL,
	bucket varchar(250) NULL,
	sla varchar(250) NULL,
	tipo_vip varchar(250) NULL,
	criticidad_local varchar(250) NULL,
	observacion varchar(250) NULL,
	priorizacion varchar(250) NULL,
	accion varchar(250) NULL,
	solicitado_por varchar(250) NULL,
	base varchar(250) NULL,
	campo_modificado varchar(250) NULL,
	observaciones varchar(400) NULL,
	estado varchar(250) NULL
);
----------------------------

CREATE TABLE raw.sftp_mm_clientes_libres (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
------------------------------

CREATE TABLE raw.sftp_mm_consumo_suministro_da (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
------------------------------
CREATE TABLE raw.sftp_mm_consumo_suministro_pd (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
-----------

CREATE TABLE raw.web_mm_indra_energia (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
--------------------
CREATE TABLE raw.excel_hm_consumo_energia (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);

-------------ODS

CREATE TABLE ods.fs_hm_base_de_sitios (
	codigo_unico varchar(120) NULL,
	nombre_local varchar(200) NULL,
	direccion varchar(350) NULL,
	latitud numeric(11, 8) NULL,
	longitud numeric(11, 8) NULL,
	ubigeo varchar(10) NULL,
	departamento varchar(120) NULL,
	provincia varchar(120) NULL,
	distrito varchar(120) NULL,
	tipo_local varchar(120) NULL,
	proveedor_flm varchar(150) NULL,
	atencion varchar(120) NULL,
	zona varchar(120) NULL,
	tipo_zona_flm varchar(120) NULL,
	propietario_de_torre varchar(150) NULL,
	propietario_de_piso varchar(150) NULL,
	tipo_estacion varchar(120) NULL,
	tipo_torre varchar(120) NULL,
	clasificacion_instalacion varchar(150) NULL,
	fecha_puesta_en_servicio date NULL,
	bucket varchar(80) NULL,
	sla varchar(80) NULL,
	tipo_vip varchar(80) NULL,
	criticidad_local varchar(80) NULL,
	observacion varchar(500) NULL,
	priorizacion varchar(80) NULL,
	ubigeotoa varchar(120) NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL
);
----------------------------------

CREATE TABLE ods.fs_hm_bitacora_base_sitios (
	codigo_unico varchar(120) NULL,
	nombre_local varchar(200) NULL,
	direccion varchar(350) NULL,
	latitud numeric(11, 8) NULL,
	longitud numeric(11, 8) NULL,
	ubigeo varchar(10) NULL,
	departamento varchar(120) NULL,
	provincia varchar(120) NULL,
	distrito varchar(120) NULL,
	tipo_local varchar(120) NULL,
	proveedor_flm varchar(150) NULL,
	atencion varchar(120) NULL,
	zona varchar(120) NULL,
	tipo_zona_flm varchar(120) NULL,
	propietario_de_torre varchar(150) NULL,
	propietario_de_piso varchar(150) NULL,
	tipo_estacion varchar(120) NULL,
	tipo_torre varchar(120) NULL,
	clasificacion_instalacion varchar(150) NULL,
	fecha_puesta_en_servicio date NULL,
	bucket varchar(80) NULL,
	sla varchar(80) NULL,
	tipo_vip varchar(80) NULL,
	criticidad_local varchar(80) NULL,
	observacion varchar(500) NULL,
	priorizacion varchar(80) NULL,
	accion varchar(15) NULL,
	solicitado_por varchar(120) NULL,
	base bpchar(6) NULL,
	campo_modificado varchar(150) NULL,
	observaciones varchar(450) NULL,
	estado varchar(20) NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL
);
------------------

CREATE TABLE ods.sftp_hm_clientes_libres (
	num_recibo int8 NOT NULL,
	cod_suministro int4 NULL,
	tarifa varchar(10) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision date NULL,
	fec_vencimiento date NULL,
	fec_lect_actual date NULL,
	fec_lect_anterior date NULL,
	per_consumo varchar(50) NULL,
	ea_lec_act_hp numeric(18, 2) NULL,
	ea_lec_act_fp numeric(18, 2) NULL,
	ea_lec_act_tot numeric(18, 2) NULL,
	ea_lec_ant_hp numeric(18, 2) NULL,
	ea_lec_ant_fp numeric(18, 2) NULL,
	ea_lec_ant_tot numeric(18, 2) NULL,
	ea_consumo_hp numeric(18, 2) NULL,
	ea_consumo_fp numeric(18, 2) NULL,
	ea_consumo_tot numeric(18, 2) NULL,
	ea_pu_hp numeric(18, 6) NULL,
	ea_pu_fp numeric(18, 6) NULL,
	ea_prec_unit_tot numeric(18, 6) NULL,
	ea_importe_hp numeric(18, 2) NULL,
	ea_importe_fp numeric(18, 2) NULL,
	ea_importe_tot numeric(18, 2) NULL,
	pot_lect_act_hp numeric(18, 2) NULL,
	pot_lect_act_fp numeric(18, 2) NULL,
	pot_lect_ant_hp numeric(18, 2) NULL,
	pot_lect_ant_fp numeric(18, 2) NULL,
	pot_reg_hp numeric(18, 2) NULL,
	pot_reg_fp numeric(18, 2) NULL,
	pot_gen_fact numeric(18, 2) NULL,
	pot_gen_pu numeric(18, 6) NULL,
	pot_gen_importe numeric(18, 2) NULL,
	pot_dist_fact numeric(18, 2) NULL,
	pot_dist_pu numeric(18, 6) NULL,
	pot_dist_importe numeric(18, 2) NULL,
	pot_bt6_pu numeric(18, 6) NULL,
	pot_bt6_monto numeric(18, 2) NULL,
	er_lec_act numeric(18, 2) NULL,
	er_lec_ant numeric(18, 2) NULL,
	er_cons numeric(18, 2) NULL,
	er_fact numeric(18, 2) NULL,
	er_pu numeric(18, 6) NULL,
	er_importe numeric(18, 2) NULL,
	calif_cliente varchar(100) NULL,
	dias_punta int4 NULL,
	horas_punta int4 NULL,
	factor_calif varchar(50) NULL,
	cargo_fijo numeric(18, 2) NULL,
	mantenimiento numeric(18, 2) NULL,
	alumbrado numeric(18, 2) NULL,
	recup_energia numeric(18, 2) NULL,
	mora numeric(18, 2) NULL,
	reconexion numeric(18, 2) NULL,
	ajuste_tarifa numeric(18, 2) NULL,
	dist_factura numeric(18, 2) NULL,
	ajuste_alumb numeric(18, 2) NULL,
	otros_afectos numeric(18, 2) NULL,
	base_imponible numeric(18, 2) NULL,
	igv numeric(18, 2) NULL,
	tot_periodo numeric(18, 2) NULL,
	electrif_rural numeric(18, 2) NULL,
	comp_distribucion numeric(18, 2) NULL,
	comp_generadora numeric(18, 2) NULL,
	comp_interrup numeric(18, 2) NULL,
	comp_calidad numeric(18, 2) NULL,
	comp_frec_ant numeric(18, 2) NULL,
	comp_frec_des numeric(18, 2) NULL,
	comp_serv numeric(18, 2) NULL,
	comp_norma_tec numeric(18, 2) NULL,
	comp_deuda_ant numeric(18, 2) NULL,
	comp_deuda_meses int4 NULL,
	comp_dev_reclamo numeric(18, 2) NULL,
	comp_nota_deb_cred numeric(18, 2) NULL,
	comp_aporte_reemb numeric(18, 2) NULL,
	comp_otros_inafectos numeric(18, 2) NULL,
	comp_redondeo_act_pos numeric(18, 2) NULL,
	comp_redondeo_act_neg numeric(18, 2) NULL,
	costo_medio numeric(18, 2) NULL,
	total_a_pagar numeric(18, 2) NULL,
	valor_venta numeric(18, 2) NULL,
	deuda_anterior numeric(18, 2) NULL,
	devolucion numeric(18, 2) NULL,
	fecha_liquidacion date NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL,
	CONSTRAINT sftp_hm_clientes_libres_pkey PRIMARY KEY (num_recibo)
);

---------------


CREATE TABLE ods.sftp_hm_consumo_suministro (
	num_recibo varchar(250) NOT NULL,
	cod_suministro int4 NULL,
	tarifa varchar(10) NULL,
  pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision date NULL,
	fec_vencimiento date NULL,
	fec_lect_actual date NULL,
	fec_lect_anterior date NULL,
	per_consumo varchar(50) NULL,
	ea_lec_act_hp numeric(18, 2) NULL,
	ea_lec_act_fp numeric(18, 2) NULL,
	ea_lec_act_tot numeric(18, 2) NULL,
	ea_lec_ant_hp numeric(18, 2) NULL,
	ea_lec_ant_fp numeric(18, 2) NULL,
	ea_lec_ant_tot numeric(18, 2) NULL,
	ea_consumo_hp numeric(18, 2) NULL,
	ea_consumo_fp numeric(18, 2) NULL,
	ea_consumo_tot numeric(18, 2) NULL,
	ea_pu_hp numeric(18, 6) NULL,
	ea_pu_fp numeric(18, 6) NULL,
	ea_prec_unit_tot numeric(18, 6) NULL,
	ea_importe_hp numeric(18, 2) NULL,
	ea_importe_fp numeric(18, 2) NULL,
	ea_importe_tot numeric(18, 2) NULL,
	pot_lect_act_hp numeric(18, 2) NULL,
	pot_lect_act_fp numeric(18, 2) NULL,
	pot_lect_ant_hp numeric(18, 2) NULL,
	pot_lect_ant_fp numeric(18, 2) NULL,
	pot_reg_hp numeric(18, 2) NULL,
	pot_reg_fp numeric(18, 2) NULL,
	pot_gen_fact numeric(18, 2) NULL,
	pot_gen_pu numeric(18, 6) NULL,
	pot_gen_importe numeric(18, 2) NULL,
	pot_dist_fact numeric(18, 2) NULL,
	pot_dist_pu numeric(18, 6) NULL,
	pot_dist_importe numeric(18, 2) NULL,
	pot_bt6_pu numeric(18, 6) NULL,
	pot_bt6_monto numeric(18, 2) NULL,
	er_lec_act numeric(18, 2) NULL,
	er_lec_ant numeric(18, 2) NULL,
	er_cons numeric(18, 2) NULL,
	er_fact numeric(18, 2) NULL,
	er_pu numeric(18, 6) NULL,
	er_importe numeric(18, 2) NULL,
	calif_cliente varchar(100) NULL,
	dias_punta int4 NULL,
	horas_punta int4 NULL,
	factor_calif varchar(50) NULL,
	cargo_fijo numeric(18, 2) NULL,
	mantenimiento numeric(18, 2) NULL,
	alumbrado numeric(18, 2) NULL,
	recup_energia numeric(18, 2) NULL,
	mora numeric(18, 2) NULL,
	reconexion numeric(18, 2) NULL,
	ajuste_tarifa numeric(18, 2) NULL,
	dist_factura numeric(18, 2) NULL,
	ajuste_alumb numeric(18, 2) NULL,
	otros_afectos numeric(18, 2) NULL,
	base_imponible numeric(18, 2) NULL,
	igv numeric(18, 2) NULL,
	tot_periodo numeric(18, 2) NULL,
	electrif_rural numeric(18, 2) NULL,
	comp_distribucion numeric(18, 2) NULL,
	comp_generadora numeric(18, 2) NULL,
	comp_interrup numeric(18, 2) NULL,
	comp_calidad numeric(18, 2) NULL,
	comp_frec_ant numeric(18, 2) NULL,
	comp_frec_des numeric(18, 2) NULL,
	comp_serv numeric(18, 2) NULL,
	comp_norma_tec numeric(18, 2) NULL,
	comp_deuda_ant numeric(18, 2) NULL,
	comp_deuda_meses int4 NULL,
	comp_dev_reclamo numeric(18, 2) NULL,
	comp_nota_deb_cred numeric(18, 2) NULL,
	comp_aporte_reemb numeric(18, 2) NULL,
	comp_otros_inafectos numeric(18, 2) NULL,
	comp_redondeo_act_pos numeric(18, 2) NULL,
	comp_redondeo_act_neg numeric(18, 2) NULL,
	costo_medio numeric(18, 2) NULL,
	total_a_pagar numeric(18, 2) NULL,
	valor_venta numeric(18, 2) NULL,
	deuda_anterior numeric(18, 2) NULL,
	devolucion numeric(18, 2) NULL,
	fecha_liquidacion date NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL,
	CONSTRAINT sftp_hm_consumo_suministro_pkey PRIMARY KEY (num_recibo)
);
-------------

CREATE TABLE ods.web_hm_indra_energia (
	num_recibo varchar(250) NOT NULL,
	cod_suministro varchar(250) NULL,
	tarifa varchar(10) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision date NULL,
	fec_vencimiento date NULL,
	fec_lect_actual date NULL,
	fec_lect_anterior date NULL,
	per_consumo varchar(50) NULL,
	ea_lec_act_hp numeric(18, 2) NULL,
	ea_lec_act_fp numeric(18, 2) NULL,
	ea_lec_act_tot numeric(18, 2) NULL,
	ea_lec_ant_hp numeric(18, 2) NULL,
	ea_lec_ant_fp numeric(18, 2) NULL,
	ea_lec_ant_tot numeric(18, 2) NULL,
	ea_consumo_hp numeric(18, 2) NULL,
	ea_consumo_fp numeric(18, 2) NULL,
	ea_consumo_tot numeric(18, 2) NULL,
	ea_pu_hp numeric(18, 6) NULL,
	ea_pu_fp numeric(18, 6) NULL,
	ea_prec_unit_tot numeric(18, 6) NULL,
	ea_importe_hp numeric(18, 2) NULL,
	ea_importe_fp numeric(18, 2) NULL,
	ea_importe_tot numeric(18, 2) NULL,
	pot_lect_act_hp numeric(18, 2) NULL,
	pot_lect_act_fp numeric(18, 2) NULL,
	pot_lect_ant_hp numeric(18, 2) NULL,
	pot_lect_ant_fp numeric(18, 2) NULL,
	pot_reg_hp numeric(18, 2) NULL,
	pot_reg_fp numeric(18, 2) NULL,
	pot_gen_fact numeric(18, 2) NULL,
	pot_gen_pu numeric(18, 6) NULL,
	pot_gen_importe numeric(18, 2) NULL,
	pot_dist_fact numeric(18, 2) NULL,
	pot_dist_pu numeric(18, 6) NULL,
	pot_dist_importe numeric(18, 2) NULL,
	pot_bt6_pu numeric(18, 6) NULL,
	pot_bt6_monto numeric(18, 2) NULL,
	er_lec_act numeric(18, 2) NULL,
	er_lec_ant numeric(18, 2) NULL,
	er_cons numeric(18, 2) NULL,
	er_fact numeric(18, 2) NULL,
	er_pu numeric(18, 6) NULL,
	er_importe numeric(18, 2) NULL,
	calif_cliente varchar(100) NULL,
	dias_punta int4 NULL,
	horas_punta int4 NULL,
	factor_calif varchar(50) NULL,
	cargo_fijo numeric(18, 2) NULL,
	mantenimiento numeric(18, 2) NULL,
	alumbrado numeric(18, 2) NULL,
	recup_energia numeric(18, 2) NULL,
	mora numeric(18, 2) NULL,
	reconexion numeric(18, 2) NULL,
	ajuste_tarifa numeric(18, 2) NULL,
	dist_factura numeric(18, 2) NULL,
	ajuste_alumb numeric(18, 2) NULL,
	otros_afectos numeric(18, 2) NULL,
	base_imponible numeric(18, 2) NULL,
	igv numeric(18, 2) NULL,
	tot_periodo numeric(18, 2) NULL,
	electrif_rural numeric(18, 2) NULL,
	comp_distribucion numeric(18, 2) NULL,
	comp_generadora numeric(18, 2) NULL,
	comp_interrup numeric(18, 2) NULL,
	comp_calidad numeric(18, 2) NULL,
	comp_frec_ant numeric(18, 2) NULL,
	comp_frec_des numeric(18, 2) NULL,
	comp_serv numeric(18, 2) NULL,
	comp_norma_tec numeric(18, 2) NULL,
	comp_deuda_ant numeric(18, 2) NULL,
	comp_deuda_meses int4 NULL,
	comp_dev_reclamo numeric(18, 2) NULL,
	comp_nota_deb_cred numeric(18, 2) NULL,
	comp_aporte_reemb numeric(18, 2) NULL,
	comp_otros_inafectos numeric(18, 2) NULL,
	comp_redondeo_act_pos numeric(18, 2) NULL,
	comp_redondeo_act_neg numeric(18, 2) NULL,
	costo_medio numeric(18, 2) NULL,
	total_a_pagar numeric(18, 2) NULL,
	valor_venta numeric(18, 2) NULL,
	deuda_anterior numeric(18, 2) NULL,
	devolucion numeric(18, 2) NULL,
	fecha_liquidacion date NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL,
	CONSTRAINT web_hm_indra_energia_pkey PRIMARY KEY (num_recibo)
);



---------



CREATE OR REPLACE PROCEDURE ods.sp_cargar_fs_hm_base_de_sitios()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio    timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp     integer      := 'ods.sp_cargar_fs_hm_base_de_sitios()'::regprocedure::oid::int;
  v_sp_name   text         := 'ods.sp_cargar_fs_hm_base_de_sitios()'::regprocedure::text;

  v_inserted  integer := 0;
  v_updated   integer := 0;
  v_deleted   integer := 0;
  v_nulls     integer := NULL;

  v_estado    varchar(50);
  v_msj       text;
BEGIN
  /*
    Flujo:
      1) Contar filas actuales en ODS y TRUNCATE (full refresh).
      2) Limpiar RAW (raw_clean) sin colapsar ni filtrar cu.
      3) Insertar TODO raw_clean -> ODS.
      4) Log.
  */

  -- 1) Contamos antes de truncar para reportar cuántas se eliminaron
  SELECT COUNT(*) INTO v_deleted FROM ods.fs_hm_base_de_sitios;

  -- IMPORTANTE:
  --  - Si hay FKs a ods.fs_hm_base_de_sitios, usar: TRUNCATE TABLE ods.fs_hm_base_de_sitios CASCADE;
  --  - Si necesitas reiniciar identidades: TRUNCATE TABLE ods.fs_hm_base_de_sitios RESTART IDENTITY;
  TRUNCATE TABLE ods.fs_hm_base_de_sitios;

  WITH
  raw_clean AS (
    SELECT
      TRIM(r.codigo_unico)                                   AS cu,           -- NO se filtra; conserva nulos/vacíos si vienen así
      LEFT(NULLIF(TRIM(r.nombre_local),''), 200)             AS nombre_local,
      LEFT(NULLIF(TRIM(r.direccion),''), 350)                AS direccion,

      -- Lat/Lon solo decimales (con coma o punto). Si no cumple patrón → NULL
      CASE
        WHEN TRIM(r.latitud)  ~ '^\s*[+-]?\d+(?:[.,]\d+)?\s*$'
          THEN REPLACE(TRIM(r.latitud), ',', '.')::numeric(11,8)
        ELSE NULL
      END                                                    AS latitud,
      CASE
        WHEN TRIM(r.longitud) ~ '^\s*[+-]?\d+(?:[.,]\d+)?\s*$'
          THEN REPLACE(TRIM(r.longitud), ',', '.')::numeric(11,8)
        ELSE NULL
      END                                                    AS longitud,

      LEFT(NULLIF(TRIM(r.ubigeo),''), 10)                    AS ubigeo,
      LEFT(NULLIF(TRIM(r.departamento),''), 120)             AS departamento,
      LEFT(NULLIF(TRIM(r.provincia),''), 120)                AS provincia,
      LEFT(NULLIF(TRIM(r.distrito),''), 120)                 AS distrito,
      LEFT(NULLIF(TRIM(r.tipo_local),''), 120)               AS tipo_local,
      LEFT(NULLIF(TRIM(r.proveedor_flm),''), 150)            AS proveedor_flm,
      LEFT(NULLIF(TRIM(r.atencion),''), 120)                 AS atencion,
      LEFT(NULLIF(TRIM(r.zona),''), 120)                     AS zona,
      LEFT(NULLIF(TRIM(r.tipo_zona_flm),''), 120)            AS tipo_zona_flm,
      LEFT(NULLIF(TRIM(r.propietario_de_torre),''), 150)     AS propietario_de_torre,
      LEFT(NULLIF(TRIM(r.propietario_de_piso),''), 150)      AS propietario_de_piso,
      LEFT(NULLIF(TRIM(r.tipo_estacion),''), 120)            AS tipo_estacion,
      LEFT(NULLIF(TRIM(r.tipo_torre),''), 120)               AS tipo_torre,
      LEFT(NULLIF(TRIM(r.clasificacion_instalacion),''),150) AS clasificacion_instalacion,
      CASE
        WHEN NULLIF(TRIM(r.fecha_puesta_en_servicio),'') IS NULL THEN NULL
        WHEN r.fecha_puesta_en_servicio ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_puesta_en_servicio::date
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD/MM/YYYY')
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD-MM-YYYY')
        ELSE NULL
      END                                                    AS fecha_puesta_en_servicio,
      LEFT(NULLIF(TRIM(r.bucket),''), 80)                    AS bucket,
      LEFT(NULLIF(TRIM(r.sla),''), 80)                       AS sla,
      LEFT(NULLIF(TRIM(r.tipo_vip),''), 80)                  AS tipo_vip,
      LEFT(NULLIF(TRIM(r.criticidad_local),''), 80)          AS criticidad_local,
      LEFT(NULLIF(TRIM(r.observacion),''), 500)              AS observacion,
      LEFT(NULLIF(TRIM(r.priorizacion),''), 80)              AS priorizacion,
      LEFT(NULLIF(TRIM(r.ubigeotoa),''), 120)                AS ubigeotoa
    FROM raw.fs_mm_base_de_sitios r
  ),
  ins AS (
    INSERT INTO ods.fs_hm_base_de_sitios (
      codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, ubigeotoa
    )
    SELECT
      cu AS codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, ubigeotoa
    FROM raw_clean
    RETURNING 1
  )
  SELECT COALESCE((SELECT COUNT(*) FROM ins), 0)
  INTO v_inserted;

  v_estado := 'DONE';
  v_msj := format('Full refresh fs_hm_base_de_sitios: truncated=%s, inserted=%s', v_deleted, v_inserted);

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,   -- 0
    p_deleted    => v_deleted,   -- filas eliminadas por el TRUNCATE
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;
-------------

CREATE OR REPLACE PROCEDURE ods.sp_cargar_fs_hm_bitacora_base_sitios()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio    timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp     integer      := 'ods.sp_cargar_fs_hm_bitacora_base_sitios()'::regprocedure::oid::int;
  v_sp_name   text         := 'ods.sp_cargar_fs_hm_bitacora_base_sitios()'::regprocedure::text;

  v_inserted  integer := 0;
  v_updated   integer := 0;
  v_deleted   integer := 0;
  v_nulls     integer := NULL;

  v_estado    varchar(50);
  v_msj       text;
BEGIN
  /* 1) Contamos filas actuales y truncamos destino (full refresh) */
  SELECT COUNT(*) INTO v_deleted FROM ods.fs_hm_bitacora_base_sitios;
  TRUNCATE TABLE ods.fs_hm_bitacora_base_sitios;
  -- Opcional: TRUNCATE TABLE ods.fs_hm_bitacora_base_sitios RESTART IDENTITY;

  WITH
  raw_clean AS (
    SELECT
      NULLIF(TRIM(r.codigo_unico),'')                          AS cu,
      LEFT(NULLIF(TRIM(r.nombre_local),''), 200)               AS nombre_local,
      LEFT(NULLIF(TRIM(r.direccion),''), 350)                  AS direccion,

      /* ===== LATITUD ===== */
      (
        CASE
          -- Decimal
          WHEN TRIM(r.latitud) ~* '^\s*[+-]?\d+(?:[.,]\d+)?\s*[NSEWO]?\s*$' THEN
            ( NULLIF(REPLACE(TRIM(regexp_replace(r.latitud, '[^0-9\+\-.,]', '', 'g')), ',', '.'), '')::numeric )
            * CASE WHEN TRIM(r.latitud) ~* '[SWO]' THEN -1 ELSE 1 END

          -- DMS
          WHEN TRIM(r.latitud) ~* '^\s*\d+(?:\s*[°º]\s*\d+)?(?:\s*[''’′m]\s*\d+(?:[.,]\d+)?)?(?:\s*["”″s])?\s*[NSEWO]?\s*$' THEN
            (
              COALESCE((regexp_match(TRIM(r.latitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[1], '0')::numeric
              + COALESCE((regexp_match(TRIM(r.latitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[2], '0')::numeric / 60
              + COALESCE(REPLACE(COALESCE((regexp_match(TRIM(r.latitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[3], '0'), ',', '.')::numeric, 0) / 3600
            ) * CASE
                  WHEN COALESCE((regexp_match(TRIM(r.latitud),
                    '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
                  ))[4], 'N') ~* '^[SWO]$' THEN -1 ELSE 1
                END
          ELSE NULL
        END
      )::numeric(11,8) AS latitud,

      /* ===== LONGITUD ===== */
      (
        CASE
          -- Decimal
          WHEN TRIM(r.longitud) ~* '^\s*[+-]?\d+(?:[.,]\d+)?\s*[NSEWO]?\s*$' THEN
            ( NULLIF(REPLACE(TRIM(regexp_replace(r.longitud, '[^0-9\+\-.,]', '', 'g')), ',', '.'), '')::numeric )
            * CASE WHEN TRIM(r.longitud) ~* '[SWO]' THEN -1 ELSE 1 END

          -- DMS (paréntesis balanceados)
          WHEN TRIM(r.longitud) ~* '^\s*\d+(?:\s*[°º]\s*\d+)?(?:\s*[''’′m]\s*\d+(?:[.,]\d+)?)?(?:\s*["”″s])?\s*[NSEWO]?\s*$' THEN
            (
              COALESCE((regexp_match(TRIM(r.longitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[1], '0')::numeric
              + COALESCE((regexp_match(TRIM(r.longitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[2], '0')::numeric / 60
              + COALESCE(REPLACE(COALESCE((regexp_match(TRIM(r.longitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[3], '0'), ',', '.')::numeric, 0) / 3600
            ) * CASE
                  WHEN COALESCE((regexp_match(TRIM(r.longitud),
                    '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
                  ))[4], 'E') ~* '^[SWO]$' THEN -1 ELSE 1
                END
          ELSE NULL
        END
      )::numeric(11,8) AS longitud,

      LEFT(NULLIF(TRIM(r.ubigeo),''), 10)                      AS ubigeo,
      LEFT(NULLIF(TRIM(r.departamento),''), 120)               AS departamento,
      LEFT(NULLIF(TRIM(r.provincia),''), 120)                  AS provincia,
      LEFT(NULLIF(TRIM(r.distrito),''), 120)                   AS distrito,
      LEFT(NULLIF(TRIM(r.tipo_local),''), 120)                 AS tipo_local,
      LEFT(NULLIF(TRIM(r.proveedor_flm),''), 150)              AS proveedor_flm,
      LEFT(NULLIF(TRIM(r.atencion),''), 120)                   AS atencion,
      LEFT(NULLIF(TRIM(r.zona),''), 120)                       AS zona,
      LEFT(NULLIF(TRIM(r.tipo_zona_flm),''), 120)              AS tipo_zona_flm,
      LEFT(NULLIF(TRIM(r.propietario_de_torre),''), 150)       AS propietario_de_torre,
      LEFT(NULLIF(TRIM(r.propietario_de_piso),''), 150)        AS propietario_de_piso,
      LEFT(NULLIF(TRIM(r.tipo_estacion),''), 120)              AS tipo_estacion,
      LEFT(NULLIF(TRIM(r.tipo_torre),''), 120)                 AS tipo_torre,
      LEFT(NULLIF(TRIM(r.clasificacion_instalacion),''), 150)  AS clasificacion_instalacion,
      CASE
        WHEN NULLIF(TRIM(r.fecha_puesta_en_servicio),'') IS NULL THEN NULL
        WHEN r.fecha_puesta_en_servicio ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_puesta_en_servicio::date
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD/MM/YYYY')
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD-MM-YYYY')
        ELSE NULL
      END                                                      AS fecha_puesta_en_servicio,
      LEFT(NULLIF(TRIM(r.bucket),''), 80)                      AS bucket,
      LEFT(NULLIF(TRIM(r.sla),''), 80)                         AS sla,
      LEFT(NULLIF(TRIM(r.tipo_vip),''), 80)                    AS tipo_vip,
      LEFT(NULLIF(TRIM(r.criticidad_local),''), 80)            AS criticidad_local,
      LEFT(NULLIF(TRIM(r.observacion),''), 500)                AS observacion,
      LEFT(NULLIF(TRIM(r.priorizacion),''), 80)                AS priorizacion,
      LEFT(NULLIF(TRIM(r.accion),''), 15)                      AS accion,
      LEFT(NULLIF(TRIM(r.solicitado_por),''), 120)             AS solicitado_por,
      COALESCE(LEFT(TRIM(r.base), 6), '')::char(6)             AS base,
      LEFT(NULLIF(TRIM(r.campo_modificado),''), 150)           AS campo_modificado,
      LEFT(NULLIF(TRIM(r.observaciones),''), 450)              AS observaciones,
      LEFT(NULLIF(TRIM(r.estado),''), 20)                      AS estado,

      -- auxiliar para orden por fecha (ya no se usa para DISTINCT, pero se mantiene por consistencia)
      CASE
        WHEN NULLIF(TRIM(r.fecha_puesta_en_servicio),'') IS NULL THEN NULL
        WHEN r.fecha_puesta_en_servicio ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_puesta_en_servicio::date
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD/MM/YYYY')
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD-MM-YYYY')
        ELSE NULL
      END                                                      AS _ord_fecha
    FROM raw.fs_mm_bitacora_base_sitios r
  ),
  -- 2) Ya no hay DISTINCT ON: insertamos TODO
  ins AS (
    INSERT INTO ods.fs_hm_bitacora_base_sitios (
      codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, accion, solicitado_por, base,
      campo_modificado, observaciones, estado
    )
    SELECT
      cu AS codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, accion, solicitado_por, base,
      campo_modificado, observaciones, estado
    FROM raw_clean
    RETURNING 1
  )
  SELECT COALESCE((SELECT COUNT(*) FROM ins), 0)
  INTO v_inserted;

  v_estado := 'DONE';
  v_msj := format('Insert fs_hm_bitacora_base_sitios: inserted=%s, deleted=%s', v_inserted, v_deleted);

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,
    p_deleted    => v_deleted,
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;
---------------------


CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_clientes_libres()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio    timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp     integer      := 'ods.sp_cargar_sftp_hm_clientes_libres()'::regprocedure::oid::int;
  v_sp_name   text         := 'ods.sp_cargar_sftp_hm_clientes_libres()'::regprocedure::text;

  v_inserted  integer := 0;
  v_updated   integer := 0;
  v_deleted   integer := 0;
  v_nulls     integer := NULL;

  v_estado    varchar(50);
  v_msj       text;
BEGIN
  /*  UPSERT desde RAW -> ODS
      - stg: CTE con casteos/limpiezas desde RAW (todo venía como texto).
      - upd: UPDATE sólo si hay diferencias reales (IS DISTINCT FROM), RETURNING 1.
      - ins: INSERT anti-join por (num_recibo, per_consumo), RETURNING 1.
  */
  WITH
  stg AS (
    SELECT
      NULLIF(trim(r.num_recibo),'')::bigint                                   AS num_recibo,
      CASE WHEN NULLIF(trim(r.cod_suministro),'') IS NULL
           THEN NULL ELSE NULLIF(trim(r.cod_suministro),'')::int END          AS cod_suministro,
      LEFT(NULLIF(trim(r.tarifa),''),10)                                      AS tarifa,

      -- pot_contr como texto (varchar 255)
      LEFT(NULLIF(trim(r.pot_contr),''),255)::varchar(255)                    AS pot_contr,

      NULLIF(trim(r.titularidad),'')                                          AS titularidad,
      NULLIF(trim(r.distribuidor),'')                                         AS distribuidor,
      CASE
        WHEN NULLIF(trim(r.fec_emision),'') IS NULL THEN NULL
        WHEN r.fec_emision ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_emision::date
        WHEN r.fec_emision ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_emision,'DD/MM/YYYY')
        WHEN r.fec_emision ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_emision,'DD-MM-YYYY')
        ELSE NULL
      END                                                                       AS fec_emision,
      CASE
        WHEN NULLIF(trim(r.fec_vencimiento),'') IS NULL THEN NULL
        WHEN r.fec_vencimiento ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_vencimiento::date
        WHEN r.fec_vencimiento ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_vencimiento,'DD/MM/YYYY')
        WHEN r.fec_vencimiento ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_vencimiento,'DD-MM-YYYY')
        ELSE NULL
      END                                                                       AS fec_vencimiento,
      CASE
        WHEN NULLIF(trim(r.fec_lect_actual),'') IS NULL THEN NULL
        WHEN r.fec_lect_actual ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_lect_actual::date
        WHEN r.fec_lect_actual ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_lect_actual,'DD/MM/YYYY')
        WHEN r.fec_lect_actual ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_lect_actual,'DD-MM-YYYY')
        ELSE NULL
      END                                                                       AS fec_lect_actual,
      CASE
        WHEN NULLIF(trim(r.fec_lect_anterior),'') IS NULL THEN NULL
        WHEN r.fec_lect_anterior ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_lect_anterior::date
        WHEN r.fec_lect_anterior ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_lect_anterior,'DD/MM/YYYY')
        WHEN r.fec_lect_anterior ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_lect_anterior,'DD-MM-YYYY')
        ELSE NULL
      END                                                                       AS fec_lect_anterior,
      LEFT(NULLIF(trim(r.per_consumo),''),50)                                   AS per_consumo,

      NULLIF(replace(trim(r.ea_lec_act_hp),',','.'),'')::numeric(18,2)         AS ea_lec_act_hp,
      NULLIF(replace(trim(r.ea_lec_act_fp),',','.'),'')::numeric(18,2)         AS ea_lec_act_fp,
      NULLIF(replace(trim(r.ea_lec_act_tot),',','.'),'')::numeric(18,2)        AS ea_lec_act_tot,
      NULLIF(replace(trim(r.ea_lec_ant_hp),',','.'),'')::numeric(18,2)         AS ea_lec_ant_hp,
      NULLIF(replace(trim(r.ea_lec_ant_fp),',','.'),'')::numeric(18,2)         AS ea_lec_ant_fp,
      NULLIF(replace(trim(r.ea_lec_ant_tot),',','.'),'')::numeric(18,2)        AS ea_lec_ant_tot,
      NULLIF(replace(trim(r.ea_consumo_hp),',','.'),'')::numeric(18,2)         AS ea_consumo_hp,
      NULLIF(replace(trim(r.ea_consumo_fp),',','.'),'')::numeric(18,2)         AS ea_consumo_fp,
      NULLIF(replace(trim(r.ea_consumo_tot),',','.'),'')::numeric(18,2)        AS ea_consumo_tot,
      NULLIF(replace(trim(r.ea_pu_hp),',','.'),'')::numeric(18,6)              AS ea_pu_hp,
      NULLIF(replace(trim(r.ea_pu_fp),',','.'),'')::numeric(18,6)              AS ea_pu_fp,
      NULLIF(replace(trim(r.ea_prec_unit_tot),',','.'),'')::numeric(18,6)      AS ea_prec_unit_tot,
      NULLIF(replace(trim(r.ea_importe_hp),',','.'),'')::numeric(18,2)         AS ea_importe_hp,
      NULLIF(replace(trim(r.ea_importe_fp),',','.'),'')::numeric(18,2)         AS ea_importe_fp,
      NULLIF(replace(trim(r.ea_importe_tot),',','.'),'')::numeric(18,2)        AS ea_importe_tot,

      NULLIF(replace(trim(r.pot_lect_act_hp),',','.'),'')::numeric(18,2)       AS pot_lect_act_hp,
      NULLIF(replace(trim(r.pot_lect_act_fp),',','.'),'')::numeric(18,2)       AS pot_lect_act_fp,
      NULLIF(replace(trim(r.pot_lect_ant_hp),',','.'),'')::numeric(18,2)       AS pot_lect_ant_hp,
      NULLIF(replace(trim(r.pot_lect_ant_fp),',','.'),'')::numeric(18,2)       AS pot_lect_ant_fp,
      NULLIF(replace(trim(r.pot_reg_hp),',','.'),'')::numeric(18,2)            AS pot_reg_hp,
      NULLIF(replace(trim(r.pot_reg_fp),',','.'),'')::numeric(18,2)            AS pot_reg_fp,
      NULLIF(replace(trim(r.pot_gen_fact),',','.'),'')::numeric(18,2)          AS pot_gen_fact,
      NULLIF(replace(trim(r.pot_gen_pu),',','.'),'')::numeric(18,6)            AS pot_gen_pu,
      NULLIF(replace(trim(r.pot_gen_importe),',','.'),'')::numeric(18,2)       AS pot_gen_importe,
      NULLIF(replace(trim(r.pot_dist_fact),',','.'),'')::numeric(18,2)         AS pot_dist_fact,
      NULLIF(replace(trim(r.pot_dist_pu),',','.'),'')::numeric(18,6)           AS pot_dist_pu,
      NULLIF(replace(trim(r.pot_dist_importe),',','.'),'')::numeric(18,2)      AS pot_dist_importe,
      NULLIF(replace(trim(r.pot_bt6_pu),',','.'),'')::numeric(18,6)            AS pot_bt6_pu,
      NULLIF(replace(trim(r.pot_bt6_monto),',','.'),'')::numeric(18,2)         AS pot_bt6_monto,

      NULLIF(replace(trim(r.er_lec_act),',','.'),'')::numeric(18,2)            AS er_lec_act,
      NULLIF(replace(trim(r.er_lec_ant),',','.'),'')::numeric(18,2)            AS er_lec_ant,
      NULLIF(replace(trim(r.er_cons),',','.'),'')::numeric(18,2)               AS er_cons,
      NULLIF(replace(trim(r.er_fact),',','.'),'')::numeric(18,2)               AS er_fact,
      NULLIF(replace(trim(r.er_pu),',','.'),'')::numeric(18,6)                 AS er_pu,
      NULLIF(replace(trim(r.er_importe),',','.'),'')::numeric(18,2)            AS er_importe,

      LEFT(NULLIF(trim(r.calif_cliente),''),100)                               AS calif_cliente,
      CASE WHEN NULLIF(trim(r.dias_punta),'') IS NULL THEN NULL
           ELSE NULLIF(trim(r.dias_punta),'')::int END                         AS dias_punta,
      CASE WHEN NULLIF(trim(r.horas_punta),'') IS NULL THEN NULL
           ELSE NULLIF(trim(r.horas_punta),'')::int END                        AS horas_punta,
      LEFT(NULLIF(trim(r.factor_calif),''),50)                                 AS factor_calif,

      NULLIF(replace(trim(r.cargo_fijo),',','.'),'')::numeric(18,2)            AS cargo_fijo,
      NULLIF(replace(trim(r.mantenimiento),',','.'),'')::numeric(18,2)         AS mantenimiento,
      NULLIF(replace(trim(r.alumbrado),',','.'),'')::numeric(18,2)             AS alumbrado,
      NULLIF(replace(trim(r.recup_energia),',','.'),'')::numeric(18,2)         AS recup_energia,
      NULLIF(replace(trim(r.mora),',','.'),'')::numeric(18,2)                  AS mora,
      NULLIF(replace(trim(r.reconexion),',','.'),'')::numeric(18,2)            AS reconexion,
      NULLIF(replace(trim(r.ajuste_tarifa),',','.'),'')::numeric(18,2)         AS ajuste_tarifa,
      NULLIF(replace(trim(r.dist_factura),',','.'),'')::numeric(18,2)          AS dist_factura,
      NULLIF(replace(trim(r.ajuste_alumb),',','.'),'')::numeric(18,2)          AS ajuste_alumb,
      NULLIF(replace(trim(r.otros_afectos),',','.'),'')::numeric(18,2)         AS otros_afectos,
      NULLIF(replace(trim(r.base_imponible),',','.'),'')::numeric(18,2)        AS base_imponible,
      NULLIF(replace(trim(r.igv),',','.'),'')::numeric(18,2)                   AS igv,
      NULLIF(replace(trim(r.tot_periodo),',','.'),'')::numeric(18,2)           AS tot_periodo,
      NULLIF(replace(trim(r.electrif_rural),',','.'),'')::numeric(18,2)        AS electrif_rural,

      NULLIF(replace(trim(r.comp_distribucion),',','.'),'')::numeric(18,2)     AS comp_distribucion,
      NULLIF(replace(trim(r.comp_generadora),',','.'),'')::numeric(18,2)       AS comp_generadora,
      NULLIF(replace(trim(r.comp_interrup),',','.'),'')::numeric(18,2)         AS comp_interrup,
      NULLIF(replace(trim(r.comp_calidad),',','.'),'')::numeric(18,2)          AS comp_calidad,
      NULLIF(replace(trim(r.comp_frec_ant),',','.'),'')::numeric(18,2)         AS comp_frec_ant,
      NULLIF(replace(trim(r.comp_frec_des),',','.'),'')::numeric(18,2)         AS comp_frec_des,
      NULLIF(replace(trim(r.comp_serv),',','.'),'')::numeric(18,2)             AS comp_serv,
      NULLIF(replace(trim(r.comp_norma_tec),',','.'),'')::numeric(18,2)        AS comp_norma_tec,
      NULLIF(replace(trim(r.comp_deuda_ant),',','.'),'')::numeric(18,2)        AS comp_deuda_ant,
      CASE WHEN NULLIF(trim(r.comp_deuda_meses),'') IS NULL THEN NULL
           ELSE NULLIF(trim(r.comp_deuda_meses),'')::int END                   AS comp_deuda_meses,
      NULLIF(replace(trim(r.comp_dev_reclamo),',','.'),'')::numeric(18,2)      AS comp_dev_reclamo,
      NULLIF(replace(trim(r.comp_nota_deb_cred),',','.'),'')::numeric(18,2)    AS comp_nota_deb_cred,
      NULLIF(replace(trim(r.comp_aporte_reemb),',','.'),'')::numeric(18,2)     AS comp_aporte_reemb,
      NULLIF(replace(trim(r.comp_otros_inafectos),',','.'),'')::numeric(18,2)  AS comp_otros_inafectos,
      NULLIF(replace(trim(r.comp_redondeo_act_pos),',','.'),'')::numeric(18,2) AS comp_redondeo_act_pos,
      NULLIF(replace(trim(r.comp_redondeo_act_neg),',','.'),'')::numeric(18,2) AS comp_redondeo_act_neg,

      NULLIF(replace(trim(r.costo_medio),',','.'),'')::numeric(18,2)           AS costo_medio,
      NULLIF(replace(trim(r.total_a_pagar),',','.'),'')::numeric(18,2)         AS total_a_pagar,
      NULLIF(replace(trim(r.valor_venta),',','.'),'')::numeric(18,2)           AS valor_venta,
      NULLIF(replace(trim(r.deuda_anterior),',','.'),'')::numeric(18,2)        AS deuda_anterior,
      NULLIF(replace(trim(r.devolucion),',','.'),'')::numeric(18,2)            AS devolucion,

      CASE
        WHEN NULLIF(trim(r.fecha_liquidacion),'') IS NULL THEN NULL
        WHEN r.fecha_liquidacion ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_liquidacion::date
        WHEN r.fecha_liquidacion ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_liquidacion,'DD/MM/YYYY')
        WHEN r.fecha_liquidacion ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_liquidacion,'DD-MM-YYYY')
        ELSE NULL
      END                                                                       AS fecha_liquidacion
    FROM raw.sftp_mm_clientes_libres r
    WHERE NULLIF(trim(r.num_recibo),'') IS NOT NULL
      AND NULLIF(trim(r.per_consumo),'') IS NOT NULL
  ),
  upd AS (
    UPDATE ods.sftp_hm_clientes_libres t
    SET
      cod_suministro      = s.cod_suministro,
      tarifa              = s.tarifa,
      pot_contr           = s.pot_contr,
      titularidad         = s.titularidad,
      distribuidor        = s.distribuidor,
      fec_emision         = s.fec_emision,
      fec_vencimiento     = s.fec_vencimiento,
      fec_lect_actual     = s.fec_lect_actual,
      fec_lect_anterior   = s.fec_lect_anterior,
      per_consumo         = s.per_consumo,
      ea_lec_act_hp       = s.ea_lec_act_hp,
      ea_lec_act_fp       = s.ea_lec_act_fp,
      ea_lec_act_tot      = s.ea_lec_act_tot,
      ea_lec_ant_hp       = s.ea_lec_ant_hp,
      ea_lec_ant_fp       = s.ea_lec_ant_fp,
      ea_lec_ant_tot      = s.ea_lec_ant_tot,
      ea_consumo_hp       = s.ea_consumo_hp,
      ea_consumo_fp       = s.ea_consumo_fp,
      ea_consumo_tot      = s.ea_consumo_tot,
      ea_pu_hp            = s.ea_pu_hp,
      ea_pu_fp            = s.ea_pu_fp,
      ea_prec_unit_tot    = s.ea_prec_unit_tot,
      ea_importe_hp       = s.ea_importe_hp,
      ea_importe_fp       = s.ea_importe_fp,
      ea_importe_tot      = s.ea_importe_tot,
      pot_lect_act_hp     = s.pot_lect_act_hp,
      pot_lect_act_fp     = s.pot_lect_act_fp,
      pot_lect_ant_hp     = s.pot_lect_ant_hp,
      pot_lect_ant_fp     = s.pot_lect_ant_fp,
      pot_reg_hp          = s.pot_reg_hp,
      pot_reg_fp          = s.pot_reg_fp,
      pot_gen_fact        = s.pot_gen_fact,
      pot_gen_pu          = s.pot_gen_pu,
      pot_gen_importe     = s.pot_gen_importe,
      pot_dist_fact       = s.pot_dist_fact,
      pot_dist_pu         = s.pot_dist_pu,
      pot_dist_importe    = s.pot_dist_importe,
      pot_bt6_pu          = s.pot_bt6_pu,
      pot_bt6_monto       = s.pot_bt6_monto,
      er_lec_act          = s.er_lec_act,
      er_lec_ant          = s.er_lec_ant,
      er_cons             = s.er_cons,
      er_fact             = s.er_fact,
      er_pu               = s.er_pu,
      er_importe          = s.er_importe,
      calif_cliente       = s.calif_cliente,
      dias_punta          = s.dias_punta,
      horas_punta         = s.horas_punta,
      factor_calif        = s.factor_calif,
      cargo_fijo          = s.cargo_fijo,
      mantenimiento       = s.mantenimiento,
      alumbrado           = s.alumbrado,
      recup_energia       = s.recup_energia,
      mora                = s.mora,
      reconexion          = s.reconexion,
      ajuste_tarifa       = s.ajuste_tarifa,
      dist_factura        = s.dist_factura,
      ajuste_alumb        = s.ajuste_alumb,
      otros_afectos       = s.otros_afectos,
      base_imponible      = s.base_imponible,
      igv                 = s.igv,
      tot_periodo         = s.tot_periodo,
      electrif_rural      = s.electrif_rural,
      comp_distribucion   = s.comp_distribucion,
      comp_generadora     = s.comp_generadora,
      comp_interrup       = s.comp_interrup,
      comp_calidad        = s.comp_calidad,
      comp_frec_ant       = s.comp_frec_ant,
      comp_frec_des       = s.comp_frec_des,
      comp_serv           = s.comp_serv,
      comp_norma_tec      = s.comp_norma_tec,
      comp_deuda_ant      = s.comp_deuda_ant,
      comp_deuda_meses    = s.comp_deuda_meses,
      comp_dev_reclamo    = s.comp_dev_reclamo,
      comp_nota_deb_cred  = s.comp_nota_deb_cred,
      comp_aporte_reemb   = s.comp_aporte_reemb,
      comp_otros_inafectos= s.comp_otros_inafectos,
      comp_redondeo_act_pos = s.comp_redondeo_act_pos,
      comp_redondeo_act_neg = s.comp_redondeo_act_neg,
      costo_medio         = s.costo_medio,
      total_a_pagar       = s.total_a_pagar,
      valor_venta         = s.valor_venta,
      deuda_anterior      = s.deuda_anterior,
      devolucion          = s.devolucion,
      fecha_liquidacion   = s.fecha_liquidacion
    FROM stg s
    WHERE t.num_recibo = s.num_recibo
      AND t.per_consumo = s.per_consumo
      AND ROW(
        t.cod_suministro, t.tarifa, t.pot_contr, t.titularidad, t.distribuidor,
        t.fec_emision, t.fec_vencimiento, t.fec_lect_actual, t.fec_lect_anterior, t.per_consumo,
        t.ea_lec_act_hp, t.ea_lec_act_fp, t.ea_lec_act_tot, t.ea_lec_ant_hp, t.ea_lec_ant_fp, t.ea_lec_ant_tot,
        t.ea_consumo_hp, t.ea_consumo_fp, t.ea_consumo_tot, t.ea_pu_hp, t.ea_pu_fp, t.ea_prec_unit_tot,
        t.ea_importe_hp, t.ea_importe_fp, t.ea_importe_tot,
        t.pot_lect_act_hp, t.pot_lect_act_fp, t.pot_lect_ant_hp, t.pot_lect_ant_fp,
        t.pot_reg_hp, t.pot_reg_fp, t.pot_gen_fact, t.pot_gen_pu, t.pot_gen_importe,
        t.pot_dist_fact, t.pot_dist_pu, t.pot_dist_importe, t.pot_bt6_pu, t.pot_bt6_monto,
        t.er_lec_act, t.er_lec_ant, t.er_cons, t.er_fact, t.er_pu, t.er_importe,
        t.calif_cliente, t.dias_punta, t.horas_punta, t.factor_calif,
        t.cargo_fijo, t.mantenimiento, t.alumbrado, t.recup_energia, t.mora, t.reconexion,
        t.ajuste_tarifa, t.dist_factura, t.ajuste_alumb, t.otros_afectos, t.base_imponible, t.igv, t.tot_periodo,
        t.electrif_rural, t.comp_distribucion, t.comp_generadora, t.comp_interrup, t.comp_calidad,
        t.comp_frec_ant, t.comp_frec_des, t.comp_serv, t.comp_norma_tec, t.comp_deuda_ant, t.comp_deuda_meses,
        t.comp_dev_reclamo, t.comp_nota_deb_cred, t.comp_aporte_reemb, t.comp_otros_inafectos,
        t.comp_redondeo_act_pos, t.comp_redondeo_act_neg,
        t.costo_medio, t.total_a_pagar, t.valor_venta, t.deuda_anterior, t.devolucion,
        t.fecha_liquidacion
      ) IS DISTINCT FROM ROW(
        s.cod_suministro, s.tarifa, s.pot_contr, s.titularidad, s.distribuidor,
        s.fec_emision, s.fec_vencimiento, s.fec_lect_actual, s.fec_lect_anterior, s.per_consumo,
        s.ea_lec_act_hp, s.ea_lec_act_fp, s.ea_lec_act_tot, s.ea_lec_ant_hp, s.ea_lec_ant_fp, s.ea_lec_ant_tot,
        s.ea_consumo_hp, s.ea_consumo_fp, s.ea_consumo_tot, s.ea_pu_hp, s.ea_pu_fp, s.ea_prec_unit_tot,
        s.ea_importe_hp, s.ea_importe_fp, s.ea_importe_tot,
        s.pot_lect_act_hp, s.pot_lect_act_fp, s.pot_lect_ant_hp, s.pot_lect_ant_fp,
        s.pot_reg_hp, s.pot_reg_fp, s.pot_gen_fact, s.pot_gen_pu, s.pot_gen_importe,
        s.pot_dist_fact, s.pot_dist_pu, s.pot_dist_importe, s.pot_bt6_pu, s.pot_bt6_monto,
        s.er_lec_act, s.er_lec_ant, s.er_cons, s.er_fact, s.er_pu, s.er_importe,
        s.calif_cliente, s.dias_punta, s.horas_punta, s.factor_calif,
        s.cargo_fijo, s.mantenimiento, s.alumbrado, s.recup_energia, s.mora, s.reconexion,
        s.ajuste_tarifa, s.dist_factura, s.ajuste_alumb, s.otros_afectos, s.base_imponible, s.igv, s.tot_periodo,
        s.electrif_rural, s.comp_distribucion, s.comp_generadora, s.comp_interrup, s.comp_calidad,
        s.comp_frec_ant, s.comp_frec_des, s.comp_serv, s.comp_norma_tec, s.comp_deuda_ant, s.comp_deuda_meses,
        s.comp_dev_reclamo, s.comp_nota_deb_cred, s.comp_aporte_reemb, s.comp_otros_inafectos,
        s.comp_redondeo_act_pos, s.comp_redondeo_act_neg,
        s.costo_medio, s.total_a_pagar, s.valor_venta, s.deuda_anterior, s.devolucion,
        s.fecha_liquidacion
      )
    RETURNING 1
  ),
  ins AS (
    INSERT INTO ods.sftp_hm_clientes_libres (
      num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
      fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
      ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
      ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
      ea_importe_hp, ea_importe_fp, ea_importe_tot,
      pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp,
      pot_reg_hp, pot_reg_fp, pot_gen_fact, pot_gen_pu, pot_gen_importe,
      pot_dist_fact, pot_dist_pu, pot_dist_importe, pot_bt6_pu, pot_bt6_monto,
      er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
      calif_cliente, dias_punta, horas_punta, factor_calif,
      cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion,
      ajuste_tarifa, dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
      electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
      comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
      comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
      comp_redondeo_act_pos, comp_redondeo_act_neg,
      costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
      -- OJO: no incluimos CREATION_*; se completan por DEFAULT de la tabla
    )
    SELECT
      s.num_recibo, s.cod_suministro, s.tarifa, s.pot_contr, s.titularidad, s.distribuidor,
      s.fec_emision, s.fec_vencimiento, s.fec_lect_actual, s.fec_lect_anterior, s.per_consumo,
      s.ea_lec_act_hp, s.ea_lec_act_fp, s.ea_lec_act_tot, s.ea_lec_ant_hp, s.ea_lec_ant_fp, s.ea_lec_ant_tot,
      s.ea_consumo_hp, s.ea_consumo_fp, s.ea_consumo_tot, s.ea_pu_hp, s.ea_pu_fp, s.ea_prec_unit_tot,
      s.ea_importe_hp, s.ea_importe_fp, s.ea_importe_tot,
      s.pot_lect_act_hp, s.pot_lect_act_fp, s.pot_lect_ant_hp, s.pot_lect_ant_fp,
      s.pot_reg_hp, s.pot_reg_fp, s.pot_gen_fact, s.pot_gen_pu, s.pot_gen_importe,
      s.pot_dist_fact, s.pot_dist_pu, s.pot_dist_importe, s.pot_bt6_pu, s.pot_bt6_monto,
      s.er_lec_act, s.er_lec_ant, s.er_cons, s.er_fact, s.er_pu, s.er_importe,
      s.calif_cliente, s.dias_punta, s.horas_punta, s.factor_calif,
      s.cargo_fijo, s.mantenimiento, s.alumbrado, s.recup_energia, s.mora, s.reconexion,
      s.ajuste_tarifa, s.dist_factura, s.ajuste_alumb, s.otros_afectos, s.base_imponible, s.igv, s.tot_periodo,
      s.electrif_rural, s.comp_distribucion, s.comp_generadora, s.comp_interrup, s.comp_calidad,
      s.comp_frec_ant, s.comp_frec_des, s.comp_serv, s.comp_norma_tec, s.comp_deuda_ant, s.comp_deuda_meses,
      s.comp_dev_reclamo, s.comp_nota_deb_cred, s.comp_aporte_reemb, s.comp_otros_inafectos,
      s.comp_redondeo_act_pos, s.comp_redondeo_act_neg,
      s.costo_medio, s.total_a_pagar, s.valor_venta, s.deuda_anterior, s.devolucion, s.fecha_liquidacion
    FROM stg s
    LEFT JOIN ods.sftp_hm_clientes_libres t
      ON t.num_recibo = s.num_recibo
     AND t.per_consumo = s.per_consumo
    WHERE t.num_recibo IS NULL
    RETURNING 1
  )
  SELECT
    COALESCE( (SELECT count(*) FROM ins), 0 ) AS inserted,
    COALESCE( (SELECT count(*) FROM upd), 0 ) AS updated
  INTO v_inserted, v_updated;

  v_estado := 'DONE';
  v_msj := format('UPSERT hm_clientes_libres (CTE): inserted=%s; updated=%s', v_inserted, v_updated);

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,
    p_deleted    => v_deleted,
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

-------------------

CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_consumo_suministro_da()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_sftp_hm_consumo_suministro_da()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_sftp_hm_consumo_suministro_da()'::regprocedure::text;
  v_inserted      integer      := 0;
  v_err_invalid   integer      := 0;
  v_err_dups_pair integer      := 0;  -- duplicados por (num_recibo, per_consumo)
  v_err_nulos_nr  integer      := 0;  -- num_recibo nulo/vacío/'nan'/'null'
  v_err_total     integer      := 0;
  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ========= 1) INVÁLIDOS: num_recibo sin dígitos DESPUÉS del guion ========= */
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  ),
  cand_invalid AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_DA r
    JOIN invalid i ON i.rid = r.ctid
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,  -- si error_energia.pot_contr es VARCHAR(255), puedes usar r.pot_contr::varchar(255); si es NUMERIC, usa public.try_numeric(r.pot_contr)
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_DA'
  FROM cand_invalid r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_DA'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_invalid = ROW_COUNT;

  -- Borro inválidos de RAW
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_DA r
  USING invalid i
  WHERE r.ctid = i.rid;

  /* ========= 1.b) NULOS / VACÍOS en num_recibo ========= */
  WITH nulos AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,  -- ver nota anterior según tipo en error_energia
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_DA'
  FROM nulos r
  LEFT JOIN public.error_energia e
         ON ( (e.num_recibo IS NULL AND r.num_recibo IS NULL) OR e.num_recibo = r.num_recibo )
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_DA'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.fecha_carga IS NULL;

  GET DIAGNOSTICS v_err_nulos_nr = ROW_COUNT;

  -- Borro NULOS/VACÍOS de RAW
  WITH rid_nulos AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_DA r
  USING rid_nulos x
  WHERE r.ctid = x.rid;

  /* ========= 1.c) DUPLICADOS EXACTOS por (num_recibo, per_consumo) ========= */
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_DA r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  cand_dups_pair AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_DA r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,  -- ver nota anterior según tipo en error_energia
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_DA'
  FROM cand_dups_pair r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_DA'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_dups_pair = ROW_COUNT;

  -- Borro duplicados por (num_recibo, per_consumo) de RAW
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_DA r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_DA r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  -- Total de errores del día
  v_err_total := COALESCE(v_err_invalid,0) + COALESCE(v_err_dups_pair,0) + COALESCE(v_err_nulos_nr,0);

  /* ========= 2) TRANSFORMACIÓN + DEDUP + CARGA A ODS ========= */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      CASE
        WHEN r.num_recibo IS NULL OR btrim(r.num_recibo) = '' OR lower(btrim(r.num_recibo)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.num_recibo), 250)
      END AS num_recibo,

      trunc(public.try_numeric(r.cod_suministro))::int AS cod_suministro,
      NULLIF(NULLIF(btrim(r.tarifa), 'NaN'), '')::varchar(10) AS tarifa,

      /* ==== pot_contr ahora VARCHAR(255) ==== */
      NULLIF(NULLIF(btrim(r.pot_contr), 'NaN'), '')::varchar(255) AS pot_contr,

      NULLIF(NULLIF(btrim(r.titularidad),  'NaN'), '')::varchar(255) AS titularidad,
      NULLIF(NULLIF(btrim(r.distribuidor), 'NaN'), '')::varchar(255) AS distribuidor,

      CASE
        WHEN r.fec_emision IS NULL OR btrim(r.fec_emision) = '' OR lower(btrim(r.fec_emision)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_emision) > 0 THEN to_date(split_part(r.fec_emision,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_emision,' ',1), 'YYYY-MM-DD')
      END AS fec_emision,
      CASE
        WHEN r.fec_vencimiento IS NULL OR btrim(r.fec_vencimiento) = '' OR lower(btrim(r.fec_vencimiento)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_vencimiento) > 0 THEN to_date(split_part(r.fec_vencimiento,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_vencimiento,' ',1), 'YYYY-MM-DD')
      END AS fec_vencimiento,
      CASE
        WHEN r.fec_lect_actual IS NULL OR btrim(r.fec_lect_actual) = '' OR lower(btrim(r.fec_lect_actual)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_actual) > 0 THEN to_date(split_part(r.fec_lect_actual,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_actual,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_actual,
      CASE
        WHEN r.fec_lect_anterior IS NULL OR btrim(r.fec_lect_anterior) = '' OR lower(btrim(r.fec_lect_anterior)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_anterior) > 0 THEN to_date(split_part(r.fec_lect_anterior,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_anterior,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_anterior,

      NULLIF(NULLIF(btrim(r.per_consumo), 'NaN'), '')::varchar(50) AS per_consumo,

      public.try_numeric(r.ea_lec_act_hp)::numeric(18,2)  AS ea_lec_act_hp,
      public.try_numeric(r.ea_lec_act_fp)::numeric(18,2)  AS ea_lec_act_fp,
      public.try_numeric(r.ea_lec_act_tot)::numeric(18,2) AS ea_lec_act_tot,
      public.try_numeric(r.ea_lec_ant_hp)::numeric(18,2)  AS ea_lec_ant_hp,
      public.try_numeric(r.ea_lec_ant_fp)::numeric(18,2)  AS ea_lec_ant_fp,
      public.try_numeric(r.ea_lec_ant_tot)::numeric(18,2) AS ea_lec_ant_tot,
      public.try_numeric(r.ea_consumo_hp)::numeric(18,2)  AS ea_consumo_hp,
      public.try_numeric(r.ea_consumo_fp)::numeric(18,2)  AS ea_consumo_fp,
      public.try_numeric(r.ea_consumo_tot)::numeric(18,2) AS ea_consumo_tot,

      public.try_numeric(r.ea_pu_hp)::numeric(18,6)       AS ea_pu_hp,
      public.try_numeric(r.ea_pu_fp)::numeric(18,6)       AS ea_pu_fp,
      public.try_numeric(r.ea_prec_unit_tot)::numeric(18,6) AS ea_prec_unit_tot,

      public.try_numeric(r.ea_importe_hp)::numeric(18,2)  AS ea_importe_hp,
      public.try_numeric(r.ea_importe_fp)::numeric(18,2)  AS ea_importe_fp,
      public.try_numeric(r.ea_importe_tot)::numeric(18,2) AS ea_importe_tot,

      public.try_numeric(r.pot_lect_act_hp)::numeric(18,2)   AS pot_lect_act_hp,
      public.try_numeric(r.pot_lect_act_fp)::numeric(18,2)   AS pot_lect_act_fp,
      public.try_numeric(r.pot_lect_ant_hp)::numeric(18,2)   AS pot_lect_ant_hp,
      public.try_numeric(r.pot_lect_ant_fp)::numeric(18,2)   AS pot_lect_ant_fp,
      public.try_numeric(r.pot_reg_hp)::numeric(18,2)        AS pot_reg_hp,
      public.try_numeric(r.pot_reg_fp)::numeric(18,2)        AS pot_reg_fp,
      public.try_numeric(r.pot_gen_fact)::numeric(18,2)      AS pot_gen_fact,
      public.try_numeric(r.pot_gen_pu)::numeric(18,6)        AS pot_gen_pu,
      public.try_numeric(r.pot_gen_importe)::numeric(18,2)   AS pot_gen_importe,
      public.try_numeric(r.pot_dist_fact)::numeric(18,2)     AS pot_dist_fact,
      public.try_numeric(r.pot_dist_pu)::numeric(18,6)       AS pot_dist_pu,
      public.try_numeric(r.pot_dist_importe)::numeric(18,2)  AS pot_dist_importe,
      public.try_numeric(r.pot_bt6_pu)::numeric(18,6)        AS pot_bt6_pu,
      public.try_numeric(r.pot_bt6_monto)::numeric(18,2)     AS pot_bt6_monto,

      public.try_numeric(r.er_lec_act)::numeric(18,2)     AS er_lec_act,
      public.try_numeric(r.er_lec_ant)::numeric(18,2)     AS er_lec_ant,
      public.try_numeric(r.er_cons)::numeric(18,2)        AS er_cons,
      public.try_numeric(r.er_fact)::numeric(18,2)        AS er_fact,
      public.try_numeric(r.er_pu)::numeric(18,6)          AS er_pu,
      public.try_numeric(r.er_importe)::numeric(18,2)     AS er_importe,

      NULLIF(NULLIF(btrim(r.calif_cliente), 'NaN'), '')::varchar(100) AS calif_cliente,

      trunc(public.try_numeric(r.dias_punta))::int        AS dias_punta,
      trunc(public.try_numeric(r.horas_punta))::int       AS horas_punta,

      NULLIF(NULLIF(btrim(r.factor_calif), 'NaN'), '')::varchar(50) AS factor_calif,

      public.try_numeric(r.cargo_fijo)::numeric(18,2)        AS cargo_fijo,
      public.try_numeric(r.mantenimiento)::numeric(18,2)     AS mantenimiento,
      public.try_numeric(r.alumbrado)::numeric(18,2)         AS alumbrado,
      public.try_numeric(r.recup_energia)::numeric(18,2)     AS recup_energia,
      public.try_numeric(r.mora)::numeric(18,2)              AS mora,
      public.try_numeric(r.reconexion)::numeric(18,2)        AS reconexion,
      public.try_numeric(r.ajuste_tarifa)::numeric(18,2)     AS ajuste_tarifa,
      public.try_numeric(r.dist_factura)::numeric(18,2)      AS dist_factura,
      public.try_numeric(r.ajuste_alumb)::numeric(18,2)      AS ajuste_alumb,
      public.try_numeric(r.otros_afectos)::numeric(18,2)     AS otros_afectos,
      public.try_numeric(r.base_imponible)::numeric(18,2)    AS base_imponible,
      public.try_numeric(r.igv)::numeric(18,2)               AS igv,
      public.try_numeric(r.tot_periodo)::numeric(18,2)       AS tot_periodo,
      public.try_numeric(r.electrif_rural)::numeric(18,2)    AS electrif_rural,
      public.try_numeric(r.comp_distribucion)::numeric(18,2) AS comp_distribucion,
      public.try_numeric(r.comp_generadora)::numeric(18,2)   AS comp_generadora,
      public.try_numeric(r.comp_interrup)::numeric(18,2)     AS comp_interrup,
      public.try_numeric(r.comp_calidad)::numeric(18,2)      AS comp_calidad,
      public.try_numeric(r.comp_frec_ant)::numeric(18,2)     AS comp_frec_ant,
      public.try_numeric(r.comp_frec_des)::numeric(18,2)     AS comp_frec_des,
      public.try_numeric(r.comp_serv)::numeric(18,2)         AS comp_serv,
      public.try_numeric(r.comp_norma_tec)::numeric(18,2)    AS comp_norma_tec,
      public.try_numeric(r.comp_deuda_ant)::numeric(18,2)    AS comp_deuda_ant,

      trunc(public.try_numeric(r.comp_deuda_meses))::int     AS comp_deuda_meses,

      public.try_numeric(r.comp_dev_reclamo)::numeric(18,2)  AS comp_dev_reclamo,
      public.try_numeric(r.comp_nota_deb_cred)::numeric(18,2) AS comp_nota_deb_cred,
      public.try_numeric(r.comp_aporte_reemb)::numeric(18,2) AS comp_aporte_reemb,
      public.try_numeric(r.comp_otros_inafectos)::numeric(18,2) AS comp_otros_inafectos,
      public.try_numeric(r.comp_redondeo_act_pos)::numeric(18,2) AS comp_redondeo_act_pos,
      public.try_numeric(r.comp_redondeo_act_neg)::numeric(18,2) AS comp_redondeo_act_neg,

      public.try_numeric(r.costo_medio)::numeric(18,2)       AS costo_medio,
      public.try_numeric(r.total_a_pagar)::numeric(18,2)     AS total_a_pagar,
      public.try_numeric(r.valor_venta)::numeric(18,2)       AS valor_venta,
      public.try_numeric(r.deuda_anterior)::numeric(18,2)    AS deuda_anterior,
      public.try_numeric(r.devolucion)::numeric(18,2)        AS devolucion,

      CASE
        WHEN r.fecha_liquidacion IS NULL OR btrim(r.fecha_liquidacion) = '' OR lower(btrim(r.fecha_liquidacion)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_liquidacion) > 0 THEN to_date(split_part(r.fecha_liquidacion,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_liquidacion,' ',1), 'YYYY-MM-DD')
      END AS fecha_liquidacion
    FROM raw.sftp_mm_consumo_suministro_DA r
  ),
  dedup AS (
    SELECT DISTINCT ON (num_recibo) *
    FROM base
    WHERE num_recibo IS NOT NULL
    ORDER BY num_recibo, rid
  )
  INSERT INTO ods.sftp_hm_consumo_suministro (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
  )
  SELECT
    d.num_recibo, d.cod_suministro, d.tarifa, d.pot_contr, d.titularidad, d.distribuidor,
    d.fec_emision, d.fec_vencimiento, d.fec_lect_actual, d.fec_lect_anterior, d.per_consumo,
    d.ea_lec_act_hp, d.ea_lec_act_fp, d.ea_lec_act_tot, d.ea_lec_ant_hp, d.ea_lec_ant_fp, d.ea_lec_ant_tot,
    d.ea_consumo_hp, d.ea_consumo_fp, d.ea_consumo_tot, d.ea_pu_hp, d.ea_pu_fp, d.ea_prec_unit_tot,
    d.ea_importe_hp, d.ea_importe_fp, d.ea_importe_tot,
    d.pot_lect_act_hp, d.pot_lect_act_fp, d.pot_lect_ant_hp, d.pot_lect_ant_fp, d.pot_reg_hp, d.pot_reg_fp,
    d.pot_gen_fact, d.pot_gen_pu, d.pot_gen_importe, d.pot_dist_fact, d.pot_dist_pu, d.pot_dist_importe,
    d.pot_bt6_pu, d.pot_bt6_monto,
    d.er_lec_act, d.er_lec_ant, d.er_cons, d.er_fact, d.er_pu, d.er_importe,
    d.calif_cliente, d.dias_punta, d.horas_punta, d.factor_calif,
    d.cargo_fijo, d.mantenimiento, d.alumbrado, d.recup_energia, d.mora, d.reconexion, d.ajuste_tarifa,
    d.dist_factura, d.ajuste_alumb, d.otros_afectos, d.base_imponible, d.igv, d.tot_periodo,
    d.electrif_rural, d.comp_distribucion, d.comp_generadora, d.comp_interrup, d.comp_calidad,
    d.comp_frec_ant, d.comp_frec_des, d.comp_serv, d.comp_norma_tec, d.comp_deuda_ant, d.comp_deuda_meses,
    d.comp_dev_reclamo, d.comp_nota_deb_cred, d.comp_aporte_reemb, d.comp_otros_inafectos,
    d.comp_redondeo_act_pos, d.comp_redondeo_act_neg,
    d.costo_medio, d.total_a_pagar, d.valor_venta, d.deuda_anterior, d.devolucion, d.fecha_liquidacion
  FROM dedup d
  LEFT JOIN ods.sftp_hm_consumo_suministro o
    ON o.num_recibo = d.num_recibo
  WHERE o.num_recibo IS NULL;

  GET DIAGNOSTICS v_inserted = ROW_COUNT;

  v_estado := 'DONE';
  v_msj    := format(
    'Insertados en ODS: %s | Enviados NUEVOS a public.error_energia (hoy): %s (inválidos: %s, duplicados num_recibo+per_consumo: %s, num_recibo nulo/vacío: %s) | Origen: raw.sftp_mm_consumo_suministro_DA.',
    v_inserted, COALESCE(v_err_total,0), COALESCE(v_err_invalid,0), COALESCE(v_err_dups_pair,0), COALESCE(v_err_nulos_nr,0)
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => NULL::integer,
    p_deleted    => NULL::integer,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj    := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;


-----------------------



CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_consumo_suministro_pd()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_sftp_hm_consumo_suministro_pd()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_sftp_hm_consumo_suministro_pd()'::regprocedure::text;
  v_inserted      integer      := 0;
  v_err_invalid   integer      := 0;
  v_err_dups_pair integer      := 0;  -- duplicados por (num_recibo, per_consumo)
  v_err_nulos_nr  integer      := 0;  -- num_recibo nulo/vacío/'nan'/'null'
  v_err_total     integer      := 0;
  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ========= 1) INVÁLIDOS: num_recibo sin dígitos DESPUÉS del guion ========= */
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  ),
  cand_invalid AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_pd r
    JOIN invalid i ON i.rid = r.ctid
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,  -- si error_energia.pot_contr es NUMERIC, cambiar por public.try_numeric(r.pot_contr)
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_pd'
  FROM cand_invalid r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_invalid = ROW_COUNT;

  -- Borro inválidos de RAW
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_pd r
  USING invalid i
  WHERE r.ctid = i.rid;

  /* ========= 1.b) NULOS / VACÍOS en num_recibo ========= */
  WITH nulos AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,  -- si error_energia.pot_contr es NUMERIC, cambiar por public.try_numeric(r.pot_contr)
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_pd'
  FROM nulos r
  LEFT JOIN public.error_energia e
         ON ( (e.num_recibo IS NULL AND r.num_recibo IS NULL) OR e.num_recibo = r.num_recibo )
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.fecha_carga IS NULL;

  GET DIAGNOSTICS v_err_nulos_nr = ROW_COUNT;

  -- Borro NULOS/VACÍOS de RAW
  WITH rid_nulos AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_pd r
  USING rid_nulos x
  WHERE r.ctid = x.rid;

  /* ========= 1.c) DUPLICADOS EXACTOS por (num_recibo, per_consumo) ========= */
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_pd r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  cand_dups_pair AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_pd r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,  -- si error_energia.pot_contr es NUMERIC, cambiar por public.try_numeric(r.pot_contr)
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_pd'
  FROM cand_dups_pair r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_dups_pair = ROW_COUNT;

  -- Borro duplicados por (num_recibo, per_consumo) de RAW
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_pd r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_pd r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  -- Total de errores del día
  v_err_total := COALESCE(v_err_invalid,0) + COALESCE(v_err_dups_pair,0) + COALESCE(v_err_nulos_nr,0);

  /* ========= 2) TRANSFORMACIÓN + DEDUP + CARGA A ODS ========= */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      CASE
        WHEN r.num_recibo IS NULL OR btrim(r.num_recibo) = '' OR lower(btrim(r.num_recibo)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.num_recibo), 250)
      END AS num_recibo,

      trunc(public.try_numeric(r.cod_suministro))::int AS cod_suministro,
      NULLIF(NULLIF(btrim(r.tarifa), 'NaN'), '')::varchar(10) AS tarifa,

      /* ==== pot_contr ahora VARCHAR(255) ==== */
      NULLIF(NULLIF(btrim(r.pot_contr), 'NaN'), '')::varchar(255) AS pot_contr,

      NULLIF(NULLIF(btrim(r.titularidad),  'NaN'), '')::varchar(255) AS titularidad,
      NULLIF(NULLIF(btrim(r.distribuidor), 'NaN'), '')::varchar(255) AS distribuidor,

      CASE
        WHEN r.fec_emision IS NULL OR btrim(r.fec_emision) = '' OR lower(btrim(r.fec_emision)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_emision) > 0 THEN to_date(split_part(r.fec_emision,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_emision,' ',1), 'YYYY-MM-DD')
      END AS fec_emision,
      CASE
        WHEN r.fec_vencimiento IS NULL OR btrim(r.fec_vencimiento) = '' OR lower(btrim(r.fec_vencimiento)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_vencimiento) > 0 THEN to_date(split_part(r.fec_vencimiento,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_vencimiento,' ',1), 'YYYY-MM-DD')
      END AS fec_vencimiento,
      CASE
        WHEN r.fec_lect_actual IS NULL OR btrim(r.fec_lect_actual) = '' OR lower(btrim(r.fec_lect_actual)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_actual) > 0 THEN to_date(split_part(r.fec_lect_actual,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_actual,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_actual,
      CASE
        WHEN r.fec_lect_anterior IS NULL OR btrim(r.fec_lect_anterior) = '' OR lower(btrim(r.fec_lect_anterior)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_anterior) > 0 THEN to_date(split_part(r.fec_lect_anterior,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_anterior,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_anterior,

      NULLIF(NULLIF(btrim(r.per_consumo), 'NaN'), '')::varchar(50) AS per_consumo,

      public.try_numeric(r.ea_lec_act_hp)::numeric(18,2)  AS ea_lec_act_hp,
      public.try_numeric(r.ea_lec_act_fp)::numeric(18,2)  AS ea_lec_act_fp,
      public.try_numeric(r.ea_lec_act_tot)::numeric(18,2) AS ea_lec_act_tot,
      public.try_numeric(r.ea_lec_ant_hp)::numeric(18,2)  AS ea_lec_ant_hp,
      public.try_numeric(r.ea_lec_ant_fp)::numeric(18,2)  AS ea_lec_ant_fp,
      public.try_numeric(r.ea_lec_ant_tot)::numeric(18,2) AS ea_lec_ant_tot,
      public.try_numeric(r.ea_consumo_hp)::numeric(18,2)  AS ea_consumo_hp,
      public.try_numeric(r.ea_consumo_fp)::numeric(18,2)  AS ea_consumo_fp,
      public.try_numeric(r.ea_consumo_tot)::numeric(18,2) AS ea_consumo_tot,

      public.try_numeric(r.ea_pu_hp)::numeric(18,6)       AS ea_pu_hp,
      public.try_numeric(r.ea_pu_fp)::numeric(18,6)       AS ea_pu_fp,
      public.try_numeric(r.ea_prec_unit_tot)::numeric(18,6) AS ea_prec_unit_tot,

      public.try_numeric(r.ea_importe_hp)::numeric(18,2)  AS ea_importe_hp,
      public.try_numeric(r.ea_importe_fp)::numeric(18,2)  AS ea_importe_fp,
      public.try_numeric(r.ea_importe_tot)::numeric(18,2) AS ea_importe_tot,

      public.try_numeric(r.pot_lect_act_hp)::numeric(18,2)   AS pot_lect_act_hp,
      public.try_numeric(r.pot_lect_act_fp)::numeric(18,2)   AS pot_lect_act_fp,
      public.try_numeric(r.pot_lect_ant_hp)::numeric(18,2)   AS pot_lect_ant_hp,
      public.try_numeric(r.pot_lect_ant_fp)::numeric(18,2)   AS pot_lect_ant_fp,
      public.try_numeric(r.pot_reg_hp)::numeric(18,2)        AS pot_reg_hp,
      public.try_numeric(r.pot_reg_fp)::numeric(18,2)        AS pot_reg_fp,
      public.try_numeric(r.pot_gen_fact)::numeric(18,2)      AS pot_gen_fact,
      public.try_numeric(r.pot_gen_pu)::numeric(18,6)        AS pot_gen_pu,
      public.try_numeric(r.pot_gen_importe)::numeric(18,2)   AS pot_gen_importe,
      public.try_numeric(r.pot_dist_fact)::numeric(18,2)     AS pot_dist_fact,
      public.try_numeric(r.pot_dist_pu)::numeric(18,6)       AS pot_dist_pu,
      public.try_numeric(r.pot_dist_importe)::numeric(18,2)  AS pot_dist_importe,
      public.try_numeric(r.pot_bt6_pu)::numeric(18,6)        AS pot_bt6_pu,
      public.try_numeric(r.pot_bt6_monto)::numeric(18,2)     AS pot_bt6_monto,

      public.try_numeric(r.er_lec_act)::numeric(18,2)     AS er_lec_act,
      public.try_numeric(r.er_lec_ant)::numeric(18,2)     AS er_lec_ant,
      public.try_numeric(r.er_cons)::numeric(18,2)        AS er_cons,
      public.try_numeric(r.er_fact)::numeric(18,2)        AS er_fact,
      public.try_numeric(r.er_pu)::numeric(18,6)          AS er_pu,
      public.try_numeric(r.er_importe)::numeric(18,2)     AS er_importe,

      NULLIF(NULLIF(btrim(r.calif_cliente), 'NaN'), '')::varchar(100) AS calif_cliente,

      trunc(public.try_numeric(r.dias_punta))::int        AS dias_punta,
      trunc(public.try_numeric(r.horas_punta))::int       AS horas_punta,

      NULLIF(NULLIF(btrim(r.factor_calif), 'NaN'), '')::varchar(50) AS factor_calif,

      public.try_numeric(r.cargo_fijo)::numeric(18,2)        AS cargo_fijo,
      public.try_numeric(r.mantenimiento)::numeric(18,2)     AS mantenimiento,
      public.try_numeric(r.alumbrado)::numeric(18,2)         AS alumbrado,
      public.try_numeric(r.recup_energia)::numeric(18,2)     AS recup_energia,
      public.try_numeric(r.mora)::numeric(18,2)              AS mora,
      public.try_numeric(r.reconexion)::numeric(18,2)        AS reconexion,
      public.try_numeric(r.ajuste_tarifa)::numeric(18,2)     AS ajuste_tarifa,
      public.try_numeric(r.dist_factura)::numeric(18,2)      AS dist_factura,
      public.try_numeric(r.ajuste_alumb)::numeric(18,2)      AS ajuste_alumb,
      public.try_numeric(r.otros_afectos)::numeric(18,2)     AS otros_afectos,
      public.try_numeric(r.base_imponible)::numeric(18,2)    AS base_imponible,
      public.try_numeric(r.igv)::numeric(18,2)               AS igv,
      public.try_numeric(r.tot_periodo)::numeric(18,2)       AS tot_periodo,
      public.try_numeric(r.electrif_rural)::numeric(18,2)    AS electrif_rural,
      public.try_numeric(r.comp_distribucion)::numeric(18,2) AS comp_distribucion,
      public.try_numeric(r.comp_generadora)::numeric(18,2)   AS comp_generadora,
      public.try_numeric(r.comp_interrup)::numeric(18,2)     AS comp_interrup,
      public.try_numeric(r.comp_calidad)::numeric(18,2)      AS comp_calidad,
      public.try_numeric(r.comp_frec_ant)::numeric(18,2)     AS comp_frec_ant,
      public.try_numeric(r.comp_frec_des)::numeric(18,2)     AS comp_frec_des,
      public.try_numeric(r.comp_serv)::numeric(18,2)         AS comp_serv,
      public.try_numeric(r.comp_norma_tec)::numeric(18,2)    AS comp_norma_tec,
      public.try_numeric(r.comp_deuda_ant)::numeric(18,2)    AS comp_deuda_ant,

      trunc(public.try_numeric(r.comp_deuda_meses))::int     AS comp_deuda_meses,

      public.try_numeric(r.comp_dev_reclamo)::numeric(18,2)  AS comp_dev_reclamo,
      public.try_numeric(r.comp_nota_deb_cred)::numeric(18,2) AS comp_nota_deb_cred,
      public.try_numeric(r.comp_aporte_reemb)::numeric(18,2) AS comp_aporte_reemb,
      public.try_numeric(r.comp_otros_inafectos)::numeric(18,2) AS comp_otros_inafectos,
      public.try_numeric(r.comp_redondeo_act_pos)::numeric(18,2) AS comp_redondeo_act_pos,
      public.try_numeric(r.comp_redondeo_act_neg)::numeric(18,2) AS comp_redondeo_act_neg,

      public.try_numeric(r.costo_medio)::numeric(18,2)       AS costo_medio,
      public.try_numeric(r.total_a_pagar)::numeric(18,2)     AS total_a_pagar,
      public.try_numeric(r.valor_venta)::numeric(18,2)       AS valor_venta,
      public.try_numeric(r.deuda_anterior)::numeric(18,2)    AS deuda_anterior,
      public.try_numeric(r.devolucion)::numeric(18,2)        AS devolucion,

      CASE
        WHEN r.fecha_liquidacion IS NULL OR btrim(r.fecha_liquidacion) = '' OR lower(btrim(r.fecha_liquidacion)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_liquidacion) > 0 THEN to_date(split_part(r.fecha_liquidacion,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_liquidacion,' ',1), 'YYYY-MM-DD')
      END AS fecha_liquidacion
    FROM raw.sftp_mm_consumo_suministro_pd r
  ),
  dedup AS (
    -- PK ODS: num_recibo (conserva primera aparición)
    SELECT DISTINCT ON (num_recibo) *
    FROM base
    WHERE num_recibo IS NOT NULL
    ORDER BY num_recibo, rid
  )
  INSERT INTO ods.sftp_hm_consumo_suministro (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
  )
  SELECT
    d.num_recibo, d.cod_suministro, d.tarifa, d.pot_contr, d.titularidad, d.distribuidor,
    d.fec_emision, d.fec_vencimiento, d.fec_lect_actual, d.fec_lect_anterior, d.per_consumo,
    d.ea_lec_act_hp, d.ea_lec_act_fp, d.ea_lec_act_tot, d.ea_lec_ant_hp, d.ea_lec_ant_fp, d.ea_lec_ant_tot,
    d.ea_consumo_hp, d.ea_consumo_fp, d.ea_consumo_tot, d.ea_pu_hp, d.ea_pu_fp, d.ea_prec_unit_tot,
    d.ea_importe_hp, d.ea_importe_fp, d.ea_importe_tot,
    d.pot_lect_act_hp, d.pot_lect_act_fp, d.pot_lect_ant_hp, d.pot_lect_ant_fp, d.pot_reg_hp, d.pot_reg_fp,
    d.pot_gen_fact, d.pot_gen_pu, d.pot_gen_importe, d.pot_dist_fact, d.pot_dist_pu, d.pot_dist_importe,
    d.pot_bt6_pu, d.pot_bt6_monto,
    d.er_lec_act, d.er_lec_ant, d.er_cons, d.er_fact, d.er_pu, d.er_importe,
    d.calif_cliente, d.dias_punta, d.horas_punta, d.factor_calif,
    d.cargo_fijo, d.mantenimiento, d.alumbrado, d.recup_energia, d.mora, d.reconexion, d.ajuste_tarifa,
    d.dist_factura, d.ajuste_alumb, d.otros_afectos, d.base_imponible, d.igv, d.tot_periodo,
    d.electrif_rural, d.comp_distribucion, d.comp_generadora, d.comp_interrup, d.comp_calidad,
    d.comp_frec_ant, d.comp_frec_des, d.comp_serv, d.comp_norma_tec, d.comp_deuda_ant, d.comp_deuda_meses,
    d.comp_dev_reclamo, d.comp_nota_deb_cred, d.comp_aporte_reemb, d.comp_otros_inafectos,
    d.comp_redondeo_act_pos, d.comp_redondeo_act_neg,
    d.costo_medio, d.total_a_pagar, d.valor_venta, d.deuda_anterior, d.devolucion, d.fecha_liquidacion
  FROM dedup d
  LEFT JOIN ods.sftp_hm_consumo_suministro o
    ON o.num_recibo = d.num_recibo
  WHERE o.num_recibo IS NULL;

  GET DIAGNOSTICS v_inserted = ROW_COUNT;

  v_estado := 'DONE';
  v_msj    := format(
    'Insertados en ODS: %s | Enviados NUEVOS a public.error_energia (hoy): %s (inválidos: %s, duplicados num_recibo+per_consumo: %s, num_recibo nulo/vacío: %s) | Origen: raw.sftp_mm_consumo_suministro_pd.',
    v_inserted, COALESCE(v_err_total,0), COALESCE(v_err_invalid,0), COALESCE(v_err_dups_pair,0), COALESCE(v_err_nulos_nr,0)
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => NULL::integer,
    p_deleted    => NULL::integer,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj    := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  := v_msj,
      p_sp         := v_sp_name
    );
    RAISE;
END;
$procedure$
;

-------------------


CREATE OR REPLACE PROCEDURE ods.sp_cargar_web_hm_indra_energia()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_web_hm_indra_energia()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_web_hm_indra_energia()'::regprocedure::text;

  v_ins_err_dup   integer := 0;  -- duplicados insertados a error_energia
  v_del_dup_raw   integer := 0;  -- duplicados borrados de RAW
  v_inserted_ods  integer := 0;  -- insertados en ODS

  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ===================== 1) DUPLICADOS (num_recibo, per_consumo) ===================== */
  WITH claves_dup AS (
    SELECT num_recibo, per_consumo
    FROM raw.web_mm_indra_energia
    GROUP BY num_recibo, per_consumo
    HAVING COUNT(*) > 1
  ),
  cand_dups AS (
    SELECT r.*
    FROM raw.web_mm_indra_energia r
    JOIN claves_dup d
      ON d.num_recibo = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,                       -- << si error_energia.pot_contr es NUMERIC, puedes usar public.try_numeric(r.pot_contr)
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.web_mm_indra_energia'
  FROM cand_dups r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.web_mm_indra_energia'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_ins_err_dup = ROW_COUNT;

  WITH claves_dup AS (
    SELECT num_recibo, per_consumo
    FROM raw.web_mm_indra_energia
    GROUP BY num_recibo, per_consumo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.web_mm_indra_energia r
    JOIN claves_dup d
      ON d.num_recibo = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  DELETE FROM raw.web_mm_indra_energia r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  GET DIAGNOSTICS v_del_dup_raw = ROW_COUNT;

  /* ===================== 2) TRANSFORMACIÓN + CARGA A ODS ===================== */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      -- num_recibo limpio
      CASE
        WHEN r.num_recibo IS NULL OR btrim(r.num_recibo) = '' OR lower(btrim(r.num_recibo)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.num_recibo), 250)
      END AS num_recibo,

      -- cod_suministro como TEXTO (varchar 250)
      NULLIF(NULLIF(btrim(r.cod_suministro), 'NaN'), '')::varchar(250) AS cod_suministro,

      NULLIF(NULLIF(btrim(r.tarifa), 'NaN'), '')::varchar(10)  AS tarifa,

      /* ==== pot_contr ahora VARCHAR(255) ==== */
      NULLIF(NULLIF(btrim(r.pot_contr), 'NaN'), '')::varchar(255) AS pot_contr,
      -- Variante con limpieza de símbolos (opcional):
      -- CASE
      --   WHEN r.pot_contr IS NULL OR btrim(r.pot_contr) = '' OR lower(btrim(r.pot_contr)) IN ('nan','null')
      --     THEN NULL
      --   ELSE left(regexp_replace(btrim(r.pot_contr), '[^\d\.\,\-\w ]', '', 'g'), 255)
      -- END::varchar(255) AS pot_contr,

      NULLIF(NULLIF(btrim(r.titularidad),  'NaN'), '')::varchar(255) AS titularidad,
      NULLIF(NULLIF(btrim(r.distribuidor), 'NaN'), '')::varchar(255) AS distribuidor,

      /* ==== FECHAS robustas ==== */
      -- fec_emision
      CASE
        WHEN r.fec_emision IS NULL OR btrim(r.fec_emision) = '' OR lower(btrim(r.fec_emision)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_emision,

      -- fec_vencimiento
      CASE
        WHEN r.fec_vencimiento IS NULL OR btrim(r.fec_vencimiento) = '' OR lower(btrim(r.fec_vencimiento)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_vencimiento,

      -- fec_lect_actual
      CASE
        WHEN r.fec_lect_actual IS NULL OR btrim(r.fec_lect_actual) = '' OR lower(btrim(r.fec_lect_actual)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_lect_actual,

      -- fec_lect_anterior
      CASE
        WHEN r.fec_lect_anterior IS NULL OR btrim(r.fec_lect_anterior) = '' OR lower(btrim(r.fec_lect_anterior)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_lect_anterior,

      NULLIF(NULLIF(btrim(r.per_consumo), 'NaN'), '')::varchar(50) AS per_consumo,

      public.try_numeric(r.ea_lec_act_hp)::numeric(18,2)  AS ea_lec_act_hp,
      public.try_numeric(r.ea_lec_act_fp)::numeric(18,2)  AS ea_lec_act_fp,
      public.try_numeric(r.ea_lec_act_tot)::numeric(18,2) AS ea_lec_act_tot,
      public.try_numeric(r.ea_lec_ant_hp)::numeric(18,2)  AS ea_lec_ant_hp,
      public.try_numeric(r.ea_lec_ant_fp)::numeric(18,2)  AS ea_lec_ant_fp,
      public.try_numeric(r.ea_lec_ant_tot)::numeric(18,2) AS ea_lec_ant_tot,

      public.try_numeric(r.ea_consumo_hp)::numeric(18,2)  AS ea_consumo_hp,
      public.try_numeric(r.ea_consumo_fp)::numeric(18,2)  AS ea_consumo_fp,
      public.try_numeric(r.ea_consumo_tot)::numeric(18,2) AS ea_consumo_tot,

      public.try_numeric(r.ea_pu_hp)::numeric(18,6)       AS ea_pu_hp,
      public.try_numeric(r.ea_pu_fp)::numeric(18,6)       AS ea_pu_fp,
      public.try_numeric(r.ea_prec_unit_tot)::numeric(18,6) AS ea_prec_unit_tot,

      public.try_numeric(r.ea_importe_hp)::numeric(18,2)  AS ea_importe_hp,
      public.try_numeric(r.ea_importe_fp)::numeric(18,2)  AS ea_importe_fp,
      public.try_numeric(r.ea_importe_tot)::numeric(18,2) AS ea_importe_tot,

      public.try_numeric(r.pot_lect_act_hp)::numeric(18,2)   AS pot_lect_act_hp,
      public.try_numeric(r.pot_lect_act_fp)::numeric(18,2)   AS pot_lect_act_fp,
      public.try_numeric(r.pot_lect_ant_hp)::numeric(18,2)   AS pot_lect_ant_hp,
      public.try_numeric(r.pot_lect_ant_fp)::numeric(18,2)   AS pot_lect_ant_fp,
      public.try_numeric(r.pot_reg_hp)::numeric(18,2)        AS pot_reg_hp,
      public.try_numeric(r.pot_reg_fp)::numeric(18,2)        AS pot_reg_fp,
      public.try_numeric(r.pot_gen_fact)::numeric(18,2)      AS pot_gen_fact,
      public.try_numeric(r.pot_gen_pu)::numeric(18,6)        AS pot_gen_pu,
      public.try_numeric(r.pot_gen_importe)::numeric(18,2)   AS pot_gen_importe,
      public.try_numeric(r.pot_dist_fact)::numeric(18,2)     AS pot_dist_fact,
      public.try_numeric(r.pot_dist_pu)::numeric(18,6)       AS pot_dist_pu,
      public.try_numeric(r.pot_dist_importe)::numeric(18,2)  AS pot_dist_importe,
      public.try_numeric(r.pot_bt6_pu)::numeric(18,6)        AS pot_bt6_pu,
      public.try_numeric(r.pot_bt6_monto)::numeric(18,2)     AS pot_bt6_monto,

      public.try_numeric(r.er_lec_act)::numeric(18,2)     AS er_lec_act,
      public.try_numeric(r.er_lec_ant)::numeric(18,2)     AS er_lec_ant,
      public.try_numeric(r.er_cons)::numeric(18,2)        AS er_cons,
      public.try_numeric(r.er_fact)::numeric(18,2)        AS er_fact,
      public.try_numeric(r.er_pu)::numeric(18,6)          AS er_pu,
      public.try_numeric(r.er_importe)::numeric(18,2)     AS er_importe,

      NULLIF(NULLIF(btrim(r.calif_cliente), 'NaN'), '')::varchar(100) AS calif_cliente,
      trunc(public.try_numeric(r.dias_punta))::int        AS dias_punta,
      trunc(public.try_numeric(r.horas_punta))::int       AS horas_punta,
      NULLIF(NULLIF(btrim(r.factor_calif), 'NaN'), '')::varchar(50) AS factor_calif,

      public.try_numeric(r.cargo_fijo)::numeric(18,2)        AS cargo_fijo,
      public.try_numeric(r.mantenimiento)::numeric(18,2)     AS mantenimiento,
      public.try_numeric(r.alumbrado)::numeric(18,2)         AS alumbrado,
      public.try_numeric(r.recup_energia)::numeric(18,2)     AS recup_energia,
      public.try_numeric(r.mora)::numeric(18,2)              AS mora,
      public.try_numeric(r.reconexion)::numeric(18,2)        AS reconexion,
      public.try_numeric(r.ajuste_tarifa)::numeric(18,2)     AS ajuste_tarifa,
      public.try_numeric(r.dist_factura)::numeric(18,2)      AS dist_factura,
      public.try_numeric(r.ajuste_alumb)::numeric(18,2)      AS ajuste_alumb,
      public.try_numeric(r.otros_afectos)::numeric(18,2)     AS otros_afectos,
      public.try_numeric(r.base_imponible)::numeric(18,2)    AS base_imponible,
      public.try_numeric(r.igv)::numeric(18,2)               AS igv,
      public.try_numeric(r.tot_periodo)::numeric(18,2)       AS tot_periodo,

      public.try_numeric(r.electrif_rural)::numeric(18,2)    AS electrif_rural,
      public.try_numeric(r.comp_distribucion)::numeric(18,2) AS comp_distribucion,
      public.try_numeric(r.comp_generadora)::numeric(18,2)   AS comp_generadora,
      public.try_numeric(r.comp_interrup)::numeric(18,2)     AS comp_interrup,
      public.try_numeric(r.comp_calidad)::numeric(18,2)      AS comp_calidad,
      public.try_numeric(r.comp_frec_ant)::numeric(18,2)     AS comp_frec_ant,
      public.try_numeric(r.comp_frec_des)::numeric(18,2)     AS comp_frec_des,
      public.try_numeric(r.comp_serv)::numeric(18,2)         AS comp_serv,
      public.try_numeric(r.comp_norma_tec)::numeric(18,2)    AS comp_norma_tec,
      public.try_numeric(r.comp_deuda_ant)::numeric(18,2)    AS comp_deuda_ant,
      trunc(public.try_numeric(r.comp_deuda_meses))::int     AS comp_deuda_meses,

      public.try_numeric(r.comp_dev_reclamo)::numeric(18,2)  AS comp_dev_reclamo,
      public.try_numeric(r.comp_nota_deb_cred)::numeric(18,2) AS comp_nota_deb_cred,
      public.try_numeric(r.comp_aporte_reemb)::numeric(18,2) AS comp_aporte_reemb,
      public.try_numeric(r.comp_otros_inafectos)::numeric(18,2) AS comp_otros_inafectos,
      public.try_numeric(r.comp_redondeo_act_pos)::numeric(18,2) AS comp_redondeo_act_pos,
      public.try_numeric(r.comp_redondeo_act_neg)::numeric(18,2) AS comp_redondeo_act_neg,

      public.try_numeric(r.costo_medio)::numeric(18,2)       AS costo_medio,
      public.try_numeric(r.total_a_pagar)::numeric(18,2)     AS total_a_pagar,
      public.try_numeric(r.valor_venta)::numeric(18,2)       AS valor_venta,
      public.try_numeric(r.deuda_anterior)::numeric(18,2)    AS deuda_anterior,
      public.try_numeric(r.devolucion)::numeric(18,2)        AS devolucion,

      -- fecha_liquidacion
      CASE
        WHEN r.fecha_liquidacion IS NULL OR btrim(r.fecha_liquidacion) = '' OR lower(btrim(r.fecha_liquidacion)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fecha_liquidacion
    FROM raw.web_mm_indra_energia r
  ),
  dedup AS (
    SELECT DISTINCT ON (num_recibo) *
    FROM base
    WHERE num_recibo IS NOT NULL
    ORDER BY num_recibo, rid
  )
  INSERT INTO ods.web_hm_indra_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
  )
  SELECT
    d.num_recibo, d.cod_suministro, d.tarifa, d.pot_contr, d.titularidad, d.distribuidor,
    d.fec_emision, d.fec_vencimiento, d.fec_lect_actual, d.fec_lect_anterior, d.per_consumo,
    d.ea_lec_act_hp, d.ea_lec_act_fp, d.ea_lec_act_tot, d.ea_lec_ant_hp, d.ea_lec_ant_fp, d.ea_lec_ant_tot,
    d.ea_consumo_hp, d.ea_consumo_fp, d.ea_consumo_tot, d.ea_pu_hp, d.ea_pu_fp, d.ea_prec_unit_tot,
    d.ea_importe_hp, d.ea_importe_fp, d.ea_importe_tot,
    d.pot_lect_act_hp, d.pot_lect_act_fp, d.pot_lect_ant_hp, d.pot_lect_ant_fp, d.pot_reg_hp, d.pot_reg_fp,
    d.pot_gen_fact, d.pot_gen_pu, d.pot_gen_importe, d.pot_dist_fact, d.pot_dist_pu, d.pot_dist_importe,
    d.pot_bt6_pu, d.pot_bt6_monto,
    d.er_lec_act, d.er_lec_ant, d.er_cons, d.er_fact, d.er_pu, d.er_importe,
    d.calif_cliente, d.dias_punta, d.horas_punta, d.factor_calif,
    d.cargo_fijo, d.mantenimiento, d.alumbrado, d.recup_energia, d.mora, d.reconexion, d.ajuste_tarifa,
    d.dist_factura, d.ajuste_alumb, d.otros_afectos, d.base_imponible, d.igv, d.tot_periodo,
    d.electrif_rural, d.comp_distribucion, d.comp_generadora, d.comp_interrup, d.comp_calidad,
    d.comp_frec_ant, d.comp_frec_des, d.comp_serv, d.comp_norma_tec, d.comp_deuda_ant, d.comp_deuda_meses,
    d.comp_dev_reclamo, d.comp_nota_deb_cred, d.comp_aporte_reemb, d.comp_otros_inafectos,
    d.comp_redondeo_act_pos, d.comp_redondeo_act_neg,
    d.costo_medio, d.total_a_pagar, d.valor_venta, d.deuda_anterior, d.devolucion, d.fecha_liquidacion
  FROM dedup d
  LEFT JOIN ods.web_hm_indra_energia o
    ON o.num_recibo = d.num_recibo
  WHERE o.num_recibo IS NULL;

  GET DIAGNOSTICS v_inserted_ods = ROW_COUNT;

  /* ===================== LOG ===================== */
  v_estado := 'DONE';
  v_msj := format(
    'Duplicados movidos a error_energia=%s | Duplicados borrados RAW=%s | Insertados en ODS=%s | Origen=raw.web_mm_indra_energia',
    v_ins_err_dup, v_del_dup_raw, v_inserted_ods
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted_ods,
    p_updated    => NULL::integer,
    p_deleted    => v_del_dup_raw,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

--------- vista

CREATE OR REPLACE VIEW ods.vw_hm_energia AS
SELECT
  num_recibo,
  cod_suministro,
  tarifa,
  pot_contr,
  titularidad,
  distribuidor,
  fec_emision,
  fec_vencimiento,
  fec_lect_actual,
  fec_lect_anterior,
  per_consumo,
  ea_lec_act_hp,
  ea_lec_act_fp,
  ea_lec_act_tot,
  ea_lec_ant_hp,
  ea_lec_ant_fp,
  ea_lec_ant_tot,
  ea_consumo_hp,
  ea_consumo_fp,
  ea_consumo_tot,
  ea_pu_hp,
  ea_pu_fp,
  ea_prec_unit_tot,
  ea_importe_hp,
  ea_importe_fp,
  ea_importe_tot,
  pot_lect_act_hp,
  pot_lect_act_fp,
  pot_lect_ant_hp,
  pot_lect_ant_fp,
  pot_reg_hp,
  pot_reg_fp,
  pot_gen_fact,
  pot_gen_pu,
  pot_gen_importe,
  pot_dist_fact,
  pot_dist_pu,
  pot_dist_importe,
  pot_bt6_pu,
  pot_bt6_monto,
  er_lec_act,
  er_lec_ant,
  er_cons,
  er_fact,
  er_pu,
  er_importe,
  calif_cliente,
  dias_punta,
  horas_punta,
  factor_calif,
  cargo_fijo,
  mantenimiento,
  alumbrado,
  recup_energia,
  mora,
  reconexion,
  ajuste_tarifa,
  dist_factura,
  ajuste_alumb,
  otros_afectos,
  base_imponible,
  igv,
  tot_periodo,
  electrif_rural,
  comp_distribucion,
  comp_generadora,
  comp_interrup,
  comp_calidad,
  comp_frec_ant,
  comp_frec_des,
  comp_serv,
  comp_norma_tec,
  comp_deuda_ant,
  comp_deuda_meses,
  comp_dev_reclamo,
  comp_nota_deb_cred,
  comp_aporte_reemb,
  comp_otros_inafectos,
  comp_redondeo_act_pos,
  comp_redondeo_act_neg,
  costo_medio,
  total_a_pagar,
  valor_venta,
  deuda_anterior,
  devolucion,
  fecha_liquidacion,
  creation_user,
  creation_date,
  creation_ip,
  tabla_origen
FROM (
  /* 0) EXCEL primero */
  SELECT
    e.num_recibo::varchar(255)            AS num_recibo,
    e.cod_suministro::varchar(255)        AS cod_suministro,
    e.tarifa::varchar(255)                AS tarifa,
    e.pot_contr::varchar(255)             AS pot_contr,
    e.titularidad::varchar(255)           AS titularidad,
    e.distribuidor::varchar(255)          AS distribuidor,
    e.fec_emision::varchar(255)           AS fec_emision,
    e.fec_vencimiento::varchar(255)       AS fec_vencimiento,
    e.fec_lect_actual::varchar(255)       AS fec_lect_actual,
    e.fec_lect_anterior::varchar(255)     AS fec_lect_anterior,
    e.per_consumo::varchar(255)           AS per_consumo,
    e.ea_lec_act_hp::varchar(255)         AS ea_lec_act_hp,
    e.ea_lec_act_fp::varchar(255)         AS ea_lec_act_fp,
    e.ea_lec_act_tot::varchar(255)        AS ea_lec_act_tot,
    e.ea_lec_ant_hp::varchar(255)         AS ea_lec_ant_hp,
    e.ea_lec_ant_fp::varchar(255)         AS ea_lec_ant_fp,
    e.ea_lec_ant_tot::varchar(255)        AS ea_lec_ant_tot,
    e.ea_consumo_hp::varchar(255)         AS ea_consumo_hp,
    e.ea_consumo_fp::varchar(255)         AS ea_consumo_fp,
    e.ea_consumo_tot::varchar(255)        AS ea_consumo_tot,
    e.ea_pu_hp::varchar(255)              AS ea_pu_hp,
    e.ea_pu_fp::varchar(255)              AS ea_pu_fp,
    e.ea_prec_unit_tot::varchar(255)      AS ea_prec_unit_tot,
    e.ea_importe_hp::varchar(255)         AS ea_importe_hp,
    e.ea_importe_fp::varchar(255)         AS ea_importe_fp,
    e.ea_importe_tot::varchar(255)        AS ea_importe_tot,
    e.pot_lect_act_hp::varchar(255)       AS pot_lect_act_hp,
    e.pot_lect_act_fp::varchar(255)       AS pot_lect_act_fp,
    e.pot_lect_ant_hp::varchar(255)       AS pot_lect_ant_hp,
    e.pot_lect_ant_fp::varchar(255)       AS pot_lect_ant_fp,
    e.pot_reg_hp::varchar(255)            AS pot_reg_hp,
    e.pot_reg_fp::varchar(255)            AS pot_reg_fp,
    e.pot_gen_fact::varchar(255)          AS pot_gen_fact,
    e.pot_gen_pu::varchar(255)            AS pot_gen_pu,
    e.pot_gen_importe::varchar(255)       AS pot_gen_importe,
    e.pot_dist_fact::varchar(255)         AS pot_dist_fact,
    e.pot_dist_pu::varchar(255)           AS pot_dist_pu,
    e.pot_dist_importe::varchar(255)      AS pot_dist_importe,
    e.pot_bt6_pu::varchar(255)            AS pot_bt6_pu,
    e.pot_bt6_monto::varchar(255)         AS pot_bt6_monto,
    e.er_lec_act::varchar(255)            AS er_lec_act,
    e.er_lec_ant::varchar(255)            AS er_lec_ant,
    e.er_cons::varchar(255)               AS er_cons,
    e.er_fact::varchar(255)               AS er_fact,
    e.er_pu::varchar(255)                 AS er_pu,
    e.er_importe::varchar(255)            AS er_importe,
    e.calif_cliente::varchar(255)         AS calif_cliente,
    e.dias_punta::varchar(255)            AS dias_punta,
    e.horas_punta::varchar(255)           AS horas_punta,
    e.factor_calif::varchar(255)          AS factor_calif,
    e.cargo_fijo::varchar(255)            AS cargo_fijo,
    e.mantenimiento::varchar(255)         AS mantenimiento,
    e.alumbrado::varchar(255)             AS alumbrado,
    e.recup_energia::varchar(255)         AS recup_energia,
    e.mora::varchar(255)                  AS mora,
    e.reconexion::varchar(255)            AS reconexion,
    e.ajuste_tarifa::varchar(255)         AS ajuste_tarifa,
    e.dist_factura::varchar(255)          AS dist_factura,
    e.ajuste_alumb::varchar(255)          AS ajuste_alumb,
    e.otros_afectos::varchar(255)         AS otros_afectos,
    e.base_imponible::varchar(255)        AS base_imponible,
    e.igv::varchar(255)                   AS igv,
    e.tot_periodo::varchar(255)           AS tot_periodo,
    e.electrif_rural::varchar(255)        AS electrif_rural,
    e.comp_distribucion::varchar(255)     AS comp_distribucion,
    e.comp_generadora::varchar(255)       AS comp_generadora,
    e.comp_interrup::varchar(255)         AS comp_interrup,
    e.comp_calidad::varchar(255)          AS comp_calidad,
    e.comp_frec_ant::varchar(255)         AS comp_frec_ant,
    e.comp_frec_des::varchar(255)         AS comp_frec_des,
    e.comp_serv::varchar(255)             AS comp_serv,
    e.comp_norma_tec::varchar(255)        AS comp_norma_tec,
    e.comp_deuda_ant::varchar(255)        AS comp_deuda_ant,
    e.comp_deuda_meses::varchar(255)      AS comp_deuda_meses,
    e.comp_dev_reclamo::varchar(255)      AS comp_dev_reclamo,
    e.comp_nota_deb_cred::varchar(255)    AS comp_nota_deb_cred,
    e.comp_aporte_reemb::varchar(255)     AS comp_aporte_reemb,
    e.comp_otros_inafectos::varchar(255)  AS comp_otros_inafectos,
    e.comp_redondeo_act_pos::varchar(255) AS comp_redondeo_act_pos,
    e.comp_redondeo_act_neg::varchar(255) AS comp_redondeo_act_neg,
    e.costo_medio::varchar(255)           AS costo_medio,
    e.total_a_pagar::varchar(255)         AS total_a_pagar,
    e.valor_venta::varchar(255)           AS valor_venta,
    e.deuda_anterior::varchar(255)        AS deuda_anterior,
    e.devolucion::varchar(255)            AS devolucion,
    e.fecha_liquidacion::varchar(255)     AS fecha_liquidacion,
    NULL::varchar(255)                    AS creation_user,
    NULL::varchar(255)                    AS creation_date,
    NULL::varchar(255)                    AS creation_ip,
    'raw.excel_hm_consumo_energia'::varchar(255) AS tabla_origen
  FROM raw.excel_hm_consumo_energia e

  UNION ALL
  /* 1) ODS: sftp_hm_clientes_libres */
  SELECT
    s1.num_recibo::varchar(255),
    s1.cod_suministro::varchar(255),
    s1.tarifa::varchar(255),
    s1.pot_contr::varchar(255),
    s1.titularidad::varchar(255),
    s1.distribuidor::varchar(255),
    s1.fec_emision::varchar(255),
    s1.fec_vencimiento::varchar(255),
    s1.fec_lect_actual::varchar(255),
    s1.fec_lect_anterior::varchar(255),
    s1.per_consumo::varchar(255),
    s1.ea_lec_act_hp::varchar(255),
    s1.ea_lec_act_fp::varchar(255),
    s1.ea_lec_act_tot::varchar(255),
    s1.ea_lec_ant_hp::varchar(255),
    s1.ea_lec_ant_fp::varchar(255),
    s1.ea_lec_ant_tot::varchar(255),
    s1.ea_consumo_hp::varchar(255),
    s1.ea_consumo_fp::varchar(255),
    s1.ea_consumo_tot::varchar(255),
    s1.ea_pu_hp::varchar(255),
    s1.ea_pu_fp::varchar(255),
    s1.ea_prec_unit_tot::varchar(255),
    s1.ea_importe_hp::varchar(255),
    s1.ea_importe_fp::varchar(255),
    s1.ea_importe_tot::varchar(255),
    s1.pot_lect_act_hp::varchar(255),
    s1.pot_lect_act_fp::varchar(255),
    s1.pot_lect_ant_hp::varchar(255),
    s1.pot_lect_ant_fp::varchar(255),
    s1.pot_reg_hp::varchar(255),
    s1.pot_reg_fp::varchar(255),
    s1.pot_gen_fact::varchar(255),
    s1.pot_gen_pu::varchar(255),
    s1.pot_gen_importe::varchar(255),
    s1.pot_dist_fact::varchar(255),
    s1.pot_dist_pu::varchar(255),
    s1.pot_dist_importe::varchar(255),
    s1.pot_bt6_pu::varchar(255),
    s1.pot_bt6_monto::varchar(255),
    s1.er_lec_act::varchar(255),
    s1.er_lec_ant::varchar(255),
    s1.er_cons::varchar(255),
    s1.er_fact::varchar(255),
    s1.er_pu::varchar(255),
    s1.er_importe::varchar(255),
    s1.calif_cliente::varchar(255),
    s1.dias_punta::varchar(255),
    s1.horas_punta::varchar(255),
    s1.factor_calif::varchar(255),
    s1.cargo_fijo::varchar(255),
    s1.mantenimiento::varchar(255),
    s1.alumbrado::varchar(255),
    s1.recup_energia::varchar(255),
    s1.mora::varchar(255),
    s1.reconexion::varchar(255),
    s1.ajuste_tarifa::varchar(255),
    s1.dist_factura::varchar(255),
    s1.ajuste_alumb::varchar(255),
    s1.otros_afectos::varchar(255),
    s1.base_imponible::varchar(255),
    s1.igv::varchar(255),
    s1.tot_periodo::varchar(255),
    s1.electrif_rural::varchar(255),
    s1.comp_distribucion::varchar(255),
    s1.comp_generadora::varchar(255),
    s1.comp_interrup::varchar(255),
    s1.comp_calidad::varchar(255),
    s1.comp_frec_ant::varchar(255),
    s1.comp_frec_des::varchar(255),
    s1.comp_serv::varchar(255),
    s1.comp_norma_tec::varchar(255),
    s1.comp_deuda_ant::varchar(255),
    s1.comp_deuda_meses::varchar(255),
    s1.comp_dev_reclamo::varchar(255),
    s1.comp_nota_deb_cred::varchar(255),
    s1.comp_aporte_reemb::varchar(255),
    s1.comp_otros_inafectos::varchar(255),
    s1.comp_redondeo_act_pos::varchar(255),
    s1.comp_redondeo_act_neg::varchar(255),
    s1.costo_medio::varchar(255),
    s1.total_a_pagar::varchar(255),
    s1.valor_venta::varchar(255),
    s1.deuda_anterior::varchar(255),
    s1.devolucion::varchar(255),
    s1.fecha_liquidacion::varchar(255),
    s1.creation_user::varchar(255),
    s1.creation_date::varchar(255),
    s1.creation_ip::varchar(255),
    'ods.sftp_hm_clientes_libres'::varchar(255) AS tabla_origen
  FROM ods.sftp_hm_clientes_libres s1

  UNION ALL
  /* 2) ODS: sftp_hm_consumo_suministro */
  SELECT
    s2.num_recibo::varchar(255),
    s2.cod_suministro::varchar(255),
    s2.tarifa::varchar(255),
    s2.pot_contr::varchar(255),
    s2.titularidad::varchar(255),
    s2.distribuidor::varchar(255),
    s2.fec_emision::varchar(255),
    s2.fec_vencimiento::varchar(255),
    s2.fec_lect_actual::varchar(255),
    s2.fec_lect_anterior::varchar(255),
    s2.per_consumo::varchar(255),
    s2.ea_lec_act_hp::varchar(255),
    s2.ea_lec_act_fp::varchar(255),
    s2.ea_lec_act_tot::varchar(255),
    s2.ea_lec_ant_hp::varchar(255),
    s2.ea_lec_ant_fp::varchar(255),
    s2.ea_lec_ant_tot::varchar(255),
    s2.ea_consumo_hp::varchar(255),
    s2.ea_consumo_fp::varchar(255),
    s2.ea_consumo_tot::varchar(255),
    s2.ea_pu_hp::varchar(255),
    s2.ea_pu_fp::varchar(255),
    s2.ea_prec_unit_tot::varchar(255),
    s2.ea_importe_hp::varchar(255),
    s2.ea_importe_fp::varchar(255),
    s2.ea_importe_tot::varchar(255),
    s2.pot_lect_act_hp::varchar(255),
    s2.pot_lect_act_fp::varchar(255),
    s2.pot_lect_ant_hp::varchar(255),
    s2.pot_lect_ant_fp::varchar(255),
    s2.pot_reg_hp::varchar(255),
    s2.pot_reg_fp::varchar(255),
    s2.pot_gen_fact::varchar(255),
    s2.pot_gen_pu::varchar(255),
    s2.pot_gen_importe::varchar(255),
    s2.pot_dist_fact::varchar(255),
    s2.pot_dist_pu::varchar(255),
    s2.pot_dist_importe::varchar(255),
    s2.pot_bt6_pu::varchar(255),
    s2.pot_bt6_monto::varchar(255),
    s2.er_lec_act::varchar(255),
    s2.er_lec_ant::varchar(255),
    s2.er_cons::varchar(255),
    s2.er_fact::varchar(255),
    s2.er_pu::varchar(255),
    s2.er_importe::varchar(255),
    s2.calif_cliente::varchar(255),
    s2.dias_punta::varchar(255),
    s2.horas_punta::varchar(255),
    s2.factor_calif::varchar(255),
    s2.cargo_fijo::varchar(255),
    s2.mantenimiento::varchar(255),
    s2.alumbrado::varchar(255),
    s2.recup_energia::varchar(255),
    s2.mora::varchar(255),
    s2.reconexion::varchar(255),
    s2.ajuste_tarifa::varchar(255),
    s2.dist_factura::varchar(255),
    s2.ajuste_alumb::varchar(255),
    s2.otros_afectos::varchar(255),
    s2.base_imponible::varchar(255),
    s2.igv::varchar(255),
    s2.tot_periodo::varchar(255),
    s2.electrif_rural::varchar(255),
    s2.comp_distribucion::varchar(255),
    s2.comp_generadora::varchar(255),
    s2.comp_interrup::varchar(255),
    s2.comp_calidad::varchar(255),
    s2.comp_frec_ant::varchar(255),
    s2.comp_frec_des::varchar(255),
    s2.comp_serv::varchar(255),
    s2.comp_norma_tec::varchar(255),
    s2.comp_deuda_ant::varchar(255),
    s2.comp_deuda_meses::varchar(255),
    s2.comp_dev_reclamo::varchar(255),
    s2.comp_nota_deb_cred::varchar(255),
    s2.comp_aporte_reemb::varchar(255),
    s2.comp_otros_inafectos::varchar(255),
    s2.comp_redondeo_act_pos::varchar(255),
    s2.comp_redondeo_act_neg::varchar(255),
    s2.costo_medio::varchar(255),
    s2.total_a_pagar::varchar(255),
    s2.valor_venta::varchar(255),
    s2.deuda_anterior::varchar(255),
    s2.devolucion::varchar(255),
    s2.fecha_liquidacion::varchar(255),
    s2.creation_user::varchar(255),
    s2.creation_date::varchar(255),
    s2.creation_ip::varchar(255),
    'ods.sftp_hm_consumo_suministro'::varchar(255) AS tabla_origen
  FROM ods.sftp_hm_consumo_suministro s2

  UNION ALL
  /* 3) ODS: web_hm_indra_energia */
  SELECT
    w.num_recibo::varchar(255),
    w.cod_suministro::varchar(255),
    w.tarifa::varchar(255),
    w.pot_contr::varchar(255),
    w.titularidad::varchar(255),
    w.distribuidor::varchar(255),
    w.fec_emision::varchar(255),
    w.fec_vencimiento::varchar(255),
    w.fec_lect_actual::varchar(255),
    w.fec_lect_anterior::varchar(255),
    w.per_consumo::varchar(255),
    w.ea_lec_act_hp::varchar(255),
    w.ea_lec_act_fp::varchar(255),
    w.ea_lec_act_tot::varchar(255),
    w.ea_lec_ant_hp::varchar(255),
    w.ea_lec_ant_fp::varchar(255),
    w.ea_lec_ant_tot::varchar(255),
    w.ea_consumo_hp::varchar(255),
    w.ea_consumo_fp::varchar(255),
    w.ea_consumo_tot::varchar(255),
    w.ea_pu_hp::varchar(255),
    w.ea_pu_fp::varchar(255),
    w.ea_prec_unit_tot::varchar(255),
    w.ea_importe_hp::varchar(255),
    w.ea_importe_fp::varchar(255),
    w.ea_importe_tot::varchar(255),
    w.pot_lect_act_hp::varchar(255),
    w.pot_lect_act_fp::varchar(255),
    w.pot_lect_ant_hp::varchar(255),
    w.pot_lect_ant_fp::varchar(255),
    w.pot_reg_hp::varchar(255),
    w.pot_reg_fp::varchar(255),
    w.pot_gen_fact::varchar(255),
    w.pot_gen_pu::varchar(255),
    w.pot_gen_importe::varchar(255),
    w.pot_dist_fact::varchar(255),
    w.pot_dist_pu::varchar(255),
    w.pot_dist_importe::varchar(255),
    w.pot_bt6_pu::varchar(255),
    w.pot_bt6_monto::varchar(255),
    w.er_lec_act::varchar(255),
    w.er_lec_ant::varchar(255),
    w.er_cons::varchar(255),
    w.er_fact::varchar(255),
    w.er_pu::varchar(255),
    w.er_importe::varchar(255),
    w.calif_cliente::varchar(255),
    w.dias_punta::varchar(255),
    w.horas_punta::varchar(255),
    w.factor_calif::varchar(255),
    w.cargo_fijo::varchar(255),
    w.mantenimiento::varchar(255),
    w.alumbrado::varchar(255),
    w.recup_energia::varchar(255),
    w.mora::varchar(255),
    w.reconexion::varchar(255),
    w.ajuste_tarifa::varchar(255),
    w.dist_factura::varchar(255),
    w.ajuste_alumb::varchar(255),
    w.otros_afectos::varchar(255),
    w.base_imponible::varchar(255),
    w.igv::varchar(255),
    w.tot_periodo::varchar(255),
    w.electrif_rural::varchar(255),
    w.comp_distribucion::varchar(255),
    w.comp_generadora::varchar(255),
    w.comp_interrup::varchar(255),
    w.comp_calidad::varchar(255),
    w.comp_frec_ant::varchar(255),
    w.comp_frec_des::varchar(255),
    w.comp_serv::varchar(255),
    w.comp_norma_tec::varchar(255),
    w.comp_deuda_ant::varchar(255),
    w.comp_deuda_meses::varchar(255),
    w.comp_dev_reclamo::varchar(255),
    w.comp_nota_deb_cred::varchar(255),
    w.comp_aporte_reemb::varchar(255),
    w.comp_otros_inafectos::varchar(255),
    w.comp_redondeo_act_pos::varchar(255),
    w.comp_redondeo_act_neg::varchar(255),
    w.costo_medio::varchar(255),
    w.total_a_pagar::varchar(255),
    w.valor_venta::varchar(255),
    w.deuda_anterior::varchar(255),
    w.devolucion::varchar(255),
    w.fecha_liquidacion::varchar(255),
    w.creation_user::varchar(255),
    w.creation_date::varchar(255),
    w.creation_ip::varchar(255),
    'ods.web_hm_indra_energia'::varchar(255) AS tabla_origen
  FROM ods.web_hm_indra_energia w
) t;