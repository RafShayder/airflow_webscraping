CREATE SCHEMA IF NOT EXISTS raw;
CREATE SCHEMA IF NOT EXISTS ods;
------------------------------------
CREATE TABLE public.log_sp (
	id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	id_sp int4 NULL,
	sp varchar(125) NULL,
	inicio timestamp(0) NULL,
	fin timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	inserted int4 NULL,
	updated int4 NULL,
	deleted int4 NULL,
	"nulls" int4 NULL,
	estado varchar(50) NULL,
	msj_error text NULL,
	usr_cre text DEFAULT CURRENT_USER NULL,
	CONSTRAINT log_sp_pkey PRIMARY KEY (id)
);
CREATE INDEX ix_log_sp_norm_fin_id ON public.log_sp USING btree (regexp_replace(btrim(lower((sp)::text)), '\\(\\)$'::text, ''::text), fin DESC, id DESC);
------------------------------------------------------------
CREATE TABLE public.error_energia (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL,
	fecha_carga timestamptz NOT NULL,
	tabla_origen text NOT NULL
);
-------------------------------------------

CREATE OR REPLACE PROCEDURE public.sp_grabar_log_sp(IN p_id_sp integer DEFAULT NULL::integer, IN p_inicio timestamp without time zone DEFAULT NULL::timestamp without time zone, IN p_fin timestamp without time zone DEFAULT NULL::timestamp without time zone, IN p_inserted integer DEFAULT NULL::integer, IN p_updated integer DEFAULT NULL::integer, IN p_deleted integer DEFAULT NULL::integer, IN p_nulls integer DEFAULT NULL::integer, IN p_estado character varying DEFAULT NULL::character varying, IN p_msj_error text DEFAULT NULL::text, IN p_sp text DEFAULT NULL::text)
 LANGUAGE plpgsql
AS $procedure$
BEGIN
  IF p_inicio IS NULL THEN p_inicio := clock_timestamp()::timestamp(0); END IF;
  IF p_fin    IS NULL THEN p_fin    := clock_timestamp()::timestamp(0); END IF;

  INSERT INTO public.log_sp (
    id_sp, sp, inicio, fin,
    inserted, updated, deleted, nulls, estado, msj_error
  ) VALUES (
    p_id_sp, p_sp, p_inicio, p_fin,
    p_inserted, p_updated, p_deleted, p_nulls, p_estado, p_msj_error
  );
END;
$procedure$
;
----------------------------------

CREATE OR REPLACE FUNCTION public.try_numeric(p_text text)
 RETURNS numeric
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
DECLARE
  v text;
BEGIN
  IF p_text IS NULL THEN
    RETURN NULL;
  END IF;

  -- Limpia espacios y cualquier símbolo que no sea dígito, coma, punto o guion
  v := regexp_replace(btrim(p_text), '[^0-9,.\-]', '', 'g');

  -- Caso 1: sin comas, decimal con punto (US)
  IF v ~ '^\-?\d+(\.\d+)?$' THEN
    RETURN v::numeric;
  END IF;

  -- Caso 2: con separador de miles por comas correctas, y decimal con punto
  -- Ej: -1,234,567.89  ó  1,234  ó  1,234.0
  IF v ~ '^\-?\d{1,3}(,\d{3})+(\.\d+)?$' THEN
    v := replace(v, ',', '');       -- quitamos miles
    RETURN v::numeric;              -- ya queda con decimal '.'
  END IF;

  RETURN NULL;
EXCEPTION
  WHEN OTHERS THEN
    RETURN NULL;
END;
$function$
;
-----------------

CREATE OR REPLACE FUNCTION public.log_sp_ultimo_fn(p_sp text)
 RETURNS TABLE(id integer, id_sp integer, sp text, inicio timestamp without time zone, fin timestamp without time zone, inserted integer, updated integer, deleted integer, nulls integer, estado character varying, msj_error text, usr_cre text)
 LANGUAGE sql
AS $function$
  SELECT
    id, id_sp, sp, inicio, fin, inserted, updated, deleted, "nulls",
    estado, msj_error, usr_cre
  FROM public.log_sp
  WHERE sp = p_sp
  ORDER BY COALESCE(fin, inicio, 'epoch'::timestamp) DESC, id DESC
  LIMIT 1
$function$
;
------------------------

CREATE OR REPLACE FUNCTION public.error_energia_ultimo_lote(p_tabla text)
 RETURNS SETOF error_energia
 LANGUAGE sql
 STABLE
AS $function$
  SELECT e.*
  FROM public.error_energia e
  WHERE lower(btrim(e.tabla_origen)) = lower(btrim(p_tabla))
    AND e.fecha_carga::date = CURRENT_DATE
    AND e.fecha_carga = (
      SELECT MAX(fecha_carga)
      FROM public.error_energia
      WHERE lower(btrim(tabla_origen)) = lower(btrim(p_tabla))
        AND fecha_carga::date = CURRENT_DATE
    );
$function$
;

-----RAW------------

CREATE TABLE raw.fs_mm_base_de_sitios (
	codigo_unico varchar(250) NULL,
	nombre_local varchar(250) NULL,
	direccion varchar(400) NULL,
	latitud varchar(250) NULL,
	longitud varchar(250) NULL,
	ubigeo varchar(250) NULL,
	departamento varchar(250) NULL,
	provincia varchar(250) NULL,
	distrito varchar(250) NULL,
	tipo_local varchar(250) NULL,
	proveedor_flm varchar(250) NULL,
	atencion varchar(250) NULL,
	zona varchar(250) NULL,
	tipo_zona_flm varchar(250) NULL,
	propietario_de_torre varchar(250) NULL,
	propietario_de_piso varchar(250) NULL,
	tipo_estacion varchar(250) NULL,
	tipo_torre varchar(250) NULL,
	clasificacion_instalacion varchar(250) NULL,
	fecha_puesta_en_servicio varchar(250) NULL,
	bucket varchar(250) NULL,
	sla varchar(250) NULL,
	tipo_vip varchar(250) NULL,
	criticidad_local varchar(250) NULL,
	observacion varchar(250) NULL,
	priorizacion varchar(250) NULL,
	ubigeotoa varchar(250) NULL
);
---------------------

CREATE TABLE raw.fs_mm_bitacora_base_sitios (
	codigo_unico varchar(250) NULL,
	nombre_local varchar(250) NULL,
	direccion varchar(350) NULL,
	latitud varchar(250) NULL,
	longitud varchar(250) NULL,
	ubigeo varchar(250) NULL,
	departamento varchar(250) NULL,
	provincia varchar(250) NULL,
	distrito varchar(250) NULL,
	tipo_local varchar(250) NULL,
	proveedor_flm varchar(250) NULL,
	atencion varchar(250) NULL,
	zona varchar(250) NULL,
	tipo_zona_flm varchar(250) NULL,
	propietario_de_torre varchar(250) NULL,
	propietario_de_piso varchar(250) NULL,
	tipo_estacion varchar(250) NULL,
	tipo_torre varchar(250) NULL,
	clasificacion_instalacion varchar(250) NULL,
	fecha_puesta_en_servicio varchar(250) NULL,
	bucket varchar(250) NULL,
	sla varchar(250) NULL,
	tipo_vip varchar(250) NULL,
	criticidad_local varchar(250) NULL,
	observacion varchar(250) NULL,
	priorizacion varchar(250) NULL,
	accion varchar(250) NULL,
	solicitado_por varchar(250) NULL,
	base varchar(250) NULL,
	campo_modificado varchar(250) NULL,
	observaciones varchar(400) NULL,
	estado varchar(250) NULL
);
----------------------------

CREATE TABLE raw.sftp_mm_clientes_libres (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
------------------------------

CREATE TABLE raw.sftp_mm_consumo_suministro_da (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
------------------------------
CREATE TABLE raw.sftp_mm_consumo_suministro_pd (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
-----------

CREATE TABLE raw.web_mm_indra_energia (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);
--------------------
CREATE TABLE raw.excel_hm_consumo_energia (
	num_recibo varchar(255) NULL,
	cod_suministro varchar(255) NULL,
	tarifa varchar(255) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision varchar(255) NULL,
	fec_vencimiento varchar(255) NULL,
	fec_lect_actual varchar(255) NULL,
	fec_lect_anterior varchar(255) NULL,
	per_consumo varchar(255) NULL,
	ea_lec_act_hp varchar(255) NULL,
	ea_lec_act_fp varchar(255) NULL,
	ea_lec_act_tot varchar(255) NULL,
	ea_lec_ant_hp varchar(255) NULL,
	ea_lec_ant_fp varchar(255) NULL,
	ea_lec_ant_tot varchar(255) NULL,
	ea_consumo_hp varchar(255) NULL,
	ea_consumo_fp varchar(255) NULL,
	ea_consumo_tot varchar(255) NULL,
	ea_pu_hp varchar(255) NULL,
	ea_pu_fp varchar(255) NULL,
	ea_prec_unit_tot varchar(255) NULL,
	ea_importe_hp varchar(255) NULL,
	ea_importe_fp varchar(255) NULL,
	ea_importe_tot varchar(255) NULL,
	pot_lect_act_hp varchar(255) NULL,
	pot_lect_act_fp varchar(255) NULL,
	pot_lect_ant_hp varchar(255) NULL,
	pot_lect_ant_fp varchar(255) NULL,
	pot_reg_hp varchar(255) NULL,
	pot_reg_fp varchar(255) NULL,
	pot_gen_fact varchar(255) NULL,
	pot_gen_pu varchar(255) NULL,
	pot_gen_importe varchar(255) NULL,
	pot_dist_fact varchar(255) NULL,
	pot_dist_pu varchar(255) NULL,
	pot_dist_importe varchar(255) NULL,
	pot_bt6_pu varchar(255) NULL,
	pot_bt6_monto varchar(255) NULL,
	er_lec_act varchar(255) NULL,
	er_lec_ant varchar(255) NULL,
	er_cons varchar(255) NULL,
	er_fact varchar(255) NULL,
	er_pu varchar(255) NULL,
	er_importe varchar(255) NULL,
	calif_cliente varchar(255) NULL,
	dias_punta varchar(255) NULL,
	horas_punta varchar(255) NULL,
	factor_calif varchar(255) NULL,
	cargo_fijo varchar(255) NULL,
	mantenimiento varchar(255) NULL,
	alumbrado varchar(255) NULL,
	recup_energia varchar(255) NULL,
	mora varchar(255) NULL,
	reconexion varchar(255) NULL,
	ajuste_tarifa varchar(255) NULL,
	dist_factura varchar(255) NULL,
	ajuste_alumb varchar(255) NULL,
	otros_afectos varchar(255) NULL,
	base_imponible varchar(255) NULL,
	igv varchar(255) NULL,
	tot_periodo varchar(255) NULL,
	electrif_rural varchar(255) NULL,
	comp_distribucion varchar(255) NULL,
	comp_generadora varchar(255) NULL,
	comp_interrup varchar(255) NULL,
	comp_calidad varchar(255) NULL,
	comp_frec_ant varchar(255) NULL,
	comp_frec_des varchar(255) NULL,
	comp_serv varchar(255) NULL,
	comp_norma_tec varchar(255) NULL,
	comp_deuda_ant varchar(255) NULL,
	comp_deuda_meses varchar(255) NULL,
	comp_dev_reclamo varchar(255) NULL,
	comp_nota_deb_cred varchar(255) NULL,
	comp_aporte_reemb varchar(255) NULL,
	comp_otros_inafectos varchar(255) NULL,
	comp_redondeo_act_pos varchar(255) NULL,
	comp_redondeo_act_neg varchar(255) NULL,
	costo_medio varchar(255) NULL,
	total_a_pagar varchar(255) NULL,
	valor_venta varchar(255) NULL,
	deuda_anterior varchar(255) NULL,
	devolucion varchar(255) NULL,
	fecha_liquidacion varchar(255) NULL
);

-------------ODS

CREATE TABLE ods.fs_hm_base_de_sitios (
	codigo_unico varchar(120) NULL,
	nombre_local varchar(200) NULL,
	direccion varchar(350) NULL,
	latitud numeric(11, 8) NULL,
	longitud numeric(11, 8) NULL,
	ubigeo varchar(10) NULL,
	departamento varchar(120) NULL,
	provincia varchar(120) NULL,
	distrito varchar(120) NULL,
	tipo_local varchar(120) NULL,
	proveedor_flm varchar(150) NULL,
	atencion varchar(120) NULL,
	zona varchar(120) NULL,
	tipo_zona_flm varchar(120) NULL,
	propietario_de_torre varchar(150) NULL,
	propietario_de_piso varchar(150) NULL,
	tipo_estacion varchar(120) NULL,
	tipo_torre varchar(120) NULL,
	clasificacion_instalacion varchar(150) NULL,
	fecha_puesta_en_servicio date NULL,
	bucket varchar(80) NULL,
	sla varchar(80) NULL,
	tipo_vip varchar(80) NULL,
	criticidad_local varchar(80) NULL,
	observacion varchar(500) NULL,
	priorizacion varchar(80) NULL,
	ubigeotoa varchar(120) NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL
);
----------------------------------

CREATE TABLE ods.fs_hm_bitacora_base_sitios (
	codigo_unico varchar(120) NULL,
	nombre_local varchar(200) NULL,
	direccion varchar(350) NULL,
	latitud numeric(11, 8) NULL,
	longitud numeric(11, 8) NULL,
	ubigeo varchar(10) NULL,
	departamento varchar(120) NULL,
	provincia varchar(120) NULL,
	distrito varchar(120) NULL,
	tipo_local varchar(120) NULL,
	proveedor_flm varchar(150) NULL,
	atencion varchar(120) NULL,
	zona varchar(120) NULL,
	tipo_zona_flm varchar(120) NULL,
	propietario_de_torre varchar(150) NULL,
	propietario_de_piso varchar(150) NULL,
	tipo_estacion varchar(120) NULL,
	tipo_torre varchar(120) NULL,
	clasificacion_instalacion varchar(150) NULL,
	fecha_puesta_en_servicio date NULL,
	bucket varchar(80) NULL,
	sla varchar(80) NULL,
	tipo_vip varchar(80) NULL,
	criticidad_local varchar(80) NULL,
	observacion varchar(500) NULL,
	priorizacion varchar(80) NULL,
	accion varchar(15) NULL,
	solicitado_por varchar(120) NULL,
	base bpchar(6) NULL,
	campo_modificado varchar(150) NULL,
	observaciones varchar(450) NULL,
	estado varchar(20) NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL
);
------------------

CREATE TABLE ods.sftp_hm_clientes_libres (
	num_recibo int8 NOT NULL,
	cod_suministro varchar(250) NULL,
	tarifa varchar(10) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision date NULL,
	fec_vencimiento date NULL,
	fec_lect_actual date NULL,
	fec_lect_anterior date NULL,
	per_consumo varchar(50) NULL,
	ea_lec_act_hp numeric(18, 2) NULL,
	ea_lec_act_fp numeric(18, 2) NULL,
	ea_lec_act_tot numeric(18, 2) NULL,
	ea_lec_ant_hp numeric(18, 2) NULL,
	ea_lec_ant_fp numeric(18, 2) NULL,
	ea_lec_ant_tot numeric(18, 2) NULL,
	ea_consumo_hp numeric(18, 2) NULL,
	ea_consumo_fp numeric(18, 2) NULL,
	ea_consumo_tot numeric(18, 2) NULL,
	ea_pu_hp numeric(18, 6) NULL,
	ea_pu_fp numeric(18, 6) NULL,
	ea_prec_unit_tot numeric(18, 6) NULL,
	ea_importe_hp numeric(18, 2) NULL,
	ea_importe_fp numeric(18, 2) NULL,
	ea_importe_tot numeric(18, 2) NULL,
	pot_lect_act_hp numeric(18, 2) NULL,
	pot_lect_act_fp numeric(18, 2) NULL,
	pot_lect_ant_hp numeric(18, 2) NULL,
	pot_lect_ant_fp numeric(18, 2) NULL,
	pot_reg_hp numeric(18, 2) NULL,
	pot_reg_fp numeric(18, 2) NULL,
	pot_gen_fact numeric(18, 2) NULL,
	pot_gen_pu numeric(18, 6) NULL,
	pot_gen_importe numeric(18, 2) NULL,
	pot_dist_fact numeric(18, 2) NULL,
	pot_dist_pu numeric(18, 6) NULL,
	pot_dist_importe numeric(18, 2) NULL,
	pot_bt6_pu numeric(18, 6) NULL,
	pot_bt6_monto numeric(18, 2) NULL,
	er_lec_act numeric(18, 2) NULL,
	er_lec_ant numeric(18, 2) NULL,
	er_cons numeric(18, 2) NULL,
	er_fact numeric(18, 2) NULL,
	er_pu numeric(18, 6) NULL,
	er_importe numeric(18, 2) NULL,
	calif_cliente varchar(100) NULL,
	dias_punta int4 NULL,
	horas_punta int4 NULL,
	factor_calif varchar(50) NULL,
	cargo_fijo numeric(18, 2) NULL,
	mantenimiento numeric(18, 2) NULL,
	alumbrado numeric(18, 2) NULL,
	recup_energia numeric(18, 2) NULL,
	mora numeric(18, 2) NULL,
	reconexion numeric(18, 2) NULL,
	ajuste_tarifa numeric(18, 2) NULL,
	dist_factura numeric(18, 2) NULL,
	ajuste_alumb numeric(18, 2) NULL,
	otros_afectos numeric(18, 2) NULL,
	base_imponible numeric(18, 2) NULL,
	igv numeric(18, 2) NULL,
	tot_periodo numeric(18, 2) NULL,
	electrif_rural numeric(18, 2) NULL,
	comp_distribucion numeric(18, 2) NULL,
	comp_generadora numeric(18, 2) NULL,
	comp_interrup numeric(18, 2) NULL,
	comp_calidad numeric(18, 2) NULL,
	comp_frec_ant numeric(18, 2) NULL,
	comp_frec_des numeric(18, 2) NULL,
	comp_serv numeric(18, 2) NULL,
	comp_norma_tec numeric(18, 2) NULL,
	comp_deuda_ant numeric(18, 2) NULL,
	comp_deuda_meses int4 NULL,
	comp_dev_reclamo numeric(18, 2) NULL,
	comp_nota_deb_cred numeric(18, 2) NULL,
	comp_aporte_reemb numeric(18, 2) NULL,
	comp_otros_inafectos numeric(18, 2) NULL,
	comp_redondeo_act_pos numeric(18, 2) NULL,
	comp_redondeo_act_neg numeric(18, 2) NULL,
	costo_medio numeric(18, 2) NULL,
	total_a_pagar numeric(18, 2) NULL,
	valor_venta numeric(18, 2) NULL,
	deuda_anterior numeric(18, 2) NULL,
	devolucion numeric(18, 2) NULL,
	fecha_liquidacion date NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL,
	CONSTRAINT sftp_hm_clientes_libres_pkey PRIMARY KEY (num_recibo)
);

---------------


CREATE TABLE ods.sftp_hm_consumo_suministro (
	num_recibo varchar(250) NOT NULL,
	cod_suministro varchar(250) NULL,
	tarifa varchar(10) NULL,
  pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision date NULL,
	fec_vencimiento date NULL,
	fec_lect_actual date NULL,
	fec_lect_anterior date NULL,
	per_consumo varchar(50) NULL,
	ea_lec_act_hp numeric(18, 2) NULL,
	ea_lec_act_fp numeric(18, 2) NULL,
	ea_lec_act_tot numeric(18, 2) NULL,
	ea_lec_ant_hp numeric(18, 2) NULL,
	ea_lec_ant_fp numeric(18, 2) NULL,
	ea_lec_ant_tot numeric(18, 2) NULL,
	ea_consumo_hp numeric(18, 2) NULL,
	ea_consumo_fp numeric(18, 2) NULL,
	ea_consumo_tot numeric(18, 2) NULL,
	ea_pu_hp numeric(18, 6) NULL,
	ea_pu_fp numeric(18, 6) NULL,
	ea_prec_unit_tot numeric(18, 6) NULL,
	ea_importe_hp numeric(18, 2) NULL,
	ea_importe_fp numeric(18, 2) NULL,
	ea_importe_tot numeric(18, 2) NULL,
	pot_lect_act_hp numeric(18, 2) NULL,
	pot_lect_act_fp numeric(18, 2) NULL,
	pot_lect_ant_hp numeric(18, 2) NULL,
	pot_lect_ant_fp numeric(18, 2) NULL,
	pot_reg_hp numeric(18, 2) NULL,
	pot_reg_fp numeric(18, 2) NULL,
	pot_gen_fact numeric(18, 2) NULL,
	pot_gen_pu numeric(18, 6) NULL,
	pot_gen_importe numeric(18, 2) NULL,
	pot_dist_fact numeric(18, 2) NULL,
	pot_dist_pu numeric(18, 6) NULL,
	pot_dist_importe numeric(18, 2) NULL,
	pot_bt6_pu numeric(18, 6) NULL,
	pot_bt6_monto numeric(18, 2) NULL,
	er_lec_act numeric(18, 2) NULL,
	er_lec_ant numeric(18, 2) NULL,
	er_cons numeric(18, 2) NULL,
	er_fact numeric(18, 2) NULL,
	er_pu numeric(18, 6) NULL,
	er_importe numeric(18, 2) NULL,
	calif_cliente varchar(100) NULL,
	dias_punta int4 NULL,
	horas_punta int4 NULL,
	factor_calif varchar(50) NULL,
	cargo_fijo numeric(18, 2) NULL,
	mantenimiento numeric(18, 2) NULL,
	alumbrado numeric(18, 2) NULL,
	recup_energia numeric(18, 2) NULL,
	mora numeric(18, 2) NULL,
	reconexion numeric(18, 2) NULL,
	ajuste_tarifa numeric(18, 2) NULL,
	dist_factura numeric(18, 2) NULL,
	ajuste_alumb numeric(18, 2) NULL,
	otros_afectos numeric(18, 2) NULL,
	base_imponible numeric(18, 2) NULL,
	igv numeric(18, 2) NULL,
	tot_periodo numeric(18, 2) NULL,
	electrif_rural numeric(18, 2) NULL,
	comp_distribucion numeric(18, 2) NULL,
	comp_generadora numeric(18, 2) NULL,
	comp_interrup numeric(18, 2) NULL,
	comp_calidad numeric(18, 2) NULL,
	comp_frec_ant numeric(18, 2) NULL,
	comp_frec_des numeric(18, 2) NULL,
	comp_serv numeric(18, 2) NULL,
	comp_norma_tec numeric(18, 2) NULL,
	comp_deuda_ant numeric(18, 2) NULL,
	comp_deuda_meses int4 NULL,
	comp_dev_reclamo numeric(18, 2) NULL,
	comp_nota_deb_cred numeric(18, 2) NULL,
	comp_aporte_reemb numeric(18, 2) NULL,
	comp_otros_inafectos numeric(18, 2) NULL,
	comp_redondeo_act_pos numeric(18, 2) NULL,
	comp_redondeo_act_neg numeric(18, 2) NULL,
	costo_medio numeric(18, 2) NULL,
	total_a_pagar numeric(18, 2) NULL,
	valor_venta numeric(18, 2) NULL,
	deuda_anterior numeric(18, 2) NULL,
	devolucion numeric(18, 2) NULL,
	fecha_liquidacion date NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL,
	CONSTRAINT sftp_hm_consumo_suministro_pkey PRIMARY KEY (num_recibo)
);
-------------

CREATE TABLE ods.web_hm_indra_energia (
	num_recibo varchar(250) NOT NULL,
	cod_suministro varchar(250) NULL,
	tarifa varchar(10) NULL,
	pot_contr varchar(255) NULL,
	titularidad varchar(255) NULL,
	distribuidor varchar(255) NULL,
	fec_emision date NULL,
	fec_vencimiento date NULL,
	fec_lect_actual date NULL,
	fec_lect_anterior date NULL,
	per_consumo varchar(50) NULL,
	ea_lec_act_hp numeric(18, 2) NULL,
	ea_lec_act_fp numeric(18, 2) NULL,
	ea_lec_act_tot numeric(18, 2) NULL,
	ea_lec_ant_hp numeric(18, 2) NULL,
	ea_lec_ant_fp numeric(18, 2) NULL,
	ea_lec_ant_tot numeric(18, 2) NULL,
	ea_consumo_hp numeric(18, 2) NULL,
	ea_consumo_fp numeric(18, 2) NULL,
	ea_consumo_tot numeric(18, 2) NULL,
	ea_pu_hp numeric(18, 6) NULL,
	ea_pu_fp numeric(18, 6) NULL,
	ea_prec_unit_tot numeric(18, 6) NULL,
	ea_importe_hp numeric(18, 2) NULL,
	ea_importe_fp numeric(18, 2) NULL,
	ea_importe_tot numeric(18, 2) NULL,
	pot_lect_act_hp numeric(18, 2) NULL,
	pot_lect_act_fp numeric(18, 2) NULL,
	pot_lect_ant_hp numeric(18, 2) NULL,
	pot_lect_ant_fp numeric(18, 2) NULL,
	pot_reg_hp numeric(18, 2) NULL,
	pot_reg_fp numeric(18, 2) NULL,
	pot_gen_fact numeric(18, 2) NULL,
	pot_gen_pu numeric(18, 6) NULL,
	pot_gen_importe numeric(18, 2) NULL,
	pot_dist_fact numeric(18, 2) NULL,
	pot_dist_pu numeric(18, 6) NULL,
	pot_dist_importe numeric(18, 2) NULL,
	pot_bt6_pu numeric(18, 6) NULL,
	pot_bt6_monto numeric(18, 2) NULL,
	er_lec_act numeric(18, 2) NULL,
	er_lec_ant numeric(18, 2) NULL,
	er_cons numeric(18, 2) NULL,
	er_fact numeric(18, 2) NULL,
	er_pu numeric(18, 6) NULL,
	er_importe numeric(18, 2) NULL,
	calif_cliente varchar(100) NULL,
	dias_punta int4 NULL,
	horas_punta int4 NULL,
	factor_calif varchar(50) NULL,
	cargo_fijo numeric(18, 2) NULL,
	mantenimiento numeric(18, 2) NULL,
	alumbrado numeric(18, 2) NULL,
	recup_energia numeric(18, 2) NULL,
	mora numeric(18, 2) NULL,
	reconexion numeric(18, 2) NULL,
	ajuste_tarifa numeric(18, 2) NULL,
	dist_factura numeric(18, 2) NULL,
	ajuste_alumb numeric(18, 2) NULL,
	otros_afectos numeric(18, 2) NULL,
	base_imponible numeric(18, 2) NULL,
	igv numeric(18, 2) NULL,
	tot_periodo numeric(18, 2) NULL,
	electrif_rural numeric(18, 2) NULL,
	comp_distribucion numeric(18, 2) NULL,
	comp_generadora numeric(18, 2) NULL,
	comp_interrup numeric(18, 2) NULL,
	comp_calidad numeric(18, 2) NULL,
	comp_frec_ant numeric(18, 2) NULL,
	comp_frec_des numeric(18, 2) NULL,
	comp_serv numeric(18, 2) NULL,
	comp_norma_tec numeric(18, 2) NULL,
	comp_deuda_ant numeric(18, 2) NULL,
	comp_deuda_meses int4 NULL,
	comp_dev_reclamo numeric(18, 2) NULL,
	comp_nota_deb_cred numeric(18, 2) NULL,
	comp_aporte_reemb numeric(18, 2) NULL,
	comp_otros_inafectos numeric(18, 2) NULL,
	comp_redondeo_act_pos numeric(18, 2) NULL,
	comp_redondeo_act_neg numeric(18, 2) NULL,
	costo_medio numeric(18, 2) NULL,
	total_a_pagar numeric(18, 2) NULL,
	valor_venta numeric(18, 2) NULL,
	deuda_anterior numeric(18, 2) NULL,
	devolucion numeric(18, 2) NULL,
	fecha_liquidacion date NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL,
	CONSTRAINT web_hm_indra_energia_pkey PRIMARY KEY (num_recibo)
);



---------



CREATE OR REPLACE PROCEDURE ods.sp_cargar_fs_hm_base_de_sitios()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio    timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp     integer      := 'ods.sp_cargar_fs_hm_base_de_sitios()'::regprocedure::oid::int;
  v_sp_name   text         := 'ods.sp_cargar_fs_hm_base_de_sitios()'::regprocedure::text;

  v_inserted  integer := 0;
  v_updated   integer := 0;
  v_deleted   integer := 0;
  v_nulls     integer := NULL;

  v_estado    varchar(50);
  v_msj       text;
BEGIN
  /*
    Flujo:
      1) Contar filas actuales en ODS y TRUNCATE (full refresh).
      2) Limpiar RAW (raw_clean) sin colapsar ni filtrar cu.
      3) Insertar TODO raw_clean -> ODS.
      4) Log.
  */

  -- 1) Contamos antes de truncar para reportar cuántas se eliminaron
  SELECT COUNT(*) INTO v_deleted FROM ods.fs_hm_base_de_sitios;

  -- IMPORTANTE:
  --  - Si hay FKs a ods.fs_hm_base_de_sitios, usar: TRUNCATE TABLE ods.fs_hm_base_de_sitios CASCADE;
  --  - Si necesitas reiniciar identidades: TRUNCATE TABLE ods.fs_hm_base_de_sitios RESTART IDENTITY;
  TRUNCATE TABLE ods.fs_hm_base_de_sitios;

  WITH
  raw_clean AS (
    SELECT
      TRIM(r.codigo_unico)                                   AS cu,           -- NO se filtra; conserva nulos/vacíos si vienen así
      LEFT(NULLIF(TRIM(r.nombre_local),''), 200)             AS nombre_local,
      LEFT(NULLIF(TRIM(r.direccion),''), 350)                AS direccion,

      -- Lat/Lon solo decimales (con coma o punto). Si no cumple patrón → NULL
      CASE
        WHEN TRIM(r.latitud)  ~ '^\s*[+-]?\d+(?:[.,]\d+)?\s*$'
          THEN REPLACE(TRIM(r.latitud), ',', '.')::numeric(11,8)
        ELSE NULL
      END                                                    AS latitud,
      CASE
        WHEN TRIM(r.longitud) ~ '^\s*[+-]?\d+(?:[.,]\d+)?\s*$'
          THEN REPLACE(TRIM(r.longitud), ',', '.')::numeric(11,8)
        ELSE NULL
      END                                                    AS longitud,

      LEFT(NULLIF(TRIM(r.ubigeo),''), 10)                    AS ubigeo,
      LEFT(NULLIF(TRIM(r.departamento),''), 120)             AS departamento,
      LEFT(NULLIF(TRIM(r.provincia),''), 120)                AS provincia,
      LEFT(NULLIF(TRIM(r.distrito),''), 120)                 AS distrito,
      LEFT(NULLIF(TRIM(r.tipo_local),''), 120)               AS tipo_local,
      LEFT(NULLIF(TRIM(r.proveedor_flm),''), 150)            AS proveedor_flm,
      LEFT(NULLIF(TRIM(r.atencion),''), 120)                 AS atencion,
      LEFT(NULLIF(TRIM(r.zona),''), 120)                     AS zona,
      LEFT(NULLIF(TRIM(r.tipo_zona_flm),''), 120)            AS tipo_zona_flm,
      LEFT(NULLIF(TRIM(r.propietario_de_torre),''), 150)     AS propietario_de_torre,
      LEFT(NULLIF(TRIM(r.propietario_de_piso),''), 150)      AS propietario_de_piso,
      LEFT(NULLIF(TRIM(r.tipo_estacion),''), 120)            AS tipo_estacion,
      LEFT(NULLIF(TRIM(r.tipo_torre),''), 120)               AS tipo_torre,
      LEFT(NULLIF(TRIM(r.clasificacion_instalacion),''),150) AS clasificacion_instalacion,
      CASE
        WHEN NULLIF(TRIM(r.fecha_puesta_en_servicio),'') IS NULL THEN NULL
        WHEN r.fecha_puesta_en_servicio ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_puesta_en_servicio::date
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD/MM/YYYY')
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD-MM-YYYY')
        ELSE NULL
      END                                                    AS fecha_puesta_en_servicio,
      LEFT(NULLIF(TRIM(r.bucket),''), 80)                    AS bucket,
      LEFT(NULLIF(TRIM(r.sla),''), 80)                       AS sla,
      LEFT(NULLIF(TRIM(r.tipo_vip),''), 80)                  AS tipo_vip,
      LEFT(NULLIF(TRIM(r.criticidad_local),''), 80)          AS criticidad_local,
      LEFT(NULLIF(TRIM(r.observacion),''), 500)              AS observacion,
      LEFT(NULLIF(TRIM(r.priorizacion),''), 80)              AS priorizacion,
      LEFT(NULLIF(TRIM(r.ubigeotoa),''), 120)                AS ubigeotoa
    FROM raw.fs_mm_base_de_sitios r
  ),
  ins AS (
    INSERT INTO ods.fs_hm_base_de_sitios (
      codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, ubigeotoa
    )
    SELECT
      cu AS codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, ubigeotoa
    FROM raw_clean
    RETURNING 1
  )
  SELECT COALESCE((SELECT COUNT(*) FROM ins), 0)
  INTO v_inserted;

  v_estado := 'DONE';
  v_msj := format('Full refresh fs_hm_base_de_sitios: truncated=%s, inserted=%s', v_deleted, v_inserted);

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,   -- 0
    p_deleted    => v_deleted,   -- filas eliminadas por el TRUNCATE
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;
-------------

CREATE OR REPLACE PROCEDURE ods.sp_cargar_fs_hm_bitacora_base_sitios()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio    timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp     integer      := 'ods.sp_cargar_fs_hm_bitacora_base_sitios()'::regprocedure::oid::int;
  v_sp_name   text         := 'ods.sp_cargar_fs_hm_bitacora_base_sitios()'::regprocedure::text;

  v_inserted  integer := 0;
  v_updated   integer := 0;
  v_deleted   integer := 0;
  v_nulls     integer := NULL;

  v_estado    varchar(50);
  v_msj       text;
BEGIN
  /* 1) Contamos filas actuales y truncamos destino (full refresh) */
  SELECT COUNT(*) INTO v_deleted FROM ods.fs_hm_bitacora_base_sitios;
  TRUNCATE TABLE ods.fs_hm_bitacora_base_sitios;
  -- Opcional: TRUNCATE TABLE ods.fs_hm_bitacora_base_sitios RESTART IDENTITY;

  WITH
  raw_clean AS (
    SELECT
      NULLIF(TRIM(r.codigo_unico),'')                          AS cu,
      LEFT(NULLIF(TRIM(r.nombre_local),''), 200)               AS nombre_local,
      LEFT(NULLIF(TRIM(r.direccion),''), 350)                  AS direccion,

      /* ===== LATITUD ===== */
      (
        CASE
          -- Decimal
          WHEN TRIM(r.latitud) ~* '^\s*[+-]?\d+(?:[.,]\d+)?\s*[NSEWO]?\s*$' THEN
            ( NULLIF(REPLACE(TRIM(regexp_replace(r.latitud, '[^0-9\+\-.,]', '', 'g')), ',', '.'), '')::numeric )
            * CASE WHEN TRIM(r.latitud) ~* '[SWO]' THEN -1 ELSE 1 END

          -- DMS
          WHEN TRIM(r.latitud) ~* '^\s*\d+(?:\s*[°º]\s*\d+)?(?:\s*[''’′m]\s*\d+(?:[.,]\d+)?)?(?:\s*["”″s])?\s*[NSEWO]?\s*$' THEN
            (
              COALESCE((regexp_match(TRIM(r.latitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[1], '0')::numeric
              + COALESCE((regexp_match(TRIM(r.latitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[2], '0')::numeric / 60
              + COALESCE(REPLACE(COALESCE((regexp_match(TRIM(r.latitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[3], '0'), ',', '.')::numeric, 0) / 3600
            ) * CASE
                  WHEN COALESCE((regexp_match(TRIM(r.latitud),
                    '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
                  ))[4], 'N') ~* '^[SWO]$' THEN -1 ELSE 1
                END
          ELSE NULL
        END
      )::numeric(11,8) AS latitud,

      /* ===== LONGITUD ===== */
      (
        CASE
          -- Decimal
          WHEN TRIM(r.longitud) ~* '^\s*[+-]?\d+(?:[.,]\d+)?\s*[NSEWO]?\s*$' THEN
            ( NULLIF(REPLACE(TRIM(regexp_replace(r.longitud, '[^0-9\+\-.,]', '', 'g')), ',', '.'), '')::numeric )
            * CASE WHEN TRIM(r.longitud) ~* '[SWO]' THEN -1 ELSE 1 END

          -- DMS (paréntesis balanceados)
          WHEN TRIM(r.longitud) ~* '^\s*\d+(?:\s*[°º]\s*\d+)?(?:\s*[''’′m]\s*\d+(?:[.,]\d+)?)?(?:\s*["”″s])?\s*[NSEWO]?\s*$' THEN
            (
              COALESCE((regexp_match(TRIM(r.longitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[1], '0')::numeric
              + COALESCE((regexp_match(TRIM(r.longitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[2], '0')::numeric / 60
              + COALESCE(REPLACE(COALESCE((regexp_match(TRIM(r.longitud),
                '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
              ))[3], '0'), ',', '.')::numeric, 0) / 3600
            ) * CASE
                  WHEN COALESCE((regexp_match(TRIM(r.longitud),
                    '^\s*(\d+)(?:\s*[°º]\s*(\d+))?(?:\s*[''’′m]\s*(\d+(?:[.,]\d+)?))?(?:\s*["”″s])?\s*([NnSsEeWwOo])?\s*$'
                  ))[4], 'E') ~* '^[SWO]$' THEN -1 ELSE 1
                END
          ELSE NULL
        END
      )::numeric(11,8) AS longitud,

      LEFT(NULLIF(TRIM(r.ubigeo),''), 10)                      AS ubigeo,
      LEFT(NULLIF(TRIM(r.departamento),''), 120)               AS departamento,
      LEFT(NULLIF(TRIM(r.provincia),''), 120)                  AS provincia,
      LEFT(NULLIF(TRIM(r.distrito),''), 120)                   AS distrito,
      LEFT(NULLIF(TRIM(r.tipo_local),''), 120)                 AS tipo_local,
      LEFT(NULLIF(TRIM(r.proveedor_flm),''), 150)              AS proveedor_flm,
      LEFT(NULLIF(TRIM(r.atencion),''), 120)                   AS atencion,
      LEFT(NULLIF(TRIM(r.zona),''), 120)                       AS zona,
      LEFT(NULLIF(TRIM(r.tipo_zona_flm),''), 120)              AS tipo_zona_flm,
      LEFT(NULLIF(TRIM(r.propietario_de_torre),''), 150)       AS propietario_de_torre,
      LEFT(NULLIF(TRIM(r.propietario_de_piso),''), 150)        AS propietario_de_piso,
      LEFT(NULLIF(TRIM(r.tipo_estacion),''), 120)              AS tipo_estacion,
      LEFT(NULLIF(TRIM(r.tipo_torre),''), 120)                 AS tipo_torre,
      LEFT(NULLIF(TRIM(r.clasificacion_instalacion),''), 150)  AS clasificacion_instalacion,
      CASE
        WHEN NULLIF(TRIM(r.fecha_puesta_en_servicio),'') IS NULL THEN NULL
        WHEN r.fecha_puesta_en_servicio ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_puesta_en_servicio::date
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD/MM/YYYY')
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD-MM-YYYY')
        ELSE NULL
      END                                                      AS fecha_puesta_en_servicio,
      LEFT(NULLIF(TRIM(r.bucket),''), 80)                      AS bucket,
      LEFT(NULLIF(TRIM(r.sla),''), 80)                         AS sla,
      LEFT(NULLIF(TRIM(r.tipo_vip),''), 80)                    AS tipo_vip,
      LEFT(NULLIF(TRIM(r.criticidad_local),''), 80)            AS criticidad_local,
      LEFT(NULLIF(TRIM(r.observacion),''), 500)                AS observacion,
      LEFT(NULLIF(TRIM(r.priorizacion),''), 80)                AS priorizacion,
      LEFT(NULLIF(TRIM(r.accion),''), 15)                      AS accion,
      LEFT(NULLIF(TRIM(r.solicitado_por),''), 120)             AS solicitado_por,
      COALESCE(LEFT(TRIM(r.base), 6), '')::char(6)             AS base,
      LEFT(NULLIF(TRIM(r.campo_modificado),''), 150)           AS campo_modificado,
      LEFT(NULLIF(TRIM(r.observaciones),''), 450)              AS observaciones,
      LEFT(NULLIF(TRIM(r.estado),''), 20)                      AS estado,

      -- auxiliar para orden por fecha (ya no se usa para DISTINCT, pero se mantiene por consistencia)
      CASE
        WHEN NULLIF(TRIM(r.fecha_puesta_en_servicio),'') IS NULL THEN NULL
        WHEN r.fecha_puesta_en_servicio ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_puesta_en_servicio::date
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD/MM/YYYY')
        WHEN r.fecha_puesta_en_servicio ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_puesta_en_servicio,'DD-MM-YYYY')
        ELSE NULL
      END                                                      AS _ord_fecha
    FROM raw.fs_mm_bitacora_base_sitios r
  ),
  -- 2) Ya no hay DISTINCT ON: insertamos TODO
  ins AS (
    INSERT INTO ods.fs_hm_bitacora_base_sitios (
      codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, accion, solicitado_por, base,
      campo_modificado, observaciones, estado
    )
    SELECT
      cu AS codigo_unico, nombre_local, direccion, latitud, longitud, ubigeo,
      departamento, provincia, distrito, tipo_local, proveedor_flm, atencion,
      zona, tipo_zona_flm, propietario_de_torre, propietario_de_piso,
      tipo_estacion, tipo_torre, clasificacion_instalacion,
      fecha_puesta_en_servicio, bucket, sla, tipo_vip, criticidad_local,
      observacion, priorizacion, accion, solicitado_por, base,
      campo_modificado, observaciones, estado
    FROM raw_clean
    RETURNING 1
  )
  SELECT COALESCE((SELECT COUNT(*) FROM ins), 0)
  INTO v_inserted;

  v_estado := 'DONE';
  v_msj := format('Insert fs_hm_bitacora_base_sitios: inserted=%s, deleted=%s', v_inserted, v_deleted);

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,
    p_deleted    => v_deleted,
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;
---------------------
CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_clientes_libres()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_sftp_hm_clientes_libres()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_sftp_hm_clientes_libres()'::regprocedure::text;

  v_inserted      integer := 0;
  v_updated       integer := 0;
  v_deleted       integer := 0;  -- acá colocaremos los duplicados borrados del RAW
  v_nulls         integer := NULL;

  -- métricas de duplicados (como en el web_hm_indra_energia)
  v_ins_err_dup   integer := 0;  -- duplicados insertados a error_energia
  v_del_dup_raw   integer := 0;  -- duplicados borrados de RAW

  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ===================== 1) DUPLICADOS (num_recibo, per_consumo) ===================== */
  WITH claves_dup AS (
    SELECT num_recibo, per_consumo
    FROM raw.sftp_mm_clientes_libres
    GROUP BY num_recibo, per_consumo
    HAVING COUNT(*) > 1
  ),
  cand_dups AS (
    SELECT r.*
    FROM raw.sftp_mm_clientes_libres r
    JOIN claves_dup d
      ON d.num_recibo = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_clientes_libres'
  FROM cand_dups r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_clientes_libres'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_ins_err_dup = ROW_COUNT;

  WITH claves_dup AS (
    SELECT num_recibo, per_consumo
    FROM raw.sftp_mm_clientes_libres
    GROUP BY num_recibo, per_consumo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_clientes_libres r
    JOIN claves_dup d
      ON d.num_recibo = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  DELETE FROM raw.sftp_mm_clientes_libres r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  GET DIAGNOSTICS v_del_dup_raw = ROW_COUNT;

  /* ===================== 2) UPSERT desde RAW -> ODS (respeta tipos) ===================== */
  WITH
  stg AS (
    SELECT
      NULLIF(btrim(r.num_recibo),'')::bigint                                       AS num_recibo,

      /* cod_suministro como VARCHAR(250) */
      CASE
        WHEN r.cod_suministro IS NULL
          OR btrim(r.cod_suministro) = ''
          OR lower(btrim(r.cod_suministro)) IN ('nan','null')
        THEN NULL
        ELSE left(btrim(r.cod_suministro), 250)
      END::varchar(250)                                                            AS cod_suministro,

      left(NULLIF(btrim(r.tarifa),''),10)                                          AS tarifa,

      /* pot_contr como texto (varchar 255) */
      left(NULLIF(btrim(r.pot_contr),''),255)::varchar(255)                        AS pot_contr,

      NULLIF(btrim(r.titularidad),'')                                              AS titularidad,
      NULLIF(btrim(r.distribuidor),'')                                             AS distribuidor,

      CASE
        WHEN NULLIF(btrim(r.fec_emision),'') IS NULL THEN NULL
        WHEN r.fec_emision ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_emision::date
        WHEN r.fec_emision ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_emision,'DD/MM/YYYY')
        WHEN r.fec_emision ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_emision,'DD-MM-YYYY')
        ELSE NULL
      END                                                                           AS fec_emision,
      CASE
        WHEN NULLIF(btrim(r.fec_vencimiento),'') IS NULL THEN NULL
        WHEN r.fec_vencimiento ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_vencimiento::date
        WHEN r.fec_vencimiento ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_vencimiento,'DD/MM/YYYY')
        WHEN r.fec_vencimiento ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_vencimiento,'DD-MM-YYYY')
        ELSE NULL
      END                                                                           AS fec_vencimiento,
      CASE
        WHEN NULLIF(btrim(r.fec_lect_actual),'') IS NULL THEN NULL
        WHEN r.fec_lect_actual ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_lect_actual::date
        WHEN r.fec_lect_actual ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_lect_actual,'DD/MM/YYYY')
        WHEN r.fec_lect_actual ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_lect_actual,'DD-MM-YYYY')
        ELSE NULL
      END                                                                           AS fec_lect_actual,
      CASE
        WHEN NULLIF(btrim(r.fec_lect_anterior),'') IS NULL THEN NULL
        WHEN r.fec_lect_anterior ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fec_lect_anterior::date
        WHEN r.fec_lect_anterior ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fec_lect_anterior,'DD/MM/YYYY')
        WHEN r.fec_lect_anterior ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fec_lect_anterior,'DD-MM-YYYY')
        ELSE NULL
      END                                                                           AS fec_lect_anterior,

      left(NULLIF(btrim(r.per_consumo),''),50)                                      AS per_consumo,

      NULLIF(replace(btrim(r.ea_lec_act_hp),',','.'),'')::numeric(18,2)            AS ea_lec_act_hp,
      NULLIF(replace(btrim(r.ea_lec_act_fp),',','.'),'')::numeric(18,2)            AS ea_lec_act_fp,
      NULLIF(replace(btrim(r.ea_lec_act_tot),',','.'),'')::numeric(18,2)           AS ea_lec_act_tot,
      NULLIF(replace(btrim(r.ea_lec_ant_hp),',','.'),'')::numeric(18,2)            AS ea_lec_ant_hp,
      NULLIF(replace(btrim(r.ea_lec_ant_fp),',','.'),'')::numeric(18,2)            AS ea_lec_ant_fp,
      NULLIF(replace(btrim(r.ea_lec_ant_tot),',','.'),'')::numeric(18,2)           AS ea_lec_ant_tot,
      NULLIF(replace(btrim(r.ea_consumo_hp),',','.'),'')::numeric(18,2)            AS ea_consumo_hp,
      NULLIF(replace(btrim(r.ea_consumo_fp),',','.'),'')::numeric(18,2)            AS ea_consumo_fp,
      NULLIF(replace(btrim(r.ea_consumo_tot),',','.'),'')::numeric(18,2)           AS ea_consumo_tot,
      NULLIF(replace(btrim(r.ea_pu_hp),',','.'),'')::numeric(18,6)                 AS ea_pu_hp,
      NULLIF(replace(btrim(r.ea_pu_fp),',','.'),'')::numeric(18,6)                 AS ea_pu_fp,
      NULLIF(replace(btrim(r.ea_prec_unit_tot),',','.'),'')::numeric(18,6)         AS ea_prec_unit_tot,
      NULLIF(replace(btrim(r.ea_importe_hp),',','.'),'')::numeric(18,2)            AS ea_importe_hp,
      NULLIF(replace(btrim(r.ea_importe_fp),',','.'),'')::numeric(18,2)            AS ea_importe_fp,
      NULLIF(replace(btrim(r.ea_importe_tot),',','.'),'')::numeric(18,2)           AS ea_importe_tot,

      NULLIF(replace(btrim(r.pot_lect_act_hp),',','.'),'')::numeric(18,2)          AS pot_lect_act_hp,
      NULLIF(replace(btrim(r.pot_lect_act_fp),',','.'),'')::numeric(18,2)          AS pot_lect_act_fp,
      NULLIF(replace(btrim(r.pot_lect_ant_hp),',','.'),'')::numeric(18,2)          AS pot_lect_ant_hp,
      NULLIF(replace(btrim(r.pot_lect_ant_fp),',','.'),'')::numeric(18,2)          AS pot_lect_ant_fp,
      NULLIF(replace(btrim(r.pot_reg_hp),',','.'),'')::numeric(18,2)               AS pot_reg_hp,
      NULLIF(replace(btrim(r.pot_reg_fp),',','.'),'')::numeric(18,2)               AS pot_reg_fp,
      NULLIF(replace(btrim(r.pot_gen_fact),',','.'),'')::numeric(18,2)             AS pot_gen_fact,
      NULLIF(replace(btrim(r.pot_gen_pu),',','.'),'')::numeric(18,6)               AS pot_gen_pu,
      NULLIF(replace(btrim(r.pot_gen_importe),',','.'),'')::numeric(18,2)          AS pot_gen_importe,
      NULLIF(replace(btrim(r.pot_dist_fact),',','.'),'')::numeric(18,2)            AS pot_dist_fact,
      NULLIF(replace(btrim(r.pot_dist_pu),',','.'),'')::numeric(18,6)              AS pot_dist_pu,
      NULLIF(replace(btrim(r.pot_dist_importe),',','.'),'')::numeric(18,2)         AS pot_dist_importe,
      NULLIF(replace(btrim(r.pot_bt6_pu),',','.'),'')::numeric(18,6)               AS pot_bt6_pu,
      NULLIF(replace(btrim(r.pot_bt6_monto),',','.'),'')::numeric(18,2)            AS pot_bt6_monto,

      NULLIF(replace(btrim(r.er_lec_act),',','.'),'')::numeric(18,2)               AS er_lec_act,
      NULLIF(replace(btrim(r.er_lec_ant),',','.'),'')::numeric(18,2)               AS er_lec_ant,
      NULLIF(replace(btrim(r.er_cons),',','.'),'')::numeric(18,2)                  AS er_cons,
      NULLIF(replace(btrim(r.er_fact),',','.'),'')::numeric(18,2)                  AS er_fact,
      NULLIF(replace(btrim(r.er_pu),',','.'),'')::numeric(18,6)                    AS er_pu,
      NULLIF(replace(btrim(r.er_importe),',','.'),'')::numeric(18,2)               AS er_importe,

      left(NULLIF(btrim(r.calif_cliente),''),100)                                  AS calif_cliente,
      CASE WHEN NULLIF(btrim(r.dias_punta),'')  IS NULL THEN NULL
           ELSE NULLIF(btrim(r.dias_punta),'')::int END                            AS dias_punta,
      CASE WHEN NULLIF(btrim(r.horas_punta),'') IS NULL THEN NULL
           ELSE NULLIF(btrim(r.horas_punta),'')::int END                           AS horas_punta,
      left(NULLIF(btrim(r.factor_calif),''),50)                                    AS factor_calif,

      NULLIF(replace(btrim(r.cargo_fijo),',','.'),'')::numeric(18,2)               AS cargo_fijo,
      NULLIF(replace(btrim(r.mantenimiento),',','.'),'')::numeric(18,2)            AS mantenimiento,
      NULLIF(replace(btrim(r.alumbrado),',','.'),'')::numeric(18,2)                AS alumbrado,
      NULLIF(replace(btrim(r.recup_energia),',','.'),'')::numeric(18,2)            AS recup_energia,
      NULLIF(replace(btrim(r.mora),',','.'),'')::numeric(18,2)                     AS mora,
      NULLIF(replace(btrim(r.reconexion),',','.'),'')::numeric(18,2)               AS reconexion,
      NULLIF(replace(btrim(r.ajuste_tarifa),',','.'),'')::numeric(18,2)            AS ajuste_tarifa,
      NULLIF(replace(btrim(r.dist_factura),',','.'),'')::numeric(18,2)             AS dist_factura,
      NULLIF(replace(btrim(r.ajuste_alumb),',','.'),'')::numeric(18,2)             AS ajuste_alumb,
      NULLIF(replace(btrim(r.otros_afectos),',','.'),'')::numeric(18,2)            AS otros_afectos,
      NULLIF(replace(btrim(r.base_imponible),',','.'),'')::numeric(18,2)           AS base_imponible,
      NULLIF(replace(btrim(r.igv),',','.'),'')::numeric(18,2)                      AS igv,
      NULLIF(replace(btrim(r.tot_periodo),',','.'),'')::numeric(18,2)              AS tot_periodo,
      NULLIF(replace(btrim(r.electrif_rural),',','.'),'')::numeric(18,2)           AS electrif_rural,

      NULLIF(replace(btrim(r.comp_distribucion),',','.'),'')::numeric(18,2)        AS comp_distribucion,
      NULLIF(replace(btrim(r.comp_generadora),',','.'),'')::numeric(18,2)          AS comp_generadora,
      NULLIF(replace(btrim(r.comp_interrup),',','.'),'')::numeric(18,2)            AS comp_interrup,
      NULLIF(replace(btrim(r.comp_calidad),',','.'),'')::numeric(18,2)             AS comp_calidad,
      NULLIF(replace(btrim(r.comp_frec_ant),',','.'),'')::numeric(18,2)            AS comp_frec_ant,
      NULLIF(replace(btrim(r.comp_frec_des),',','.'),'')::numeric(18,2)            AS comp_frec_des,
      NULLIF(replace(btrim(r.comp_serv),',','.'),'')::numeric(18,2)                AS comp_serv,
      NULLIF(replace(btrim(r.comp_norma_tec),',','.'),'')::numeric(18,2)           AS comp_norma_tec,
      NULLIF(replace(btrim(r.comp_deuda_ant),',','.'),'')::numeric(18,2)           AS comp_deuda_ant,
      CASE WHEN NULLIF(btrim(r.comp_deuda_meses),'') IS NULL THEN NULL
           ELSE NULLIF(btrim(r.comp_deuda_meses),'')::int END                      AS comp_deuda_meses,
      NULLIF(replace(btrim(r.comp_dev_reclamo),',','.'),'')::numeric(18,2)         AS comp_dev_reclamo,
      NULLIF(replace(btrim(r.comp_nota_deb_cred),',','.'),'')::numeric(18,2)       AS comp_nota_deb_cred,
      NULLIF(replace(btrim(r.comp_aporte_reemb),',','.'),'')::numeric(18,2)        AS comp_aporte_reemb,
      NULLIF(replace(btrim(r.comp_otros_inafectos),',','.'),'')::numeric(18,2)     AS comp_otros_inafectos,
      NULLIF(replace(btrim(r.comp_redondeo_act_pos),',','.'),'')::numeric(18,2)    AS comp_redondeo_act_pos,
      NULLIF(replace(btrim(r.comp_redondeo_act_neg),',','.'),'')::numeric(18,2)    AS comp_redondeo_act_neg,

      NULLIF(replace(btrim(r.costo_medio),',','.'),'')::numeric(18,2)              AS costo_medio,
      NULLIF(replace(btrim(r.total_a_pagar),',','.'),'')::numeric(18,2)            AS total_a_pagar,
      NULLIF(replace(btrim(r.valor_venta),',','.'),'')::numeric(18,2)              AS valor_venta,
      NULLIF(replace(btrim(r.deuda_anterior),',','.'),'')::numeric(18,2)           AS deuda_anterior,
      NULLIF(replace(btrim(r.devolucion),',','.'),'')::numeric(18,2)               AS devolucion,

      CASE
        WHEN NULLIF(btrim(r.fecha_liquidacion),'') IS NULL THEN NULL
        WHEN r.fecha_liquidacion ~ '^\d{4}-\d{2}-\d{2}$' THEN r.fecha_liquidacion::date
        WHEN r.fecha_liquidacion ~ '^\d{2}/\d{2}/\d{4}$' THEN to_date(r.fecha_liquidacion,'DD/MM/YYYY')
        WHEN r.fecha_liquidacion ~ '^\d{2}-\d{2}-\d{4}$' THEN to_date(r.fecha_liquidacion,'DD-MM-YYYY')
        ELSE NULL
      END                                                                           AS fecha_liquidacion
    FROM raw.sftp_mm_clientes_libres r
    WHERE NULLIF(btrim(r.num_recibo),'') IS NOT NULL
      AND NULLIF(btrim(r.per_consumo),'') IS NOT NULL
  ),
  upd AS (
    UPDATE ods.sftp_hm_clientes_libres t
    SET
      cod_suministro        = s.cod_suministro,
      tarifa                = s.tarifa,
      pot_contr             = s.pot_contr,
      titularidad           = s.titularidad,
      distribuidor          = s.distribuidor,
      fec_emision           = s.fec_emision,
      fec_vencimiento       = s.fec_vencimiento,
      fec_lect_actual       = s.fec_lect_actual,
      fec_lect_anterior     = s.fec_lect_anterior,
      per_consumo           = s.per_consumo,
      ea_lec_act_hp         = s.ea_lec_act_hp,
      ea_lec_act_fp         = s.ea_lec_act_fp,
      ea_lec_act_tot        = s.ea_lec_act_tot,
      ea_lec_ant_hp         = s.ea_lec_ant_hp,
      ea_lec_ant_fp         = s.ea_lec_ant_fp,
      ea_lec_ant_tot        = s.ea_lec_ant_tot,
      ea_consumo_hp         = s.ea_consumo_hp,
      ea_consumo_fp         = s.ea_consumo_fp,
      ea_consumo_tot        = s.ea_consumo_tot,
      ea_pu_hp              = s.ea_pu_hp,
      ea_pu_fp              = s.ea_pu_fp,
      ea_prec_unit_tot      = s.ea_prec_unit_tot,
      ea_importe_hp         = s.ea_importe_hp,
      ea_importe_fp         = s.ea_importe_fp,
      ea_importe_tot        = s.ea_importe_tot,
      pot_lect_act_hp       = s.pot_lect_act_hp,
      pot_lect_act_fp       = s.pot_lect_act_fp,
      pot_lect_ant_hp       = s.pot_lect_ant_hp,
      pot_lect_ant_fp       = s.pot_lect_ant_fp,
      pot_reg_hp            = s.pot_reg_hp,
      pot_reg_fp            = s.pot_reg_fp,
      pot_gen_fact          = s.pot_gen_fact,
      pot_gen_pu            = s.pot_gen_pu,
      pot_gen_importe       = s.pot_gen_importe,
      pot_dist_fact         = s.pot_dist_fact,
      pot_dist_pu           = s.pot_dist_pu,
      pot_dist_importe      = s.pot_dist_importe,
      pot_bt6_pu            = s.pot_bt6_pu,
      pot_bt6_monto         = s.pot_bt6_monto,
      er_lec_act            = s.er_lec_act,
      er_lec_ant            = s.er_lec_ant,
      er_cons               = s.er_cons,
      er_fact               = s.er_fact,
      er_pu                 = s.er_pu,
      er_importe            = s.er_importe,
      calif_cliente         = s.calif_cliente,
      dias_punta            = s.dias_punta,
      horas_punta           = s.horas_punta,
      factor_calif          = s.factor_calif,
      cargo_fijo            = s.cargo_fijo,
      mantenimiento         = s.mantenimiento,
      alumbrado             = s.alumbrado,
      recup_energia         = s.recup_energia,
      mora                  = s.mora,
      reconexion            = s.reconexion,
      ajuste_tarifa         = s.ajuste_tarifa,
      dist_factura          = s.dist_factura,
      ajuste_alumb          = s.ajuste_alumb,
      otros_afectos         = s.otros_afectos,
      base_imponible        = s.base_imponible,
      igv                   = s.igv,
      tot_periodo           = s.tot_periodo,
      electrif_rural        = s.electrif_rural,
      comp_distribucion     = s.comp_distribucion,
      comp_generadora       = s.comp_generadora,
      comp_interrup         = s.comp_interrup,
      comp_calidad          = s.comp_calidad,
      comp_frec_ant         = s.comp_frec_ant,
      comp_frec_des         = s.comp_frec_des,
      comp_serv             = s.comp_serv,
      comp_norma_tec        = s.comp_norma_tec,
      comp_deuda_ant        = s.comp_deuda_ant,
      comp_deuda_meses      = s.comp_deuda_meses,
      comp_dev_reclamo      = s.comp_dev_reclamo,
      comp_nota_deb_cred    = s.comp_nota_deb_cred,
      comp_aporte_reemb     = s.comp_aporte_reemb,
      comp_otros_inafectos  = s.comp_otros_inafectos,
      comp_redondeo_act_pos = s.comp_redondeo_act_pos,
      comp_redondeo_act_neg = s.comp_redondeo_act_neg,
      costo_medio           = s.costo_medio,
      total_a_pagar         = s.total_a_pagar,
      valor_venta           = s.valor_venta,
      deuda_anterior        = s.deuda_anterior,
      devolucion            = s.devolucion,
      fecha_liquidacion     = s.fecha_liquidacion
    FROM stg s
    WHERE t.num_recibo = s.num_recibo
      AND t.per_consumo = s.per_consumo
      AND ROW(
        t.cod_suministro, t.tarifa, t.pot_contr, t.titularidad, t.distribuidor,
        t.fec_emision, t.fec_vencimiento, t.fec_lect_actual, t.fec_lect_anterior, t.per_consumo,
        t.ea_lec_act_hp, t.ea_lec_act_fp, t.ea_lec_act_tot, t.ea_lec_ant_hp, t.ea_lec_ant_fp, t.ea_lec_ant_tot,
        t.ea_consumo_hp, t.ea_consumo_fp, t.ea_consumo_tot, t.ea_pu_hp, t.ea_pu_fp, t.ea_prec_unit_tot,
        t.ea_importe_hp, t.ea_importe_fp, t.ea_importe_tot,
        t.pot_lect_act_hp, t.pot_lect_act_fp, t.pot_lect_ant_hp, t.pot_lect_ant_fp,
        t.pot_reg_hp, t.pot_reg_fp, t.pot_gen_fact, t.pot_gen_pu, t.pot_gen_importe,
        t.pot_dist_fact, t.pot_dist_pu, t.pot_dist_importe, t.pot_bt6_pu, t.pot_bt6_monto,
        t.er_lec_act, t.er_lec_ant, t.er_cons, t.er_fact, t.er_pu, t.er_importe,
        t.calif_cliente, t.dias_punta, t.horas_punta, t.factor_calif,
        t.cargo_fijo, t.mantenimiento, t.alumbrado, t.recup_energia, t.mora, t.reconexion,
        t.ajuste_tarifa, t.dist_factura, t.ajuste_alumb, t.otros_afectos, t.base_imponible, t.igv, t.tot_periodo,
        t.electrif_rural, t.comp_distribucion, t.comp_generadora, t.comp_interrup, t.comp_calidad,
        t.comp_frec_ant, t.comp_frec_des, t.comp_serv, t.comp_norma_tec, t.comp_deuda_ant, t.comp_deuda_meses,
        t.comp_dev_reclamo, t.comp_nota_deb_cred, t.comp_aporte_reemb, t.comp_otros_inafectos,
        t.comp_redondeo_act_pos, t.comp_redondeo_act_neg,
        t.costo_medio, t.total_a_pagar, t.valor_venta, t.deuda_anterior, t.devolucion,
        t.fecha_liquidacion
      ) IS DISTINCT FROM ROW(
        s.cod_suministro, s.tarifa, s.pot_contr, s.titularidad, s.distribuidor,
        s.fec_emision, s.fec_vencimiento, s.fec_lect_actual, s.fec_lect_anterior, s.per_consumo,
        s.ea_lec_act_hp, s.ea_lec_act_fp, s.ea_lec_act_tot, s.ea_lec_ant_hp, s.ea_lec_ant_fp, s.ea_lec_ant_tot,
        s.ea_consumo_hp, s.ea_consumo_fp, s.ea_consumo_tot, s.ea_pu_hp, s.ea_pu_fp, s.ea_prec_unit_tot,
        s.ea_importe_hp, s.ea_importe_fp, s.ea_importe_tot,
        s.pot_lect_act_hp, s.pot_lect_act_fp, s.pot_lect_ant_hp, s.pot_lect_ant_fp,
        s.pot_reg_hp, s.pot_reg_fp, s.pot_gen_fact, s.pot_gen_pu, s.pot_gen_importe,
        s.pot_dist_fact, s.pot_dist_pu, s.pot_dist_importe, s.pot_bt6_pu, s.pot_bt6_monto,
        s.er_lec_act, s.er_lec_ant, s.er_cons, s.er_fact, s.er_pu, s.er_importe,
        s.calif_cliente, s.dias_punta, s.horas_punta, s.factor_calif,
        s.cargo_fijo, s.mantenimiento, s.alumbrado, s.recup_energia, s.mora, s.reconexion,
        s.ajuste_tarifa, s.dist_factura, s.ajuste_alumb, s.otros_afectos, s.base_imponible, s.igv, s.tot_periodo,
        s.electrif_rural, s.comp_distribucion, s.comp_generadora, s.comp_interrup, s.comp_calidad,
        s.comp_frec_ant, s.comp_frec_des, s.comp_serv, s.comp_norma_tec, s.comp_deuda_ant, s.comp_deuda_meses,
        s.comp_dev_reclamo, s.comp_nota_deb_cred, s.comp_aporte_reemb, s.comp_otros_inafectos,
        s.comp_redondeo_act_pos, s.comp_redondeo_act_neg,
        s.costo_medio, s.total_a_pagar, s.valor_venta, s.deuda_anterior, s.devolucion,
        s.fecha_liquidacion
      )
    RETURNING 1
  ),
  ins AS (
    INSERT INTO ods.sftp_hm_clientes_libres (
      num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
      fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
      ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
      ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
      ea_importe_hp, ea_importe_fp, ea_importe_tot,
      pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp,
      pot_reg_hp, pot_reg_fp, pot_gen_fact, pot_gen_pu, pot_gen_importe,
      pot_dist_fact, pot_dist_pu, pot_dist_importe, pot_bt6_pu, pot_bt6_monto,
      er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
      calif_cliente, dias_punta, horas_punta, factor_calif,
      cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion,
      ajuste_tarifa, dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
      electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
      comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
      comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
      comp_redondeo_act_pos, comp_redondeo_act_neg,
      costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
    )
    SELECT
      s.num_recibo, s.cod_suministro, s.tarifa, s.pot_contr, s.titularidad, s.distribuidor,
      s.fec_emision, s.fec_vencimiento, s.fec_lect_actual, s.fec_lect_anterior, s.per_consumo,
      s.ea_lec_act_hp, s.ea_lec_act_fp, s.ea_lec_act_tot, s.ea_lec_ant_hp, s.ea_lec_ant_fp, s.ea_lec_ant_tot,
      s.ea_consumo_hp, s.ea_consumo_fp, s.ea_consumo_tot, s.ea_pu_hp, s.ea_pu_fp, s.ea_prec_unit_tot,
      s.ea_importe_hp, s.ea_importe_fp, s.ea_importe_tot,
      s.pot_lect_act_hp, s.pot_lect_act_fp, s.pot_lect_ant_hp, s.pot_lect_ant_fp,
      s.pot_reg_hp, s.pot_reg_fp, s.pot_gen_fact, s.pot_gen_pu, s.pot_gen_importe,
      s.pot_dist_fact, s.pot_dist_pu, s.pot_dist_importe, s.pot_bt6_pu, s.pot_bt6_monto,
      s.er_lec_act, s.er_lec_ant, s.er_cons, s.er_fact, s.er_pu, s.er_importe,
      s.calif_cliente, s.dias_punta, s.horas_punta, s.factor_calif,
      s.cargo_fijo, s.mantenimiento, s.alumbrado, s.recup_energia, s.mora, s.reconexion,
      s.ajuste_tarifa, s.dist_factura, s.ajuste_alumb, s.otros_afectos, s.base_imponible, s.igv, s.tot_periodo,
      s.electrif_rural, s.comp_distribucion, s.comp_generadora, s.comp_interrup, s.comp_calidad,
      s.comp_frec_ant, s.comp_frec_des, s.comp_serv, s.comp_norma_tec, s.comp_deuda_ant, s.comp_deuda_meses,
      s.comp_dev_reclamo, s.comp_nota_deb_cred, s.comp_aporte_reemb, s.comp_otros_inafectos,
      s.comp_redondeo_act_pos, s.comp_redondeo_act_neg,
      s.costo_medio, s.total_a_pagar, s.valor_venta, s.deuda_anterior, s.devolucion, s.fecha_liquidacion
    FROM stg s
    LEFT JOIN ods.sftp_hm_clientes_libres t
      ON t.num_recibo = s.num_recibo
     AND t.per_consumo = s.per_consumo
    WHERE t.num_recibo IS NULL
    RETURNING 1
  )
  SELECT
    COALESCE((SELECT count(*) FROM ins), 0),
    COALESCE((SELECT count(*) FROM upd), 0)
  INTO v_inserted, v_updated;

  -- contabiliza borrado de duplicados
  v_deleted := v_del_dup_raw;

  /* ===================== LOG ===================== */
  v_estado := 'DONE';
  v_msj := format(
    'UPSERT hm_clientes_libres (CTE): inserted=%s; updated=%s | Dups->error_energia=%s | Dups RAW borrados=%s | Origen=raw.sftp_mm_clientes_libres',
    v_inserted, v_updated, v_ins_err_dup, v_del_dup_raw
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,
    p_deleted    => v_deleted,
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

-------------------
-- DROP PROCEDURE ods.sp_cargar_sftp_hm_consumo_suministro_da();

CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_consumo_suministro_da()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_sftp_hm_consumo_suministro_da()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_sftp_hm_consumo_suministro_da()'::regprocedure::text;
  v_inserted      integer      := 0;
  v_err_invalid   integer      := 0;
  v_err_dups_pair integer      := 0;  -- duplicados por (num_recibo, per_consumo)
  v_err_nulos_nr  integer      := 0;  -- num_recibo nulo/vacío/'nan'/'null'
  v_err_total     integer      := 0;
  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ========= 1) INVÁLIDOS: num_recibo sin dígitos DESPUÉS del guion ========= */
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  ),
  cand_invalid AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_DA r
    JOIN invalid i ON i.rid = r.ctid
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_DA'
  FROM cand_invalid r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_DA'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_invalid = ROW_COUNT;

  -- Borro inválidos de RAW
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_DA r
  USING invalid i
  WHERE r.ctid = i.rid;

  /* ========= 1.b) NULOS / VACÍOS en num_recibo ========= */
  WITH nulos AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_DA'
  FROM nulos r
  LEFT JOIN public.error_energia e
         ON ( (e.num_recibo IS NULL AND r.num_recibo IS NULL) OR e.num_recibo = r.num_recibo )
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_DA'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.fecha_carga IS NULL;

  GET DIAGNOSTICS v_err_nulos_nr = ROW_COUNT;

  -- Borro NULOS/VACÍOS de RAW
  WITH rid_nulos AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_DA r
  USING rid_nulos x
  WHERE r.ctid = x.rid;

  /* ========= 1.c) DUPLICADOS EXACTOS por (num_recibo, per_consumo) ========= */
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_DA r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  cand_dups_pair AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_DA r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_DA'
  FROM cand_dups_pair r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_DA'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_dups_pair = ROW_COUNT;

  -- Borro duplicados por (num_recibo, per_consumo) de RAW
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_DA r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_DA r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_DA r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  -- Total de errores del día
  v_err_total := COALESCE(v_err_invalid,0) + COALESCE(v_err_dups_pair,0) + COALESCE(v_err_nulos_nr,0);

  /* ========= 2) TRANSFORMACIÓN + DEDUP + CARGA A ODS ========= */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      CASE
        WHEN r.num_recibo IS NULL OR btrim(r.num_recibo) = '' OR lower(btrim(r.num_recibo)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.num_recibo), 250)
      END AS num_recibo,

      /* ==== cod_suministro ahora VARCHAR(250) ==== */
      CASE
        WHEN r.cod_suministro IS NULL OR btrim(r.cod_suministro) = '' OR lower(btrim(r.cod_suministro)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.cod_suministro), 250)
      END::varchar(250) AS cod_suministro,

      NULLIF(NULLIF(btrim(r.tarifa), 'NaN'), '')::varchar(10) AS tarifa,

      /* ==== pot_contr ahora VARCHAR(255) ==== */
      NULLIF(NULLIF(btrim(r.pot_contr), 'NaN'), '')::varchar(255) AS pot_contr,

      NULLIF(NULLIF(btrim(r.titularidad),  'NaN'), '')::varchar(255) AS titularidad,
      NULLIF(NULLIF(btrim(r.distribuidor), 'NaN'), '')::varchar(255) AS distribuidor,

      CASE
        WHEN r.fec_emision IS NULL OR btrim(r.fec_emision) = '' OR lower(btrim(r.fec_emision)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_emision) > 0 THEN to_date(split_part(r.fec_emision,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_emision,' ',1), 'YYYY-MM-DD')
      END AS fec_emision,
      CASE
        WHEN r.fec_vencimiento IS NULL OR btrim(r.fec_vencimiento) = '' OR lower(btrim(r.fec_vencimiento)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_vencimiento) > 0 THEN to_date(split_part(r.fec_vencimiento,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_vencimiento,' ',1), 'YYYY-MM-DD')
      END AS fec_vencimiento,
      CASE
        WHEN r.fec_lect_actual IS NULL OR btrim(r.fec_lect_actual) = '' OR lower(btrim(r.fec_lect_actual)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_actual) > 0 THEN to_date(split_part(r.fec_lect_actual,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_actual,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_actual,
      CASE
        WHEN r.fec_lect_anterior IS NULL OR btrim(r.fec_lect_anterior) = '' OR lower(btrim(r.fec_lect_anterior)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_anterior) > 0 THEN to_date(split_part(r.fec_lect_anterior,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_anterior,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_anterior,

      NULLIF(NULLIF(btrim(r.per_consumo), 'NaN'), '')::varchar(50) AS per_consumo,

      public.try_numeric(r.ea_lec_act_hp)::numeric(18,2)  AS ea_lec_act_hp,
      public.try_numeric(r.ea_lec_act_fp)::numeric(18,2)  AS ea_lec_act_fp,
      public.try_numeric(r.ea_lec_act_tot)::numeric(18,2) AS ea_lec_act_tot,
      public.try_numeric(r.ea_lec_ant_hp)::numeric(18,2)  AS ea_lec_ant_hp,
      public.try_numeric(r.ea_lec_ant_fp)::numeric(18,2)  AS ea_lec_ant_fp,
      public.try_numeric(r.ea_lec_ant_tot)::numeric(18,2) AS ea_lec_ant_tot,
      public.try_numeric(r.ea_consumo_hp)::numeric(18,2)  AS ea_consumo_hp,
      public.try_numeric(r.ea_consumo_fp)::numeric(18,2)  AS ea_consumo_fp,
      public.try_numeric(r.ea_consumo_tot)::numeric(18,2) AS ea_consumo_tot,

      public.try_numeric(r.ea_pu_hp)::numeric(18,6)       AS ea_pu_hp,
      public.try_numeric(r.ea_pu_fp)::numeric(18,6)       AS ea_pu_fp,
      public.try_numeric(r.ea_prec_unit_tot)::numeric(18,6) AS ea_prec_unit_tot,

      public.try_numeric(r.ea_importe_hp)::numeric(18,2)  AS ea_importe_hp,
      public.try_numeric(r.ea_importe_fp)::numeric(18,2)  AS ea_importe_fp,
      public.try_numeric(r.ea_importe_tot)::numeric(18,2) AS ea_importe_tot,

      public.try_numeric(r.pot_lect_act_hp)::numeric(18,2)   AS pot_lect_act_hp,
      public.try_numeric(r.pot_lect_act_fp)::numeric(18,2)   AS pot_lect_act_fp,
      public.try_numeric(r.pot_lect_ant_hp)::numeric(18,2)   AS pot_lect_ant_hp,
      public.try_numeric(r.pot_lect_ant_fp)::numeric(18,2)   AS pot_lect_ant_fp,
      public.try_numeric(r.pot_reg_hp)::numeric(18,2)        AS pot_reg_hp,
      public.try_numeric(r.pot_reg_fp)::numeric(18,2)        AS pot_reg_fp,
      public.try_numeric(r.pot_gen_fact)::numeric(18,2)      AS pot_gen_fact,
      public.try_numeric(r.pot_gen_pu)::numeric(18,6)        AS pot_gen_pu,
      public.try_numeric(r.pot_gen_importe)::numeric(18,2)   AS pot_gen_importe,
      public.try_numeric(r.pot_dist_fact)::numeric(18,2)     AS pot_dist_fact,
      public.try_numeric(r.pot_dist_pu)::numeric(18,6)       AS pot_dist_pu,
      public.try_numeric(r.pot_dist_importe)::numeric(18,2)  AS pot_dist_importe,
      public.try_numeric(r.pot_bt6_pu)::numeric(18,6)        AS pot_bt6_pu,
      public.try_numeric(r.pot_bt6_monto)::numeric(18,2)     AS pot_bt6_monto,

      public.try_numeric(r.er_lec_act)::numeric(18,2)     AS er_lec_act,
      public.try_numeric(r.er_lec_ant)::numeric(18,2)     AS er_lec_ant,
      public.try_numeric(r.er_cons)::numeric(18,2)        AS er_cons,
      public.try_numeric(r.er_fact)::numeric(18,2)        AS er_fact,
      public.try_numeric(r.er_pu)::numeric(18,6)          AS er_pu,
      public.try_numeric(r.er_importe)::numeric(18,2)     AS er_importe,

      NULLIF(NULLIF(btrim(r.calif_cliente), 'NaN'), '')::varchar(100) AS calif_cliente,

      trunc(public.try_numeric(r.dias_punta))::int        AS dias_punta,
      trunc(public.try_numeric(r.horas_punta))::int       AS horas_punta,

      NULLIF(NULLIF(btrim(r.factor_calif), 'NaN'), '')::varchar(50) AS factor_calif,

      public.try_numeric(r.cargo_fijo)::numeric(18,2)        AS cargo_fijo,
      public.try_numeric(r.mantenimiento)::numeric(18,2)     AS mantenimiento,
      public.try_numeric(r.alumbrado)::numeric(18,2)         AS alumbrado,
      public.try_numeric(r.recup_energia)::numeric(18,2)     AS recup_energia,
      public.try_numeric(r.mora)::numeric(18,2)              AS mora,
      public.try_numeric(r.reconexion)::numeric(18,2)        AS reconexion,
      public.try_numeric(r.ajuste_tarifa)::numeric(18,2)     AS ajuste_tarifa,
      public.try_numeric(r.dist_factura)::numeric(18,2)      AS dist_factura,
      public.try_numeric(r.ajuste_alumb)::numeric(18,2)      AS ajuste_alumb,
      public.try_numeric(r.otros_afectos)::numeric(18,2)     AS otros_afectos,
      public.try_numeric(r.base_imponible)::numeric(18,2)    AS base_imponible,
      public.try_numeric(r.igv)::numeric(18,2)               AS igv,
      public.try_numeric(r.tot_periodo)::numeric(18,2)       AS tot_periodo,
      public.try_numeric(r.electrif_rural)::numeric(18,2)    AS electrif_rural,
      public.try_numeric(r.comp_distribucion)::numeric(18,2) AS comp_distribucion,
      public.try_numeric(r.comp_generadora)::numeric(18,2)   AS comp_generadora,
      public.try_numeric(r.comp_interrup)::numeric(18,2)     AS comp_interrup,
      public.try_numeric(r.comp_calidad)::numeric(18,2)      AS comp_calidad,
      public.try_numeric(r.comp_frec_ant)::numeric(18,2)     AS comp_frec_ant,
      public.try_numeric(r.comp_frec_des)::numeric(18,2)     AS comp_frec_des,
      public.try_numeric(r.comp_serv)::numeric(18,2)         AS comp_serv,
      public.try_numeric(r.comp_norma_tec)::numeric(18,2)    AS comp_norma_tec,
      public.try_numeric(r.comp_deuda_ant)::numeric(18,2)    AS comp_deuda_ant,

      trunc(public.try_numeric(r.comp_deuda_meses))::int     AS comp_deuda_meses,

      public.try_numeric(r.comp_dev_reclamo)::numeric(18,2)  AS comp_dev_reclamo,
      public.try_numeric(r.comp_nota_deb_cred)::numeric(18,2) AS comp_nota_deb_cred,
      public.try_numeric(r.comp_aporte_reemb)::numeric(18,2) AS comp_aporte_reemb,
      public.try_numeric(r.comp_otros_inafectos)::numeric(18,2) AS comp_otros_inafectos,
      public.try_numeric(r.comp_redondeo_act_pos)::numeric(18,2) AS comp_redondeo_act_pos,
      public.try_numeric(r.comp_redondeo_act_neg)::numeric(18,2) AS comp_redondeo_act_neg,

      public.try_numeric(r.costo_medio)::numeric(18,2)       AS costo_medio,
      public.try_numeric(r.total_a_pagar)::numeric(18,2)     AS total_a_pagar,
      public.try_numeric(r.valor_venta)::numeric(18,2)       AS valor_venta,
      public.try_numeric(r.deuda_anterior)::numeric(18,2)    AS deuda_anterior,
      public.try_numeric(r.devolucion)::numeric(18,2)        AS devolucion,

      CASE
        WHEN r.fecha_liquidacion IS NULL OR btrim(r.fecha_liquidacion) = '' OR lower(btrim(r.fecha_liquidacion)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_liquidacion) > 0 THEN to_date(split_part(r.fecha_liquidacion,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_liquidacion,' ',1), 'YYYY-MM-DD')
      END AS fecha_liquidacion
    FROM raw.sftp_mm_consumo_suministro_DA r
  ),
  dedup AS (
    SELECT DISTINCT ON (num_recibo) *
    FROM base
    WHERE num_recibo IS NOT NULL
    ORDER BY num_recibo, rid
  )
  INSERT INTO ods.sftp_hm_consumo_suministro (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
  )
  SELECT
    d.num_recibo, d.cod_suministro, d.tarifa, d.pot_contr, d.titularidad, d.distribuidor,
    d.fec_emision, d.fec_vencimiento, d.fec_lect_actual, d.fec_lect_anterior, d.per_consumo,
    d.ea_lec_act_hp, d.ea_lec_act_fp, d.ea_lec_act_tot, d.ea_lec_ant_hp, d.ea_lec_ant_fp, d.ea_lec_ant_tot,
    d.ea_consumo_hp, d.ea_consumo_fp, d.ea_consumo_tot, d.ea_pu_hp, d.ea_pu_fp, d.ea_prec_unit_tot,
    d.ea_importe_hp, d.ea_importe_fp, d.ea_importe_tot,
    d.pot_lect_act_hp, d.pot_lect_act_fp, d.pot_lect_ant_hp, d.pot_lect_ant_fp, d.pot_reg_hp, d.pot_reg_fp,
    d.pot_gen_fact, d.pot_gen_pu, d.pot_gen_importe, d.pot_dist_fact, d.pot_dist_pu, d.pot_dist_importe,
    d.pot_bt6_pu, d.pot_bt6_monto,
    d.er_lec_act, d.er_lec_ant, d.er_cons, d.er_fact, d.er_pu, d.er_importe,
    d.calif_cliente, d.dias_punta, d.horas_punta, d.factor_calif,
    d.cargo_fijo, d.mantenimiento, d.alumbrado, d.recup_energia, d.mora, d.reconexion, d.ajuste_tarifa,
    d.dist_factura, d.ajuste_alumb, d.otros_afectos, d.base_imponible, d.igv, d.tot_periodo,
    d.electrif_rural, d.comp_distribucion, d.comp_generadora, d.comp_interrup, d.comp_calidad,
    d.comp_frec_ant, d.comp_frec_des, d.comp_serv, d.comp_norma_tec, d.comp_deuda_ant, d.comp_deuda_meses,
    d.comp_dev_reclamo, d.comp_nota_deb_cred, d.comp_aporte_reemb, d.comp_otros_inafectos,
    d.comp_redondeo_act_pos, d.comp_redondeo_act_neg,
    d.costo_medio, d.total_a_pagar, d.valor_venta, d.deuda_anterior, d.devolucion, d.fecha_liquidacion
  FROM dedup d
  LEFT JOIN ods.sftp_hm_consumo_suministro o
    ON o.num_recibo = d.num_recibo
  WHERE o.num_recibo IS NULL;

  GET DIAGNOSTICS v_inserted = ROW_COUNT;

  v_estado := 'DONE';
  v_msj    := format(
    'Insertados en ODS: %s | Enviados NUEVOS a public.error_energia (hoy): %s (inválidos: %s, duplicados num_recibo+per_consumo: %s, num_recibo nulo/vacío: %s) | Origen: raw.sftp_mm_consumo_suministro_DA.',
    v_inserted, COALESCE(v_err_total,0), COALESCE(v_err_invalid,0), COALESCE(v_err_dups_pair,0), COALESCE(v_err_nulos_nr,0)
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => NULL::integer,
    p_deleted    => NULL::integer,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj    := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

-----------------------
-- DROP PROCEDURE ods.sp_cargar_sftp_hm_consumo_suministro_pd();

CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_consumo_suministro_pd()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_sftp_hm_consumo_suministro_pd()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_sftp_hm_consumo_suministro_pd()'::regprocedure::text;
  v_inserted      integer      := 0;
  v_err_invalid   integer      := 0;
  v_err_dups_pair integer      := 0;  -- duplicados por (num_recibo, per_consumo)
  v_err_nulos_nr  integer      := 0;  -- num_recibo nulo/vacío/'nan'/'null'
  v_err_total     integer      := 0;
  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ========= 1) INVÁLIDOS: num_recibo sin dígitos DESPUÉS del guion ========= */
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  ),
  cand_invalid AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_pd r
    JOIN invalid i ON i.rid = r.ctid
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_pd'
  FROM cand_invalid r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_invalid = ROW_COUNT;

  -- Borro inválidos de RAW
  WITH invalid AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NOT NULL
      AND btrim(r.num_recibo) <> ''
      AND substring(btrim(r.num_recibo) from '[-–—]\s*([0-9]+)') IS NULL
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_pd r
  USING invalid i
  WHERE r.ctid = i.rid;

  /* ========= 1.b) NULOS / VACÍOS en num_recibo ========= */
  WITH nulos AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_pd'
  FROM nulos r
  LEFT JOIN public.error_energia e
         ON ( (e.num_recibo IS NULL AND r.num_recibo IS NULL) OR e.num_recibo = r.num_recibo )
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.fecha_carga IS NULL;

  GET DIAGNOSTICS v_err_nulos_nr = ROW_COUNT;

  -- Borro NULOS/VACÍOS de RAW
  WITH rid_nulos AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    WHERE r.num_recibo IS NULL
       OR btrim(r.num_recibo) = ''
       OR lower(btrim(r.num_recibo)) IN ('nan','null')
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_pd r
  USING rid_nulos x
  WHERE r.ctid = x.rid;

  /* ========= 1.c) DUPLICADOS EXACTOS por (num_recibo, per_consumo) ========= */
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_pd r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  cand_dups_pair AS (
    SELECT r.*
    FROM raw.sftp_mm_consumo_suministro_pd r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.sftp_mm_consumo_suministro_pd'
  FROM cand_dups_pair r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.sftp_mm_consumo_suministro_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_err_dups_pair = ROW_COUNT;

  -- Borro duplicados por (num_recibo, per_consumo) de RAW
  WITH claves_dup AS (
    SELECT r.num_recibo, r.per_consumo
    FROM raw.sftp_mm_consumo_suministro_pd r
    GROUP BY r.num_recibo, r.per_consumo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_consumo_suministro_pd r
    JOIN claves_dup d
      ON d.num_recibo  = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  DELETE FROM raw.sftp_mm_consumo_suministro_pd r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  -- Total de errores del día
  v_err_total := COALESCE(v_err_invalid,0) + COALESCE(v_err_dups_pair,0) + COALESCE(v_err_nulos_nr,0);

  /* ========= 2) TRANSFORMACIÓN + DEDUP + CARGA A ODS ========= */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      CASE
        WHEN r.num_recibo IS NULL OR btrim(r.num_recibo) = '' OR lower(btrim(r.num_recibo)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.num_recibo), 250)
      END AS num_recibo,

      /* ==== cod_suministro ahora VARCHAR(255) ==== */
      CASE
        WHEN r.cod_suministro IS NULL OR btrim(r.cod_suministro) = '' OR lower(btrim(r.cod_suministro)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.cod_suministro), 255)
      END::varchar(255) AS cod_suministro,

      NULLIF(NULLIF(btrim(r.tarifa), 'NaN'), '')::varchar(10) AS tarifa,

      /* ==== pot_contr es VARCHAR(255) ==== */
      NULLIF(NULLIF(btrim(r.pot_contr), 'NaN'), '')::varchar(255) AS pot_contr,

      NULLIF(NULLIF(btrim(r.titularidad),  'NaN'), '')::varchar(255) AS titularidad,
      NULLIF(NULLIF(btrim(r.distribuidor), 'NaN'), '')::varchar(255) AS distribuidor,

      CASE
        WHEN r.fec_emision IS NULL OR btrim(r.fec_emision) = '' OR lower(btrim(r.fec_emision)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_emision) > 0 THEN to_date(split_part(r.fec_emision,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_emision,' ',1), 'YYYY-MM-DD')
      END AS fec_emision,
      CASE
        WHEN r.fec_vencimiento IS NULL OR btrim(r.fec_vencimiento) = '' OR lower(btrim(r.fec_vencimiento)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_vencimiento) > 0 THEN to_date(split_part(r.fec_vencimiento,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_vencimiento,' ',1), 'YYYY-MM-DD')
      END AS fec_vencimiento,
      CASE
        WHEN r.fec_lect_actual IS NULL OR btrim(r.fec_lect_actual) = '' OR lower(btrim(r.fec_lect_actual)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_actual) > 0 THEN to_date(split_part(r.fec_lect_actual,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_actual,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_actual,
      CASE
        WHEN r.fec_lect_anterior IS NULL OR btrim(r.fec_lect_anterior) = '' OR lower(btrim(r.fec_lect_anterior)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fec_lect_anterior) > 0 THEN to_date(split_part(r.fec_lect_anterior,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fec_lect_anterior,' ',1), 'YYYY-MM-DD')
      END AS fec_lect_anterior,

      NULLIF(NULLIF(btrim(r.per_consumo), 'NaN'), '')::varchar(50) AS per_consumo,

      public.try_numeric(r.ea_lec_act_hp)::numeric(18,2)  AS ea_lec_act_hp,
      public.try_numeric(r.ea_lec_act_fp)::numeric(18,2)  AS ea_lec_act_fp,
      public.try_numeric(r.ea_lec_act_tot)::numeric(18,2) AS ea_lec_act_tot,
      public.try_numeric(r.ea_lec_ant_hp)::numeric(18,2)  AS ea_lec_ant_hp,
      public.try_numeric(r.ea_lec_ant_fp)::numeric(18,2)  AS ea_lec_ant_fp,
      public.try_numeric(r.ea_lec_ant_tot)::numeric(18,2) AS ea_lec_ant_tot,
      public.try_numeric(r.ea_consumo_hp)::numeric(18,2)  AS ea_consumo_hp,
      public.try_numeric(r.ea_consumo_fp)::numeric(18,2)  AS ea_consumo_fp,
      public.try_numeric(r.ea_consumo_tot)::numeric(18,2) AS ea_consumo_tot,

      public.try_numeric(r.ea_pu_hp)::numeric(18,6)       AS ea_pu_hp,
      public.try_numeric(r.ea_pu_fp)::numeric(18,6)       AS ea_pu_fp,
      public.try_numeric(r.ea_prec_unit_tot)::numeric(18,6) AS ea_prec_unit_tot,

      public.try_numeric(r.ea_importe_hp)::numeric(18,2)  AS ea_importe_hp,
      public.try_numeric(r.ea_importe_fp)::numeric(18,2)  AS ea_importe_fp,
      public.try_numeric(r.ea_importe_tot)::numeric(18,2) AS ea_importe_tot,

      public.try_numeric(r.pot_lect_act_hp)::numeric(18,2)   AS pot_lect_act_hp,
      public.try_numeric(r.pot_lect_act_fp)::numeric(18,2)   AS pot_lect_act_fp,
      public.try_numeric(r.pot_lect_ant_hp)::numeric(18,2)   AS pot_lect_ant_hp,
      public.try_numeric(r.pot_lect_ant_fp)::numeric(18,2)   AS pot_lect_ant_fp,
      public.try_numeric(r.pot_reg_hp)::numeric(18,2)        AS pot_reg_hp,
      public.try_numeric(r.pot_reg_fp)::numeric(18,2)        AS pot_reg_fp,
      public.try_numeric(r.pot_gen_fact)::numeric(18,2)      AS pot_gen_fact,
      public.try_numeric(r.pot_gen_pu)::numeric(18,6)        AS pot_gen_pu,
      public.try_numeric(r.pot_gen_importe)::numeric(18,2)   AS pot_gen_importe,
      public.try_numeric(r.pot_dist_fact)::numeric(18,2)     AS pot_dist_fact,
      public.try_numeric(r.pot_dist_pu)::numeric(18,6)       AS pot_dist_pu,
      public.try_numeric(r.pot_dist_importe)::numeric(18,2)  AS pot_dist_importe,
      public.try_numeric(r.pot_bt6_pu)::numeric(18,6)        AS pot_bt6_pu,
      public.try_numeric(r.pot_bt6_monto)::numeric(18,2)     AS pot_bt6_monto,

      public.try_numeric(r.er_lec_act)::numeric(18,2)     AS er_lec_act,
      public.try_numeric(r.er_lec_ant)::numeric(18,2)     AS er_lec_ant,
      public.try_numeric(r.er_cons)::numeric(18,2)        AS er_cons,
      public.try_numeric(r.er_fact)::numeric(18,2)        AS er_fact,
      public.try_numeric(r.er_pu)::numeric(18,6)          AS er_pu,
      public.try_numeric(r.er_importe)::numeric(18,2)     AS er_importe,

      NULLIF(NULLIF(btrim(r.calif_cliente), 'NaN'), '')::varchar(100) AS calif_cliente,

      trunc(public.try_numeric(r.dias_punta))::int        AS dias_punta,
      trunc(public.try_numeric(r.horas_punta))::int       AS horas_punta,

      NULLIF(NULLIF(btrim(r.factor_calif), 'NaN'), '')::varchar(50) AS factor_calif,

      public.try_numeric(r.cargo_fijo)::numeric(18,2)        AS cargo_fijo,
      public.try_numeric(r.mantenimiento)::numeric(18,2)     AS mantenimiento,
      public.try_numeric(r.alumbrado)::numeric(18,2)         AS alumbrado,
      public.try_numeric(r.recup_energia)::numeric(18,2)     AS recup_energia,
      public.try_numeric(r.mora)::numeric(18,2)              AS mora,
      public.try_numeric(r.reconexion)::numeric(18,2)        AS reconexion,
      public.try_numeric(r.ajuste_tarifa)::numeric(18,2)     AS ajuste_tarifa,
      public.try_numeric(r.dist_factura)::numeric(18,2)      AS dist_factura,
      public.try_numeric(r.ajuste_alumb)::numeric(18,2)      AS ajuste_alumb,
      public.try_numeric(r.otros_afectos)::numeric(18,2)     AS otros_afectos,
      public.try_numeric(r.base_imponible)::numeric(18,2)    AS base_imponible,
      public.try_numeric(r.igv)::numeric(18,2)               AS igv,
      public.try_numeric(r.tot_periodo)::numeric(18,2)       AS tot_periodo,
      public.try_numeric(r.electrif_rural)::numeric(18,2)    AS electrif_rural,
      public.try_numeric(r.comp_distribucion)::numeric(18,2) AS comp_distribucion,
      public.try_numeric(r.comp_generadora)::numeric(18,2)   AS comp_generadora,
      public.try_numeric(r.comp_interrup)::numeric(18,2)     AS comp_interrup,
      public.try_numeric(r.comp_calidad)::numeric(18,2)      AS comp_calidad,
      public.try_numeric(r.comp_frec_ant)::numeric(18,2)     AS comp_frec_ant,
      public.try_numeric(r.comp_frec_des)::numeric(18,2)     AS comp_frec_des,
      public.try_numeric(r.comp_serv)::numeric(18,2)         AS comp_serv,
      public.try_numeric(r.comp_norma_tec)::numeric(18,2)    AS comp_norma_tec,
      public.try_numeric(r.comp_deuda_ant)::numeric(18,2)    AS comp_deuda_ant,

      trunc(public.try_numeric(r.comp_deuda_meses))::int     AS comp_deuda_meses,

      public.try_numeric(r.comp_dev_reclamo)::numeric(18,2)  AS comp_dev_reclamo,
      public.try_numeric(r.comp_nota_deb_cred)::numeric(18,2) AS comp_nota_deb_cred,
      public.try_numeric(r.comp_aporte_reemb)::numeric(18,2) AS comp_aporte_reemb,
      public.try_numeric(r.comp_otros_inafectos)::numeric(18,2) AS comp_otros_inafectos,
      public.try_numeric(r.comp_redondeo_act_pos)::numeric(18,2) AS comp_redondeo_act_pos,
      public.try_numeric(r.comp_redondeo_act_neg)::numeric(18,2) AS comp_redondeo_act_neg,

      public.try_numeric(r.costo_medio)::numeric(18,2)       AS costo_medio,
      public.try_numeric(r.total_a_pagar)::numeric(18,2)     AS total_a_pagar,
      public.try_numeric(r.valor_venta)::numeric(18,2)       AS valor_venta,
      public.try_numeric(r.deuda_anterior)::numeric(18,2)    AS deuda_anterior,
      public.try_numeric(r.devolucion)::numeric(18,2)        AS devolucion,

      CASE
        WHEN r.fecha_liquidacion IS NULL OR btrim(r.fecha_liquidacion) = '' OR lower(btrim(r.fecha_liquidacion)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_liquidacion) > 0 THEN to_date(split_part(r.fecha_liquidacion,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_liquidacion,' ',1), 'YYYY-MM-DD')
      END AS fecha_liquidacion
    FROM raw.sftp_mm_consumo_suministro_pd r
  ),
  dedup AS (
    -- PK ODS: num_recibo (conserva primera aparición)
    SELECT DISTINCT ON (num_recibo) *
    FROM base
    WHERE num_recibo IS NOT NULL
    ORDER BY num_recibo, rid
  )
  INSERT INTO ods.sftp_hm_consumo_suministro (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
  )
  SELECT
    d.num_recibo, d.cod_suministro, d.tarifa, d.pot_contr, d.titularidad, d.distribuidor,
    d.fec_emision, d.fec_vencimiento, d.fec_lect_actual, d.fec_lect_anterior, d.per_consumo,
    d.ea_lec_act_hp, d.ea_lec_act_fp, d.ea_lec_act_tot, d.ea_lec_ant_hp, d.ea_lec_ant_fp, d.ea_lec_ant_tot,
    d.ea_consumo_hp, d.ea_consumo_fp, d.ea_consumo_tot, d.ea_pu_hp, d.ea_pu_fp, d.ea_prec_unit_tot,
    d.ea_importe_hp, d.ea_importe_fp, d.ea_importe_tot,
    d.pot_lect_act_hp, d.pot_lect_act_fp, d.pot_lect_ant_hp, d.pot_lect_ant_fp, d.pot_reg_hp, d.pot_reg_fp,
    d.pot_gen_fact, d.pot_gen_pu, d.pot_gen_importe, d.pot_dist_fact, d.pot_dist_pu, d.pot_dist_importe,
    d.pot_bt6_pu, d.pot_bt6_monto,
    d.er_lec_act, d.er_lec_ant, d.er_cons, d.er_fact, d.er_pu, d.er_importe,
    d.calif_cliente, d.dias_punta, d.horas_punta, d.factor_calif,
    d.cargo_fijo, d.mantenimiento, d.alumbrado, d.recup_energia, d.mora, d.reconexion, d.ajuste_tarifa,
    d.dist_factura, d.ajuste_alumb, d.otros_afectos, d.base_imponible, d.igv, d.tot_periodo,
    d.electrif_rural, d.comp_distribucion, d.comp_generadora, d.comp_interrup, d.comp_calidad,
    d.comp_frec_ant, d.comp_frec_des, d.comp_serv, d.comp_norma_tec, d.comp_deuda_ant, d.comp_deuda_meses,
    d.comp_dev_reclamo, d.comp_nota_deb_cred, d.comp_aporte_reemb, d.comp_otros_inafectos,
    d.comp_redondeo_act_pos, d.comp_redondeo_act_neg,
    d.costo_medio, d.total_a_pagar, d.valor_venta, d.deuda_anterior, d.devolucion, d.fecha_liquidacion
  FROM dedup d
  LEFT JOIN ods.sftp_hm_consumo_suministro o
    ON o.num_recibo = d.num_recibo
  WHERE o.num_recibo IS NULL;

  GET DIAGNOSTICS v_inserted = ROW_COUNT;

  v_estado := 'DONE';
  v_msj    := format(
    'Insertados en ODS: %s | Enviados NUEVOS a public.error_energia (hoy): %s (inválidos: %s, duplicados num_recibo+per_consumo: %s, num_recibo nulo/vacío: %s) | Origen: raw.sftp_mm_consumo_suministro_pd.',
    v_inserted, COALESCE(v_err_total,0), COALESCE(v_err_invalid,0), COALESCE(v_err_dups_pair,0), COALESCE(v_err_nulos_nr,0)
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => NULL::integer,
    p_deleted    => NULL::integer,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj    := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

-------------------


CREATE OR REPLACE PROCEDURE ods.sp_cargar_web_hm_indra_energia()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_web_hm_indra_energia()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_web_hm_indra_energia()'::regprocedure::text;

  v_ins_err_dup   integer := 0;  -- duplicados insertados a error_energia
  v_del_dup_raw   integer := 0;  -- duplicados borrados de RAW
  v_inserted_ods  integer := 0;  -- insertados en ODS

  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ===================== 1) DUPLICADOS (num_recibo, per_consumo) ===================== */
  WITH claves_dup AS (
    SELECT num_recibo, per_consumo
    FROM raw.web_mm_indra_energia
    GROUP BY num_recibo, per_consumo
    HAVING COUNT(*) > 1
  ),
  cand_dups AS (
    SELECT r.*
    FROM raw.web_mm_indra_energia r
    JOIN claves_dup d
      ON d.num_recibo = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  INSERT INTO public.error_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion,
    fecha_carga, tabla_origen
  )
  SELECT
    r.num_recibo, r.cod_suministro, r.tarifa,
    r.pot_contr,                       -- << si error_energia.pot_contr es NUMERIC, puedes usar public.try_numeric(r.pot_contr)
    r.titularidad, r.distribuidor,
    r.fec_emision, r.fec_vencimiento, r.fec_lect_actual, r.fec_lect_anterior, r.per_consumo,
    r.ea_lec_act_hp, r.ea_lec_act_fp, r.ea_lec_act_tot, r.ea_lec_ant_hp, r.ea_lec_ant_fp, r.ea_lec_ant_tot,
    r.ea_consumo_hp, r.ea_consumo_fp, r.ea_consumo_tot, r.ea_pu_hp, r.ea_pu_fp, r.ea_prec_unit_tot,
    r.ea_importe_hp, r.ea_importe_fp, r.ea_importe_tot,
    r.pot_lect_act_hp, r.pot_lect_act_fp, r.pot_lect_ant_hp, r.pot_lect_ant_fp, r.pot_reg_hp, r.pot_reg_fp,
    r.pot_gen_fact, r.pot_gen_pu, r.pot_gen_importe, r.pot_dist_fact, r.pot_dist_pu, r.pot_dist_importe,
    r.pot_bt6_pu, r.pot_bt6_monto,
    r.er_lec_act, r.er_lec_ant, r.er_cons, r.er_fact, r.er_pu, r.er_importe,
    r.calif_cliente, r.dias_punta, r.horas_punta, r.factor_calif,
    r.cargo_fijo, r.mantenimiento, r.alumbrado, r.recup_energia, r.mora, r.reconexion, r.ajuste_tarifa,
    r.dist_factura, r.ajuste_alumb, r.otros_afectos, r.base_imponible, r.igv, r.tot_periodo,
    r.electrif_rural, r.comp_distribucion, r.comp_generadora, r.comp_interrup, r.comp_calidad,
    r.comp_frec_ant, r.comp_frec_des, r.comp_serv, r.comp_norma_tec, r.comp_deuda_ant, r.comp_deuda_meses,
    r.comp_dev_reclamo, r.comp_nota_deb_cred, r.comp_aporte_reemb, r.comp_otros_inafectos,
    r.comp_redondeo_act_pos, r.comp_redondeo_act_neg,
    r.costo_medio, r.total_a_pagar, r.valor_venta, r.deuda_anterior, r.devolucion, r.fecha_liquidacion,
    clock_timestamp()::timestamp(0), 'raw.web_mm_indra_energia'
  FROM cand_dups r
  LEFT JOIN public.error_energia e
         ON e.num_recibo   = r.num_recibo
        AND ( (e.per_consumo IS NULL AND r.per_consumo IS NULL) OR e.per_consumo = r.per_consumo )
        AND e.tabla_origen = 'raw.web_mm_indra_energia'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.num_recibo IS NULL;

  GET DIAGNOSTICS v_ins_err_dup = ROW_COUNT;

  WITH claves_dup AS (
    SELECT num_recibo, per_consumo
    FROM raw.web_mm_indra_energia
    GROUP BY num_recibo, per_consumo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.web_mm_indra_energia r
    JOIN claves_dup d
      ON d.num_recibo = r.num_recibo
     AND ( (d.per_consumo IS NULL AND r.per_consumo IS NULL) OR d.per_consumo = r.per_consumo )
  )
  DELETE FROM raw.web_mm_indra_energia r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  GET DIAGNOSTICS v_del_dup_raw = ROW_COUNT;

  /* ===================== 2) TRANSFORMACIÓN + CARGA A ODS ===================== */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      -- num_recibo limpio
      CASE
        WHEN r.num_recibo IS NULL OR btrim(r.num_recibo) = '' OR lower(btrim(r.num_recibo)) IN ('nan','null')
          THEN NULL
        ELSE left(btrim(r.num_recibo), 250)
      END AS num_recibo,

      -- cod_suministro como TEXTO (varchar 250)
      NULLIF(NULLIF(btrim(r.cod_suministro), 'NaN'), '')::varchar(250) AS cod_suministro,

      NULLIF(NULLIF(btrim(r.tarifa), 'NaN'), '')::varchar(10)  AS tarifa,

      /* ==== pot_contr ahora VARCHAR(255) ==== */
      NULLIF(NULLIF(btrim(r.pot_contr), 'NaN'), '')::varchar(255) AS pot_contr,
      -- Variante con limpieza de símbolos (opcional):
      -- CASE
      --   WHEN r.pot_contr IS NULL OR btrim(r.pot_contr) = '' OR lower(btrim(r.pot_contr)) IN ('nan','null')
      --     THEN NULL
      --   ELSE left(regexp_replace(btrim(r.pot_contr), '[^\d\.\,\-\w ]', '', 'g'), 255)
      -- END::varchar(255) AS pot_contr,

      NULLIF(NULLIF(btrim(r.titularidad),  'NaN'), '')::varchar(255) AS titularidad,
      NULLIF(NULLIF(btrim(r.distribuidor), 'NaN'), '')::varchar(255) AS distribuidor,

      /* ==== FECHAS robustas ==== */
      -- fec_emision
      CASE
        WHEN r.fec_emision IS NULL OR btrim(r.fec_emision) = '' OR lower(btrim(r.fec_emision)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_emision,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_emision,

      -- fec_vencimiento
      CASE
        WHEN r.fec_vencimiento IS NULL OR btrim(r.fec_vencimiento) = '' OR lower(btrim(r.fec_vencimiento)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_vencimiento,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_vencimiento,

      -- fec_lect_actual
      CASE
        WHEN r.fec_lect_actual IS NULL OR btrim(r.fec_lect_actual) = '' OR lower(btrim(r.fec_lect_actual)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_actual,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_lect_actual,

      -- fec_lect_anterior
      CASE
        WHEN r.fec_lect_anterior IS NULL OR btrim(r.fec_lect_anterior) = '' OR lower(btrim(r.fec_lect_anterior)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fec_lect_anterior,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fec_lect_anterior,

      NULLIF(NULLIF(btrim(r.per_consumo), 'NaN'), '')::varchar(50) AS per_consumo,

      public.try_numeric(r.ea_lec_act_hp)::numeric(18,2)  AS ea_lec_act_hp,
      public.try_numeric(r.ea_lec_act_fp)::numeric(18,2)  AS ea_lec_act_fp,
      public.try_numeric(r.ea_lec_act_tot)::numeric(18,2) AS ea_lec_act_tot,
      public.try_numeric(r.ea_lec_ant_hp)::numeric(18,2)  AS ea_lec_ant_hp,
      public.try_numeric(r.ea_lec_ant_fp)::numeric(18,2)  AS ea_lec_ant_fp,
      public.try_numeric(r.ea_lec_ant_tot)::numeric(18,2) AS ea_lec_ant_tot,

      public.try_numeric(r.ea_consumo_hp)::numeric(18,2)  AS ea_consumo_hp,
      public.try_numeric(r.ea_consumo_fp)::numeric(18,2)  AS ea_consumo_fp,
      public.try_numeric(r.ea_consumo_tot)::numeric(18,2) AS ea_consumo_tot,

      public.try_numeric(r.ea_pu_hp)::numeric(18,6)       AS ea_pu_hp,
      public.try_numeric(r.ea_pu_fp)::numeric(18,6)       AS ea_pu_fp,
      public.try_numeric(r.ea_prec_unit_tot)::numeric(18,6) AS ea_prec_unit_tot,

      public.try_numeric(r.ea_importe_hp)::numeric(18,2)  AS ea_importe_hp,
      public.try_numeric(r.ea_importe_fp)::numeric(18,2)  AS ea_importe_fp,
      public.try_numeric(r.ea_importe_tot)::numeric(18,2) AS ea_importe_tot,

      public.try_numeric(r.pot_lect_act_hp)::numeric(18,2)   AS pot_lect_act_hp,
      public.try_numeric(r.pot_lect_act_fp)::numeric(18,2)   AS pot_lect_act_fp,
      public.try_numeric(r.pot_lect_ant_hp)::numeric(18,2)   AS pot_lect_ant_hp,
      public.try_numeric(r.pot_lect_ant_fp)::numeric(18,2)   AS pot_lect_ant_fp,
      public.try_numeric(r.pot_reg_hp)::numeric(18,2)        AS pot_reg_hp,
      public.try_numeric(r.pot_reg_fp)::numeric(18,2)        AS pot_reg_fp,
      public.try_numeric(r.pot_gen_fact)::numeric(18,2)      AS pot_gen_fact,
      public.try_numeric(r.pot_gen_pu)::numeric(18,6)        AS pot_gen_pu,
      public.try_numeric(r.pot_gen_importe)::numeric(18,2)   AS pot_gen_importe,
      public.try_numeric(r.pot_dist_fact)::numeric(18,2)     AS pot_dist_fact,
      public.try_numeric(r.pot_dist_pu)::numeric(18,6)       AS pot_dist_pu,
      public.try_numeric(r.pot_dist_importe)::numeric(18,2)  AS pot_dist_importe,
      public.try_numeric(r.pot_bt6_pu)::numeric(18,6)        AS pot_bt6_pu,
      public.try_numeric(r.pot_bt6_monto)::numeric(18,2)     AS pot_bt6_monto,

      public.try_numeric(r.er_lec_act)::numeric(18,2)     AS er_lec_act,
      public.try_numeric(r.er_lec_ant)::numeric(18,2)     AS er_lec_ant,
      public.try_numeric(r.er_cons)::numeric(18,2)        AS er_cons,
      public.try_numeric(r.er_fact)::numeric(18,2)        AS er_fact,
      public.try_numeric(r.er_pu)::numeric(18,6)          AS er_pu,
      public.try_numeric(r.er_importe)::numeric(18,2)     AS er_importe,

      NULLIF(NULLIF(btrim(r.calif_cliente), 'NaN'), '')::varchar(100) AS calif_cliente,
      trunc(public.try_numeric(r.dias_punta))::int        AS dias_punta,
      trunc(public.try_numeric(r.horas_punta))::int       AS horas_punta,
      NULLIF(NULLIF(btrim(r.factor_calif), 'NaN'), '')::varchar(50) AS factor_calif,

      public.try_numeric(r.cargo_fijo)::numeric(18,2)        AS cargo_fijo,
      public.try_numeric(r.mantenimiento)::numeric(18,2)     AS mantenimiento,
      public.try_numeric(r.alumbrado)::numeric(18,2)         AS alumbrado,
      public.try_numeric(r.recup_energia)::numeric(18,2)     AS recup_energia,
      public.try_numeric(r.mora)::numeric(18,2)              AS mora,
      public.try_numeric(r.reconexion)::numeric(18,2)        AS reconexion,
      public.try_numeric(r.ajuste_tarifa)::numeric(18,2)     AS ajuste_tarifa,
      public.try_numeric(r.dist_factura)::numeric(18,2)      AS dist_factura,
      public.try_numeric(r.ajuste_alumb)::numeric(18,2)      AS ajuste_alumb,
      public.try_numeric(r.otros_afectos)::numeric(18,2)     AS otros_afectos,
      public.try_numeric(r.base_imponible)::numeric(18,2)    AS base_imponible,
      public.try_numeric(r.igv)::numeric(18,2)               AS igv,
      public.try_numeric(r.tot_periodo)::numeric(18,2)       AS tot_periodo,

      public.try_numeric(r.electrif_rural)::numeric(18,2)    AS electrif_rural,
      public.try_numeric(r.comp_distribucion)::numeric(18,2) AS comp_distribucion,
      public.try_numeric(r.comp_generadora)::numeric(18,2)   AS comp_generadora,
      public.try_numeric(r.comp_interrup)::numeric(18,2)     AS comp_interrup,
      public.try_numeric(r.comp_calidad)::numeric(18,2)      AS comp_calidad,
      public.try_numeric(r.comp_frec_ant)::numeric(18,2)     AS comp_frec_ant,
      public.try_numeric(r.comp_frec_des)::numeric(18,2)     AS comp_frec_des,
      public.try_numeric(r.comp_serv)::numeric(18,2)         AS comp_serv,
      public.try_numeric(r.comp_norma_tec)::numeric(18,2)    AS comp_norma_tec,
      public.try_numeric(r.comp_deuda_ant)::numeric(18,2)    AS comp_deuda_ant,
      trunc(public.try_numeric(r.comp_deuda_meses))::int     AS comp_deuda_meses,

      public.try_numeric(r.comp_dev_reclamo)::numeric(18,2)  AS comp_dev_reclamo,
      public.try_numeric(r.comp_nota_deb_cred)::numeric(18,2) AS comp_nota_deb_cred,
      public.try_numeric(r.comp_aporte_reemb)::numeric(18,2) AS comp_aporte_reemb,
      public.try_numeric(r.comp_otros_inafectos)::numeric(18,2) AS comp_otros_inafectos,
      public.try_numeric(r.comp_redondeo_act_pos)::numeric(18,2) AS comp_redondeo_act_pos,
      public.try_numeric(r.comp_redondeo_act_neg)::numeric(18,2) AS comp_redondeo_act_neg,

      public.try_numeric(r.costo_medio)::numeric(18,2)       AS costo_medio,
      public.try_numeric(r.total_a_pagar)::numeric(18,2)     AS total_a_pagar,
      public.try_numeric(r.valor_venta)::numeric(18,2)       AS valor_venta,
      public.try_numeric(r.deuda_anterior)::numeric(18,2)    AS deuda_anterior,
      public.try_numeric(r.devolucion)::numeric(18,2)        AS devolucion,

      -- fecha_liquidacion
      CASE
        WHEN r.fecha_liquidacion IS NULL OR btrim(r.fecha_liquidacion) = '' OR lower(btrim(r.fecha_liquidacion)) IN ('nan','null') THEN NULL
        ELSE
          CASE
            WHEN regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}$'
              THEN to_date(regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g'), 'DD/MM/YYYY')
            WHEN regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g') ~ '^[0-9]{4}/[0-9]{2}/[0-9]{2}$'
              THEN to_date(regexp_replace(split_part(r.fecha_liquidacion,' ',1), '[\.\-]', '/', 'g'), 'YYYY/MM/DD')
            ELSE NULL
          END
      END AS fecha_liquidacion
    FROM raw.web_mm_indra_energia r
  ),
  dedup AS (
    SELECT DISTINCT ON (num_recibo) *
    FROM base
    WHERE num_recibo IS NOT NULL
    ORDER BY num_recibo, rid
  )
  INSERT INTO ods.web_hm_indra_energia (
    num_recibo, cod_suministro, tarifa, pot_contr, titularidad, distribuidor,
    fec_emision, fec_vencimiento, fec_lect_actual, fec_lect_anterior, per_consumo,
    ea_lec_act_hp, ea_lec_act_fp, ea_lec_act_tot, ea_lec_ant_hp, ea_lec_ant_fp, ea_lec_ant_tot,
    ea_consumo_hp, ea_consumo_fp, ea_consumo_tot, ea_pu_hp, ea_pu_fp, ea_prec_unit_tot,
    ea_importe_hp, ea_importe_fp, ea_importe_tot,
    pot_lect_act_hp, pot_lect_act_fp, pot_lect_ant_hp, pot_lect_ant_fp, pot_reg_hp, pot_reg_fp,
    pot_gen_fact, pot_gen_pu, pot_gen_importe, pot_dist_fact, pot_dist_pu, pot_dist_importe,
    pot_bt6_pu, pot_bt6_monto,
    er_lec_act, er_lec_ant, er_cons, er_fact, er_pu, er_importe,
    calif_cliente, dias_punta, horas_punta, factor_calif,
    cargo_fijo, mantenimiento, alumbrado, recup_energia, mora, reconexion, ajuste_tarifa,
    dist_factura, ajuste_alumb, otros_afectos, base_imponible, igv, tot_periodo,
    electrif_rural, comp_distribucion, comp_generadora, comp_interrup, comp_calidad,
    comp_frec_ant, comp_frec_des, comp_serv, comp_norma_tec, comp_deuda_ant, comp_deuda_meses,
    comp_dev_reclamo, comp_nota_deb_cred, comp_aporte_reemb, comp_otros_inafectos,
    comp_redondeo_act_pos, comp_redondeo_act_neg,
    costo_medio, total_a_pagar, valor_venta, deuda_anterior, devolucion, fecha_liquidacion
  )
  SELECT
    d.num_recibo, d.cod_suministro, d.tarifa, d.pot_contr, d.titularidad, d.distribuidor,
    d.fec_emision, d.fec_vencimiento, d.fec_lect_actual, d.fec_lect_anterior, d.per_consumo,
    d.ea_lec_act_hp, d.ea_lec_act_fp, d.ea_lec_act_tot, d.ea_lec_ant_hp, d.ea_lec_ant_fp, d.ea_lec_ant_tot,
    d.ea_consumo_hp, d.ea_consumo_fp, d.ea_consumo_tot, d.ea_pu_hp, d.ea_pu_fp, d.ea_prec_unit_tot,
    d.ea_importe_hp, d.ea_importe_fp, d.ea_importe_tot,
    d.pot_lect_act_hp, d.pot_lect_act_fp, d.pot_lect_ant_hp, d.pot_lect_ant_fp, d.pot_reg_hp, d.pot_reg_fp,
    d.pot_gen_fact, d.pot_gen_pu, d.pot_gen_importe, d.pot_dist_fact, d.pot_dist_pu, d.pot_dist_importe,
    d.pot_bt6_pu, d.pot_bt6_monto,
    d.er_lec_act, d.er_lec_ant, d.er_cons, d.er_fact, d.er_pu, d.er_importe,
    d.calif_cliente, d.dias_punta, d.horas_punta, d.factor_calif,
    d.cargo_fijo, d.mantenimiento, d.alumbrado, d.recup_energia, d.mora, d.reconexion, d.ajuste_tarifa,
    d.dist_factura, d.ajuste_alumb, d.otros_afectos, d.base_imponible, d.igv, d.tot_periodo,
    d.electrif_rural, d.comp_distribucion, d.comp_generadora, d.comp_interrup, d.comp_calidad,
    d.comp_frec_ant, d.comp_frec_des, d.comp_serv, d.comp_norma_tec, d.comp_deuda_ant, d.comp_deuda_meses,
    d.comp_dev_reclamo, d.comp_nota_deb_cred, d.comp_aporte_reemb, d.comp_otros_inafectos,
    d.comp_redondeo_act_pos, d.comp_redondeo_act_neg,
    d.costo_medio, d.total_a_pagar, d.valor_venta, d.deuda_anterior, d.devolucion, d.fecha_liquidacion
  FROM dedup d
  LEFT JOIN ods.web_hm_indra_energia o
    ON o.num_recibo = d.num_recibo
  WHERE o.num_recibo IS NULL;

  GET DIAGNOSTICS v_inserted_ods = ROW_COUNT;

  /* ===================== LOG ===================== */
  v_estado := 'DONE';
  v_msj := format(
    'Duplicados movidos a error_energia=%s | Duplicados borrados RAW=%s | Insertados en ODS=%s | Origen=raw.web_mm_indra_energia',
    v_ins_err_dup, v_del_dup_raw, v_inserted_ods
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted_ods,
    p_updated    => NULL::integer,
    p_deleted    => v_del_dup_raw,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

--------- vista

CREATE OR REPLACE VIEW ods.vw_hm_energia AS
SELECT
  num_recibo,
  cod_suministro,
  tarifa,
  pot_contr,
  titularidad,
  distribuidor,
  fec_emision,
  fec_vencimiento,
  fec_lect_actual,
  fec_lect_anterior,
  per_consumo,
  ea_lec_act_hp,
  ea_lec_act_fp,
  ea_lec_act_tot,
  ea_lec_ant_hp,
  ea_lec_ant_fp,
  ea_lec_ant_tot,
  ea_consumo_hp,
  ea_consumo_fp,
  ea_consumo_tot,
  ea_pu_hp,
  ea_pu_fp,
  ea_prec_unit_tot,
  ea_importe_hp,
  ea_importe_fp,
  ea_importe_tot,
  pot_lect_act_hp,
  pot_lect_act_fp,
  pot_lect_ant_hp,
  pot_lect_ant_fp,
  pot_reg_hp,
  pot_reg_fp,
  pot_gen_fact,
  pot_gen_pu,
  pot_gen_importe,
  pot_dist_fact,
  pot_dist_pu,
  pot_dist_importe,
  pot_bt6_pu,
  pot_bt6_monto,
  er_lec_act,
  er_lec_ant,
  er_cons,
  er_fact,
  er_pu,
  er_importe,
  calif_cliente,
  dias_punta,
  horas_punta,
  factor_calif,
  cargo_fijo,
  mantenimiento,
  alumbrado,
  recup_energia,
  mora,
  reconexion,
  ajuste_tarifa,
  dist_factura,
  ajuste_alumb,
  otros_afectos,
  base_imponible,
  igv,
  tot_periodo,
  electrif_rural,
  comp_distribucion,
  comp_generadora,
  comp_interrup,
  comp_calidad,
  comp_frec_ant,
  comp_frec_des,
  comp_serv,
  comp_norma_tec,
  comp_deuda_ant,
  comp_deuda_meses,
  comp_dev_reclamo,
  comp_nota_deb_cred,
  comp_aporte_reemb,
  comp_otros_inafectos,
  comp_redondeo_act_pos,
  comp_redondeo_act_neg,
  costo_medio,
  total_a_pagar,
  valor_venta,
  deuda_anterior,
  devolucion,
  fecha_liquidacion,
  creation_user,
  creation_date,
  creation_ip,
  tabla_origen
FROM (
  /* 0) EXCEL primero */
  SELECT
    e.num_recibo::varchar(255)            AS num_recibo,
    e.cod_suministro::varchar(255)        AS cod_suministro,
    e.tarifa::varchar(255)                AS tarifa,
    e.pot_contr::varchar(255)             AS pot_contr,
    e.titularidad::varchar(255)           AS titularidad,
    e.distribuidor::varchar(255)          AS distribuidor,
    e.fec_emision::varchar(255)           AS fec_emision,
    e.fec_vencimiento::varchar(255)       AS fec_vencimiento,
    e.fec_lect_actual::varchar(255)       AS fec_lect_actual,
    e.fec_lect_anterior::varchar(255)     AS fec_lect_anterior,
    e.per_consumo::varchar(255)           AS per_consumo,
    e.ea_lec_act_hp::varchar(255)         AS ea_lec_act_hp,
    e.ea_lec_act_fp::varchar(255)         AS ea_lec_act_fp,
    e.ea_lec_act_tot::varchar(255)        AS ea_lec_act_tot,
    e.ea_lec_ant_hp::varchar(255)         AS ea_lec_ant_hp,
    e.ea_lec_ant_fp::varchar(255)         AS ea_lec_ant_fp,
    e.ea_lec_ant_tot::varchar(255)        AS ea_lec_ant_tot,
    e.ea_consumo_hp::varchar(255)         AS ea_consumo_hp,
    e.ea_consumo_fp::varchar(255)         AS ea_consumo_fp,
    e.ea_consumo_tot::varchar(255)        AS ea_consumo_tot,
    e.ea_pu_hp::varchar(255)              AS ea_pu_hp,
    e.ea_pu_fp::varchar(255)              AS ea_pu_fp,
    e.ea_prec_unit_tot::varchar(255)      AS ea_prec_unit_tot,
    e.ea_importe_hp::varchar(255)         AS ea_importe_hp,
    e.ea_importe_fp::varchar(255)         AS ea_importe_fp,
    e.ea_importe_tot::varchar(255)        AS ea_importe_tot,
    e.pot_lect_act_hp::varchar(255)       AS pot_lect_act_hp,
    e.pot_lect_act_fp::varchar(255)       AS pot_lect_act_fp,
    e.pot_lect_ant_hp::varchar(255)       AS pot_lect_ant_hp,
    e.pot_lect_ant_fp::varchar(255)       AS pot_lect_ant_fp,
    e.pot_reg_hp::varchar(255)            AS pot_reg_hp,
    e.pot_reg_fp::varchar(255)            AS pot_reg_fp,
    e.pot_gen_fact::varchar(255)          AS pot_gen_fact,
    e.pot_gen_pu::varchar(255)            AS pot_gen_pu,
    e.pot_gen_importe::varchar(255)       AS pot_gen_importe,
    e.pot_dist_fact::varchar(255)         AS pot_dist_fact,
    e.pot_dist_pu::varchar(255)           AS pot_dist_pu,
    e.pot_dist_importe::varchar(255)      AS pot_dist_importe,
    e.pot_bt6_pu::varchar(255)            AS pot_bt6_pu,
    e.pot_bt6_monto::varchar(255)         AS pot_bt6_monto,
    e.er_lec_act::varchar(255)            AS er_lec_act,
    e.er_lec_ant::varchar(255)            AS er_lec_ant,
    e.er_cons::varchar(255)               AS er_cons,
    e.er_fact::varchar(255)               AS er_fact,
    e.er_pu::varchar(255)                 AS er_pu,
    e.er_importe::varchar(255)            AS er_importe,
    e.calif_cliente::varchar(255)         AS calif_cliente,
    e.dias_punta::varchar(255)            AS dias_punta,
    e.horas_punta::varchar(255)           AS horas_punta,
    e.factor_calif::varchar(255)          AS factor_calif,
    e.cargo_fijo::varchar(255)            AS cargo_fijo,
    e.mantenimiento::varchar(255)         AS mantenimiento,
    e.alumbrado::varchar(255)             AS alumbrado,
    e.recup_energia::varchar(255)         AS recup_energia,
    e.mora::varchar(255)                  AS mora,
    e.reconexion::varchar(255)            AS reconexion,
    e.ajuste_tarifa::varchar(255)         AS ajuste_tarifa,
    e.dist_factura::varchar(255)          AS dist_factura,
    e.ajuste_alumb::varchar(255)          AS ajuste_alumb,
    e.otros_afectos::varchar(255)         AS otros_afectos,
    e.base_imponible::varchar(255)        AS base_imponible,
    e.igv::varchar(255)                   AS igv,
    e.tot_periodo::varchar(255)           AS tot_periodo,
    e.electrif_rural::varchar(255)        AS electrif_rural,
    e.comp_distribucion::varchar(255)     AS comp_distribucion,
    e.comp_generadora::varchar(255)       AS comp_generadora,
    e.comp_interrup::varchar(255)         AS comp_interrup,
    e.comp_calidad::varchar(255)          AS comp_calidad,
    e.comp_frec_ant::varchar(255)         AS comp_frec_ant,
    e.comp_frec_des::varchar(255)         AS comp_frec_des,
    e.comp_serv::varchar(255)             AS comp_serv,
    e.comp_norma_tec::varchar(255)        AS comp_norma_tec,
    e.comp_deuda_ant::varchar(255)        AS comp_deuda_ant,
    e.comp_deuda_meses::varchar(255)      AS comp_deuda_meses,
    e.comp_dev_reclamo::varchar(255)      AS comp_dev_reclamo,
    e.comp_nota_deb_cred::varchar(255)    AS comp_nota_deb_cred,
    e.comp_aporte_reemb::varchar(255)     AS comp_aporte_reemb,
    e.comp_otros_inafectos::varchar(255)  AS comp_otros_inafectos,
    e.comp_redondeo_act_pos::varchar(255) AS comp_redondeo_act_pos,
    e.comp_redondeo_act_neg::varchar(255) AS comp_redondeo_act_neg,
    e.costo_medio::varchar(255)           AS costo_medio,
    e.total_a_pagar::varchar(255)         AS total_a_pagar,
    e.valor_venta::varchar(255)           AS valor_venta,
    e.deuda_anterior::varchar(255)        AS deuda_anterior,
    e.devolucion::varchar(255)            AS devolucion,
    e.fecha_liquidacion::varchar(255)     AS fecha_liquidacion,
    NULL::varchar(255)                    AS creation_user,
    NULL::varchar(255)                    AS creation_date,
    NULL::varchar(255)                    AS creation_ip,
    'raw.excel_hm_consumo_energia'::varchar(255) AS tabla_origen
  FROM raw.excel_hm_consumo_energia e

  UNION ALL
  /* 1) ODS: sftp_hm_clientes_libres */
  SELECT
    s1.num_recibo::varchar(255),
    s1.cod_suministro::varchar(255),
    s1.tarifa::varchar(255),
    s1.pot_contr::varchar(255),
    s1.titularidad::varchar(255),
    s1.distribuidor::varchar(255),
    s1.fec_emision::varchar(255),
    s1.fec_vencimiento::varchar(255),
    s1.fec_lect_actual::varchar(255),
    s1.fec_lect_anterior::varchar(255),
    s1.per_consumo::varchar(255),
    s1.ea_lec_act_hp::varchar(255),
    s1.ea_lec_act_fp::varchar(255),
    s1.ea_lec_act_tot::varchar(255),
    s1.ea_lec_ant_hp::varchar(255),
    s1.ea_lec_ant_fp::varchar(255),
    s1.ea_lec_ant_tot::varchar(255),
    s1.ea_consumo_hp::varchar(255),
    s1.ea_consumo_fp::varchar(255),
    s1.ea_consumo_tot::varchar(255),
    s1.ea_pu_hp::varchar(255),
    s1.ea_pu_fp::varchar(255),
    s1.ea_prec_unit_tot::varchar(255),
    s1.ea_importe_hp::varchar(255),
    s1.ea_importe_fp::varchar(255),
    s1.ea_importe_tot::varchar(255),
    s1.pot_lect_act_hp::varchar(255),
    s1.pot_lect_act_fp::varchar(255),
    s1.pot_lect_ant_hp::varchar(255),
    s1.pot_lect_ant_fp::varchar(255),
    s1.pot_reg_hp::varchar(255),
    s1.pot_reg_fp::varchar(255),
    s1.pot_gen_fact::varchar(255),
    s1.pot_gen_pu::varchar(255),
    s1.pot_gen_importe::varchar(255),
    s1.pot_dist_fact::varchar(255),
    s1.pot_dist_pu::varchar(255),
    s1.pot_dist_importe::varchar(255),
    s1.pot_bt6_pu::varchar(255),
    s1.pot_bt6_monto::varchar(255),
    s1.er_lec_act::varchar(255),
    s1.er_lec_ant::varchar(255),
    s1.er_cons::varchar(255),
    s1.er_fact::varchar(255),
    s1.er_pu::varchar(255),
    s1.er_importe::varchar(255),
    s1.calif_cliente::varchar(255),
    s1.dias_punta::varchar(255),
    s1.horas_punta::varchar(255),
    s1.factor_calif::varchar(255),
    s1.cargo_fijo::varchar(255),
    s1.mantenimiento::varchar(255),
    s1.alumbrado::varchar(255),
    s1.recup_energia::varchar(255),
    s1.mora::varchar(255),
    s1.reconexion::varchar(255),
    s1.ajuste_tarifa::varchar(255),
    s1.dist_factura::varchar(255),
    s1.ajuste_alumb::varchar(255),
    s1.otros_afectos::varchar(255),
    s1.base_imponible::varchar(255),
    s1.igv::varchar(255),
    s1.tot_periodo::varchar(255),
    s1.electrif_rural::varchar(255),
    s1.comp_distribucion::varchar(255),
    s1.comp_generadora::varchar(255),
    s1.comp_interrup::varchar(255),
    s1.comp_calidad::varchar(255),
    s1.comp_frec_ant::varchar(255),
    s1.comp_frec_des::varchar(255),
    s1.comp_serv::varchar(255),
    s1.comp_norma_tec::varchar(255),
    s1.comp_deuda_ant::varchar(255),
    s1.comp_deuda_meses::varchar(255),
    s1.comp_dev_reclamo::varchar(255),
    s1.comp_nota_deb_cred::varchar(255),
    s1.comp_aporte_reemb::varchar(255),
    s1.comp_otros_inafectos::varchar(255),
    s1.comp_redondeo_act_pos::varchar(255),
    s1.comp_redondeo_act_neg::varchar(255),
    s1.costo_medio::varchar(255),
    s1.total_a_pagar::varchar(255),
    s1.valor_venta::varchar(255),
    s1.deuda_anterior::varchar(255),
    s1.devolucion::varchar(255),
    s1.fecha_liquidacion::varchar(255),
    s1.creation_user::varchar(255),
    s1.creation_date::varchar(255),
    s1.creation_ip::varchar(255),
    'ods.sftp_hm_clientes_libres'::varchar(255) AS tabla_origen
  FROM ods.sftp_hm_clientes_libres s1

  UNION ALL
  /* 2) ODS: sftp_hm_consumo_suministro */
  SELECT
    s2.num_recibo::varchar(255),
    s2.cod_suministro::varchar(255),
    s2.tarifa::varchar(255),
    s2.pot_contr::varchar(255),
    s2.titularidad::varchar(255),
    s2.distribuidor::varchar(255),
    s2.fec_emision::varchar(255),
    s2.fec_vencimiento::varchar(255),
    s2.fec_lect_actual::varchar(255),
    s2.fec_lect_anterior::varchar(255),
    s2.per_consumo::varchar(255),
    s2.ea_lec_act_hp::varchar(255),
    s2.ea_lec_act_fp::varchar(255),
    s2.ea_lec_act_tot::varchar(255),
    s2.ea_lec_ant_hp::varchar(255),
    s2.ea_lec_ant_fp::varchar(255),
    s2.ea_lec_ant_tot::varchar(255),
    s2.ea_consumo_hp::varchar(255),
    s2.ea_consumo_fp::varchar(255),
    s2.ea_consumo_tot::varchar(255),
    s2.ea_pu_hp::varchar(255),
    s2.ea_pu_fp::varchar(255),
    s2.ea_prec_unit_tot::varchar(255),
    s2.ea_importe_hp::varchar(255),
    s2.ea_importe_fp::varchar(255),
    s2.ea_importe_tot::varchar(255),
    s2.pot_lect_act_hp::varchar(255),
    s2.pot_lect_act_fp::varchar(255),
    s2.pot_lect_ant_hp::varchar(255),
    s2.pot_lect_ant_fp::varchar(255),
    s2.pot_reg_hp::varchar(255),
    s2.pot_reg_fp::varchar(255),
    s2.pot_gen_fact::varchar(255),
    s2.pot_gen_pu::varchar(255),
    s2.pot_gen_importe::varchar(255),
    s2.pot_dist_fact::varchar(255),
    s2.pot_dist_pu::varchar(255),
    s2.pot_dist_importe::varchar(255),
    s2.pot_bt6_pu::varchar(255),
    s2.pot_bt6_monto::varchar(255),
    s2.er_lec_act::varchar(255),
    s2.er_lec_ant::varchar(255),
    s2.er_cons::varchar(255),
    s2.er_fact::varchar(255),
    s2.er_pu::varchar(255),
    s2.er_importe::varchar(255),
    s2.calif_cliente::varchar(255),
    s2.dias_punta::varchar(255),
    s2.horas_punta::varchar(255),
    s2.factor_calif::varchar(255),
    s2.cargo_fijo::varchar(255),
    s2.mantenimiento::varchar(255),
    s2.alumbrado::varchar(255),
    s2.recup_energia::varchar(255),
    s2.mora::varchar(255),
    s2.reconexion::varchar(255),
    s2.ajuste_tarifa::varchar(255),
    s2.dist_factura::varchar(255),
    s2.ajuste_alumb::varchar(255),
    s2.otros_afectos::varchar(255),
    s2.base_imponible::varchar(255),
    s2.igv::varchar(255),
    s2.tot_periodo::varchar(255),
    s2.electrif_rural::varchar(255),
    s2.comp_distribucion::varchar(255),
    s2.comp_generadora::varchar(255),
    s2.comp_interrup::varchar(255),
    s2.comp_calidad::varchar(255),
    s2.comp_frec_ant::varchar(255),
    s2.comp_frec_des::varchar(255),
    s2.comp_serv::varchar(255),
    s2.comp_norma_tec::varchar(255),
    s2.comp_deuda_ant::varchar(255),
    s2.comp_deuda_meses::varchar(255),
    s2.comp_dev_reclamo::varchar(255),
    s2.comp_nota_deb_cred::varchar(255),
    s2.comp_aporte_reemb::varchar(255),
    s2.comp_otros_inafectos::varchar(255),
    s2.comp_redondeo_act_pos::varchar(255),
    s2.comp_redondeo_act_neg::varchar(255),
    s2.costo_medio::varchar(255),
    s2.total_a_pagar::varchar(255),
    s2.valor_venta::varchar(255),
    s2.deuda_anterior::varchar(255),
    s2.devolucion::varchar(255),
    s2.fecha_liquidacion::varchar(255),
    s2.creation_user::varchar(255),
    s2.creation_date::varchar(255),
    s2.creation_ip::varchar(255),
    'ods.sftp_hm_consumo_suministro'::varchar(255) AS tabla_origen
  FROM ods.sftp_hm_consumo_suministro s2

  UNION ALL
  /* 3) ODS: web_hm_indra_energia */
  SELECT
    w.num_recibo::varchar(255),
    w.cod_suministro::varchar(255),
    w.tarifa::varchar(255),
    w.pot_contr::varchar(255),
    w.titularidad::varchar(255),
    w.distribuidor::varchar(255),
    w.fec_emision::varchar(255),
    w.fec_vencimiento::varchar(255),
    w.fec_lect_actual::varchar(255),
    w.fec_lect_anterior::varchar(255),
    w.per_consumo::varchar(255),
    w.ea_lec_act_hp::varchar(255),
    w.ea_lec_act_fp::varchar(255),
    w.ea_lec_act_tot::varchar(255),
    w.ea_lec_ant_hp::varchar(255),
    w.ea_lec_ant_fp::varchar(255),
    w.ea_lec_ant_tot::varchar(255),
    w.ea_consumo_hp::varchar(255),
    w.ea_consumo_fp::varchar(255),
    w.ea_consumo_tot::varchar(255),
    w.ea_pu_hp::varchar(255),
    w.ea_pu_fp::varchar(255),
    w.ea_prec_unit_tot::varchar(255),
    w.ea_importe_hp::varchar(255),
    w.ea_importe_fp::varchar(255),
    w.ea_importe_tot::varchar(255),
    w.pot_lect_act_hp::varchar(255),
    w.pot_lect_act_fp::varchar(255),
    w.pot_lect_ant_hp::varchar(255),
    w.pot_lect_ant_fp::varchar(255),
    w.pot_reg_hp::varchar(255),
    w.pot_reg_fp::varchar(255),
    w.pot_gen_fact::varchar(255),
    w.pot_gen_pu::varchar(255),
    w.pot_gen_importe::varchar(255),
    w.pot_dist_fact::varchar(255),
    w.pot_dist_pu::varchar(255),
    w.pot_dist_importe::varchar(255),
    w.pot_bt6_pu::varchar(255),
    w.pot_bt6_monto::varchar(255),
    w.er_lec_act::varchar(255),
    w.er_lec_ant::varchar(255),
    w.er_cons::varchar(255),
    w.er_fact::varchar(255),
    w.er_pu::varchar(255),
    w.er_importe::varchar(255),
    w.calif_cliente::varchar(255),
    w.dias_punta::varchar(255),
    w.horas_punta::varchar(255),
    w.factor_calif::varchar(255),
    w.cargo_fijo::varchar(255),
    w.mantenimiento::varchar(255),
    w.alumbrado::varchar(255),
    w.recup_energia::varchar(255),
    w.mora::varchar(255),
    w.reconexion::varchar(255),
    w.ajuste_tarifa::varchar(255),
    w.dist_factura::varchar(255),
    w.ajuste_alumb::varchar(255),
    w.otros_afectos::varchar(255),
    w.base_imponible::varchar(255),
    w.igv::varchar(255),
    w.tot_periodo::varchar(255),
    w.electrif_rural::varchar(255),
    w.comp_distribucion::varchar(255),
    w.comp_generadora::varchar(255),
    w.comp_interrup::varchar(255),
    w.comp_calidad::varchar(255),
    w.comp_frec_ant::varchar(255),
    w.comp_frec_des::varchar(255),
    w.comp_serv::varchar(255),
    w.comp_norma_tec::varchar(255),
    w.comp_deuda_ant::varchar(255),
    w.comp_deuda_meses::varchar(255),
    w.comp_dev_reclamo::varchar(255),
    w.comp_nota_deb_cred::varchar(255),
    w.comp_aporte_reemb::varchar(255),
    w.comp_otros_inafectos::varchar(255),
    w.comp_redondeo_act_pos::varchar(255),
    w.comp_redondeo_act_neg::varchar(255),
    w.costo_medio::varchar(255),
    w.total_a_pagar::varchar(255),
    w.valor_venta::varchar(255),
    w.deuda_anterior::varchar(255),
    w.devolucion::varchar(255),
    w.fecha_liquidacion::varchar(255),
    w.creation_user::varchar(255),
    w.creation_date::varchar(255),
    w.creation_ip::varchar(255),
    'ods.web_hm_indra_energia'::varchar(255) AS tabla_origen
  FROM ods.web_hm_indra_energia w
) t;

-----FASE 2-----
----raw 

CREATE TABLE raw.sftp_mm_pago_energia_da (
	contador_pedido varchar(255) NULL,
	organizacion_compra varchar(255) NULL,
	grupo_compra varchar(255) NULL,
	sociedad varchar(255) NULL,
	nota_al_aprobador_char_40 varchar(255) NULL,
	nombre_pedido_char_40 varchar(255) NULL,
	material varchar(255) NULL,
	texto_breve_del_material varchar(255) NULL,
	cantidad varchar(255) NULL,
	fecha_de_entrega varchar(255) NULL,
	ruc_proveedor varchar(255) NULL,
	condicion_de_pago varchar(255) NULL,
	centro varchar(255) NULL,
	tipo_posicion varchar(255) NULL,
	tipo_imputacion varchar(255) NULL,
	centro_costo varchar(255) NULL,
	orden varchar(255) NULL,
	elemento_pep varchar(255) NULL,
	area_funcional varchar(255) NULL,
	linea_negocio varchar(255) NULL,
	segmento varchar(255) NULL,
	grupo_segmento varchar(255) NULL,
	sub_segmento varchar(255) NULL,
	indicador_de_impuestos varchar(255) NULL,
	moneda varchar(255) NULL,
	licitacion varchar(255) NULL,
	precio_neto varchar(255) NULL,
	solicitante varchar(255) NULL,
	uno varchar(255) NULL,
	dos varchar(255) NULL,
	tres varchar(255) NULL,
	cuatro varchar(255) NULL,
	cinco varchar(255) NULL,
	seis varchar(255) NULL,
	siete varchar(255) NULL,
	ocho varchar(255) NULL,
	nueve varchar(255) NULL,
	diez varchar(255) NULL,
	once varchar(255) NULL,
	proveedor_flm varchar(255) NULL,
	numero_de_hoja varchar(255) NULL,
	concesionario varchar(255) NULL,
	ruc_concesionario varchar(255) NULL,
	tercero varchar(255) NULL,
	tipo_recibo varchar(255) NULL,
	zonal varchar(255) NULL,
	cliente varchar(255) NULL,
	numero_documento varchar(255) NULL,
	numero_suministro varchar(255) NULL,
	nombre_local varchar(255) NULL,
	direccion_local varchar(255) NULL,
	servicio varchar(255) NULL,
	recibo varchar(255) NULL,
	original varchar(255) NULL,
	tipo_recibo_2 varchar(255) NULL,
	tipo_voucher varchar(255) NULL,
	porcentaje_voucher varchar(255) NULL,
	importe_voucher varchar(255) NULL,
	base_imponible varchar(255) NULL,
	pago_inafectos varchar(255) NULL,
	valor_venta_total varchar(255) NULL,
	igv varchar(255) NULL,
	total_pagado varchar(255) NULL,
	fecha_emision varchar(255) NULL,
	fecha_vencimiento varchar(255) NULL,
	periodo_consumo varchar(255) NULL,
	mes_facturacion varchar(255) NULL,
	periodo_reporte varchar(255) NULL,
	observacion varchar(255) NULL,
	clase varchar(255) NULL,
	numero_sap varchar(255) NULL,
	neteo varchar(255) NULL,
	cesta varchar(255) NULL,
	orden_de_compra varchar(255) NULL,
	certificacion varchar(255) NULL,
	soles_comparativo varchar(255) NULL,
	unnamed_76 varchar(255) NULL,
	codigo_unico_local varchar(255) NULL,
	cuenta varchar(255) NULL,
	fe_valor varchar(255) NULL,
	mon varchar(255) NULL,
	importe_en_md varchar(255) NULL,
	texto varchar(255) NULL,
	asignacion varchar(255) NULL,
	deuda_mes_anterior varchar(255) NULL,
	total_pagado_recibo varchar(255) NULL
);
------

CREATE TABLE raw.sftp_mm_pago_energia_pd (
	contador_pedido varchar(255) NULL,
	organizacion_compra varchar(255) NULL,
	grupo_compra varchar(255) NULL,
	sociedad varchar(255) NULL,
	nota_al_aprobador_char_40 varchar(255) NULL,
	nombre_pedido_char_40 varchar(255) NULL,
	material varchar(255) NULL,
	texto_breve_del_material varchar(255) NULL,
	cantidad varchar(255) NULL,
	fecha_de_entrega varchar(255) NULL,
	ruc_proveedor varchar(255) NULL,
	condicion_de_pago varchar(255) NULL,
	centro varchar(255) NULL,
	tipo_posicion varchar(255) NULL,
	tipo_imputacion varchar(255) NULL,
	centro_costo varchar(255) NULL,
	orden varchar(255) NULL,
	elemento_pep varchar(255) NULL,
	area_funcional varchar(255) NULL,
	linea_negocio varchar(255) NULL,
	segmento varchar(255) NULL,
	grupo_segmento varchar(255) NULL,
	sub_segmento varchar(255) NULL,
	indicador_de_impuestos varchar(255) NULL,
	moneda varchar(255) NULL,
	licitacion varchar(255) NULL,
	precio_neto varchar(255) NULL,
	solicitante varchar(255) NULL,
	uno varchar(255) NULL,
	dos varchar(255) NULL,
	tres varchar(255) NULL,
	cuatro varchar(255) NULL,
	cinco varchar(255) NULL,
	seis varchar(255) NULL,
	siete varchar(255) NULL,
	ocho varchar(255) NULL,
	nueve varchar(255) NULL,
	diez varchar(255) NULL,
	once varchar(255) NULL,
	proveedor_flm varchar(255) NULL,
	numero_de_hoja varchar(255) NULL,
	concesionario varchar(255) NULL,
	ruc_concesionario varchar(255) NULL,
	tercero varchar(255) NULL,
	tipo_recibo varchar(255) NULL,
	zonal varchar(255) NULL,
	cliente varchar(255) NULL,
	numero_documento varchar(255) NULL,
	numero_suministro varchar(255) NULL,
	nombre_local varchar(255) NULL,
	direccion_local varchar(255) NULL,
	servicio varchar(255) NULL,
	recibo varchar(255) NULL,
	original varchar(255) NULL,
	tipo_recibo_2 varchar(255) NULL,
	tipo_voucher varchar(255) NULL,
	porcentaje_voucher varchar(255) NULL,
	importe_voucher varchar(255) NULL,
	base_imponible varchar(255) NULL,
	pago_inafectos varchar(255) NULL,
	valor_venta_total varchar(255) NULL,
	igv varchar(255) NULL,
	total_pagado varchar(255) NULL,
	fecha_emision varchar(255) NULL,
	fecha_vencimiento varchar(255) NULL,
	periodo_consumo varchar(255) NULL,
	mes_facturacion varchar(255) NULL,
	periodo_reporte varchar(255) NULL,
	observacion varchar(255) NULL,
	clase varchar(255) NULL,
	numero_sap varchar(255) NULL,
	neteo varchar(255) NULL,
	cesta varchar(255) NULL,
	orden_de_compra varchar(255) NULL,
	certificacion varchar(255) NULL,
	soles_comparativo varchar(255) NULL,
	unnamed_76 varchar(255) NULL,
	codigo_unico_local varchar(255) NULL,
	cuenta varchar(255) NULL,
	fe_valor varchar(255) NULL,
	mon varchar(255) NULL,
	importe_en_md varchar(255) NULL,
	texto varchar(255) NULL,
	asignacion varchar(255) NULL,
	deuda_mes_anterior varchar(255) NULL,
	total_pagado_recibo varchar(255) NULL
);

-------
CREATE TABLE IF NOT EXISTS raw.web_mm_autin_infogeneral (
    task_id TEXT,
    createtime TEXT,
    dispatch_time TEXT,
    accept_time TEXT,
    depart_time TEXT,
    arrive_time TEXT,
    complete_time TEXT,
    require_finish_time TEXT,
    first_complete_time TEXT,
    cancel_time TEXT,
    cancel_operator TEXT,
    cancel_reason TEXT,
    task_status TEXT,
    com_fault_speciality TEXT,
    com_fault_sub_speciality TEXT,
    com_fault_cause TEXT,
    leave_observations TEXT,
    site_id TEXT,
    site_priority TEXT,
    title TEXT,
    description TEXT,
    nro_toa TEXT,
    company_supply TEXT,
    zona TEXT,
    departamento TEXT,
    torrero TEXT,
    task_type TEXT,
    fm_office TEXT,
    region TEXT,
    site_id_name TEXT,
    site_location_type TEXT,
    sla TEXT,
    sla_status TEXT,
    suspend_state TEXT,
    create_operator TEXT,
    fault_first_occur_time TEXT,
    schedule_operator TEXT,
    schedule_time TEXT,
    assign_to_fme TEXT,
    assign_to_fme_full_name TEXT,
    dispatch_operator TEXT,
    depart_operator TEXT,
    arrive_operator TEXT,
    complete_operator TEXT,
    reject_time TEXT,
    reject_operator TEXT,
    reject_des TEXT,
    com_level_1_aff_equip TEXT,
    com_level_2_aff_equip TEXT,
    com_level_3_aff_equip TEXT,
    fault_type TEXT,
    task_category TEXT,
    task_subcategory TEXT,
    fme_contrator TEXT,
    contratista_sitio TEXT,
    complete_operator_name TEXT,
    reject_operator_name TEXT,
    arrive_operator_name TEXT,
    depart_operator_name TEXT,
    dispatch_operator_name TEXT,
    cancel_operator_name TEXT,
    schedule_operator_name TEXT,
    create_operator_name TEXT,
    situacion_encontrada TEXT,
    detalle_de_actuacion_realizada TEXT,
    atencion_incidencias TEXT,
    remedy_id TEXT,
    first_pause_time TEXT,
    first_pause_operator TEXT,
    first_pause_reason TEXT,
    first_resume_operator TEXT,
    first_resume_time TEXT,
    second_pause_time TEXT,
    second_pause_reason TEXT,
    second_pause_operator TEXT,
    second_resume_time TEXT,
    second_resume_operator TEXT,
    third_pause_time TEXT,
    third_pause_reason TEXT,
    third_pause_operator TEXT,
    third_resume_time TEXT,
    third_resume_operator TEXT,
    fourth_pause_time TEXT,
    fourth_pause_reason TEXT,
    fourth_pause_operator TEXT,
    fourth_resume_time TEXT,
    fourth_resume_operator TEXT,
    fifth_pause_time TEXT,
    fifth_pause_reason TEXT,
    fifth_pause_operator TEXT,
    fifth_resume_time TEXT,
    fifth_resume_operator TEXT,
    reject_flag TEXT,
    reject_counter TEXT,
    fuel_type TEXT
);


-- ============================================================================
-- 1) CF - BANCO DE BATERIAS
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.cf_banco_de_baterias (
    task_id                            VARCHAR(255) NOT NULL,
    site_id                            VARCHAR(255) NOT NULL,
    sub_wo_id                          VARCHAR(255) NOT NULL,

    tipo_de_banco_de_baterias          TEXT,
    servicio_que_respaldan             TEXT,
    cod_unico_eq_bat                   TEXT,
    cod_unico_cuadro_fza_rel_bb        TEXT,
    nom_cuadro_fza_asoc_banco_bat      TEXT,
    nom_sala_ubic_cuadro_fza           TEXT,
    numero_de_banco                    TEXT,
    cantidad_de_celdas                 TEXT,
    marca                              TEXT,
    modelo                             TEXT,
    estado_de_banco_de_baterias        TEXT,
    tiene_bornes_levantados            TEXT,
    tiene_alguna_celda_rajada          TEXT,
    capacidad_ah                       TEXT,
    fecha_de_instalacion               TEXT,
    cantidad_de_cables_por_polo        TEXT,
    calibre_de_cable                   TEXT,
    temperatura_numc                   TEXT,
    engrase                            TEXT,
    ajustes_reapriete_general          TEXT,
    limp_general_bornes_elem           TEXT,
    voltaje_de_flotacion               TEXT,
    corriente_de_recarga               TEXT,
    estado_bat_elem_anexos_puentes     TEXT,
    estado_bornes_cada_bat_celda       TEXT,
    estado_puentes_entre_cada_bat      TEXT,
    observ_que_bat_celdas_no           TEXT,
    medicion_de_impedancia             TEXT,
    autono_prueba_descar_contro        TEXT,
    observacion                        TEXT,
    fechacarga                         TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 2) CF - BASTIDOR DISTRIBUCION
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.cf_bastidor_distribucion (
    task_id                         VARCHAR(255) NOT NULL,
    site_id                         VARCHAR(255) NOT NULL,
    sub_wo_id                       VARCHAR(255) NOT NULL,

    cuadro_fza_que_perten_coloca    TEXT,
    numero_unidad_distri            TEXT,
    limp_ajuste_pintad_bastid       TEXT,
    verif_fusibl_e_interr           TEXT,
    verif_cables_barras_interc      TEXT,
    calculo_de_caida_de_tension     TEXT,
    corriente_de_llegada_a          TEXT,
    voltaje_de_llegada_v            TEXT,
    temper_camara_termog_c          TEXT,
    limp_calibr_medido_consum       TEXT,
    comprobacion_de_alarmas         TEXT,
    actual_diagra_unifil            TEXT,
    rotula_bastid_distri_enumer     TEXT,
    observacion                     TEXT,
    fechacarga                      TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 3) CF - CUADRO DE FUERZA
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.cf_cuadro_de_fuerza (
    task_id                             VARCHAR(255) NOT NULL,
    site_id                             VARCHAR(255) NOT NULL,
    sub_wo_id                           VARCHAR(255) NOT NULL,

    nom_cuadro_fza_ejempl_cabece        TEXT,
    nom_sala_ubic_cuadro_fza            TEXT,
    codigo_de_equipo                    TEXT,
    marca_de_cuadro_fuerza              TEXT,
    modelo_de_cuadro_de_fuerza          TEXT,
    modelo_de_unidad_rectificadora      TEXT,
    cuadro_fza_rotula_cod_unico_eq      TEXT,
    cantid_banco_bat_conect_cf          TEXT,
    capaci_total_banco_bat_conect       TEXT,
    consumo_real_de_cf_ampdc            TEXT,
    capaci_maxima_cuadro_fza            TEXT,
    capaci_actual_real_cuadro_fza       TEXT,
    cantidad_de_bastidores              TEXT,
    cantid_modulo_rectif                TEXT,
    anio_de_instalacion                 TEXT,
    estado                              TEXT,
    limpieza_y_o_cambio_de_filtros      TEXT,
    ajuste_de_terminales                TEXT,
    verif_alarma_extern                 TEXT,
    medici_corrie_unidad_baja_amp       TEXT,
    medici_voltaj_unidad_baja_v         TEXT,
    temper_camara_termog_pirome         TEXT,
    limp_ajuste_pintad_rotula_cada      TEXT,
    senali_peligr_acceso_restri         TEXT,
    estado_chapas_llaves_puerta         TEXT,
    limp_ajuste_pintad_barras           TEXT,
    verif_operac_redund                 TEXT,
    arranque_lento                      TEXT,
    alta_eficiencia                     TEXT,
    comparticion_de_carga               TEXT,
    limita_corrie_bat                   TEXT,
    limita_potenc_rectif                TEXT,
    compro_monito_local                 TEXT,
    actual_diagra_unifil                TEXT,
    regist_valor_ajuste_protec          TEXT,
    eq_rotula_cod_eq_nom_cuadro         TEXT,
    confir_correc_conex_cable           TEXT,
    nom_person_noc_energi_quien_se      TEXT,
    alarma_cableada_falla_de_red        TEXT,
    la_alarma_se_reflejo_en_el_noc      TEXT,
    alarma_cablea_grupo_electr          TEXT,
    alarma_se_reflej_noc_1              TEXT,
    alarma_cablea_falla_grupo           TEXT,
    alarma_se_reflej_noc_2              TEXT,
    alarma_cablea_alta_temper           TEXT,
    alarma_se_reflej_noc_3              TEXT,
    alarma_cablea_falla_rectif          TEXT,
    alarma_se_reflej_noc_4              TEXT,
    alarma_cablea_bajo_voltaj_bat       TEXT,
    alarma_se_reflej_noc_5              TEXT,
    alarma_cablea_bajo_nivel            TEXT,
    alarma_se_reflej_noc_6              TEXT,
    cuadro_fza_que_perten_modulo        TEXT,
    tipo_de_modulo_de_gestion           TEXT,
    marca_de_modulo_de_gestion          TEXT,
    modelo_de_modulo_de_gestion         TEXT,
    limp_ajuste_calibr_compon           TEXT,
    prueba_de_funcionamiento            TEXT,
    observacion                         TEXT,
    cod_prueba_alarma_noc               TEXT,
    fechacarga                          TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 4) CF - MODULOS RECTIFICADORES
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.cf_modulos_rectificadores (
    task_id                        VARCHAR(255) NOT NULL,
    site_id                        VARCHAR(255) NOT NULL,
    sub_wo_id                      VARCHAR(255) NOT NULL,

    cuadro_fza_que_perten_coloca   TEXT,
    posici_modulo_rectif_cf        TEXT,
    marca                          TEXT,
    modelo                         TEXT,
    estado                         TEXT,
    voltaje_de_salida              TEXT,
    corrie_salida_solo_coloca      TEXT,
    contra_lectur_medici           TEXT,
    limp_polvo_soplet_rectif       TEXT,
    observacion                    TEXT,
    fechacarga                     TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 5) CF - TABLERO AC DE CUADRO DE FU
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.cf_tablero_ac_de_cuadro_de_fu (
    task_id                           VARCHAR(255) NOT NULL,
    site_id                           VARCHAR(255) NOT NULL,
    sub_wo_id                         VARCHAR(255) NOT NULL,

    cuadro_fza_que_perten_coloca      TEXT,
    capacidad_de_itm_principal_a      TEXT,
    cantid_itm_no_inclui_interr       TEXT,
    consumo_en_interrupor_generala    TEXT,
    voltaje_en_interrupor_generala    TEXT,
    limp_pintad_tabler_corrie         TEXT,
    limp_ajuste_interr_conexi         TEXT,
    medici_verif_balanc_carga         TEXT,
    limpieza_y_calibracion_de_tvss    TEXT,
    limp_calibr_transf                TEXT,
    limp_calibr_shunt                 TEXT,
    limp_calibr_conexi_tierra         TEXT,
    medici_temper_camara_termog       TEXT,
    actual_diagra_unifil              TEXT,
    rotulacion_de_equipos             TEXT,
    observaciones                     TEXT,
    fechacarga                        TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 6) CF - DESCARGA CONTROLADA BATERÍAS
--   (columna corregida: 45_min... -> min45_medir_voltaj_bb_que)
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.cf_descarga_controlada_bater (
    task_id                          VARCHAR(255) NOT NULL,
    site_id                          VARCHAR(255) NOT NULL,
    sub_wo_id                        VARCHAR(255) NOT NULL,

    equipo_conectado_a_baterias      TEXT,
    cod_unico_cuadro_fza_ups_asoc    TEXT,
    nom_cuadro_fza_ups_asoc          TEXT,
    carga_cuadro_fuerza_adc          TEXT,
    marca_de_cuadro_de_fuerza        TEXT,
    porcen_corrie_carga_bat          TEXT,
    capacidad_total_bb_teorica_ah    TEXT,
    cantidad_bancos_bat_asociados    TEXT,

    codigo_de_bat1                   TEXT,
    capacidad_bb1_ah                 TEXT,
    marca_bb1                        TEXT,
    anio_instalacion_bb1             TEXT,

    codigo_de_bat2                   TEXT,
    capacidad_bb2_ah                 TEXT,
    marca_bb2                        TEXT,
    anio_instalacion_bb2             TEXT,

    codigo_de_bat3                   TEXT,
    capacidad_bb3_ah                 TEXT,
    marca_bb3                        TEXT,
    anio_instalacion_bb3             TEXT,

    codigo_de_bat4                   TEXT,
    capacidad_bb4_ah                 TEXT,
    marca_bb4                        TEXT,
    anio_instalacion_bb4             TEXT,

    codigo_de_bat5                   TEXT,
    capacidad_bb5_ah                 TEXT,
    marca_bb5                        TEXT,
    anio_instalacion_bb5             TEXT,

    codigo_de_bat6                   TEXT,
    capacidad_bb6_ah                 TEXT,
    marca_bb6                        TEXT,
    anio_instalacion_bb6             TEXT,

    codigo_de_bat7                   TEXT,
    capacidad_bb7_ah                 TEXT,
    marca_bb7                        TEXT,
    anio_instalacion_bb7             TEXT,

    volt_rectif_a_los_15_min_vdc     TEXT,
    carga_asume_rectif_15_min_adc    TEXT,
    carga_asume_bb1_15_min_adc       TEXT,
    carga_asume_bb2_15_min_adc       TEXT,
    carga_asume_bb3_15_min_adc       TEXT,
    carga_asume_bb4_15_min_adc       TEXT,
    carga_asume_bb5_15_min_adc       TEXT,
    carga_asume_bb6_15_min_adc       TEXT,
    carga_asume_bb7_15_min_adc       TEXT,

    volt_rectif_a_los_30_min_vdc     TEXT,
    carga_asume_rectif_30_min_adc    TEXT,
    carga_asume_bb1_30_min_adc       TEXT,
    carga_asume_bb2_30_min_adc       TEXT,
    carga_asume_bb3_30_min_adc       TEXT,
    carga_asume_bb4_30_min_adc       TEXT,
    carga_asume_bb5_30_min_adc       TEXT,
    carga_asume_bb6_30_min_adc       TEXT,
    carga_asume_bb7_30_min_adc       TEXT,

    volt_rectif_a_los_45_min_vdc     TEXT,
    carga_asume_rectif_45_min_adc    TEXT,
    carga_asume_bb1_45_min_adc       TEXT,
    carga_asume_bb2_45_min_adc       TEXT,
    carga_asume_bb3_45_min_adc       TEXT,
    carga_asume_bb4_45_min_adc       TEXT,
    carga_asume_bb5_45_min_adc       TEXT,
    carga_asume_bb6_45_min_adc       TEXT,
    carga_asume_bb7_45_min_adc       TEXT,

    min45_medir_voltaj_bb_que        TEXT,
    cuadro_fza_tiene_autono          TEXT,
    hay_algun_bb_malas_condic_que    TEXT,
    bb_en_malas_condiciones          TEXT,
    hay_alguna_celda_cuyo_v_debajo   TEXT,
    indica_numero_celdas_malas       TEXT,
    observacion_general              TEXT,
    fechacarga                       TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 7) IE - DATOS SPAT GENERAL
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.ie_datos_spat_general (
  task_id                        VARCHAR(255) NOT NULL,
  site_id                        VARCHAR(255) NOT NULL,
  sub_wo_id                      VARCHAR(255) NOT NULL,

  cantidad_de_pozos_total        TEXT,
  cantidad_de_mallas             TEXT,
  cantidad_de_pozos_unicos       TEXT,
  existe_spat_completo_para_mt   TEXT,
  pozos_varill_cables_barra      TEXT,
  report_robo_algun_compon       TEXT,
  mencionar_componentes_robados  TEXT,
  fechacarga                     TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 8) IE - MANTENIMIENTO POZO POR POZO
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.ie_mantenimiento_pozo_por_poz (
  task_id                             VARCHAR(255) NOT NULL,
  site_id                             VARCHAR(255) NOT NULL,
  sub_wo_id                           VARCHAR(255) NOT NULL,

  pozo_interv_perten_una_malla        TEXT,
  nnum_pozo_a_intervenir              TEXT,
  nnum_malla_a_intervenir             TEXT,
  sistema_que_protege                 TEXT,
  sala_o_equipos_que_protege          TEXT,
  verif_contin_pozo_otro_pozo         TEXT,
  verif_contin_pozo_barra_equipo      TEXT,
  verif_resist_menor_5_ohmios_bt      TEXT,
  limp_ajuste_conect_engras           TEXT,
  pintado_y_senalizacion              TEXT,
  estado_regist_tapas_concre          TEXT,
  cambio_repara_tapas_concre          TEXT,
  debe_echars_agua_thorge_confir      TEXT,
  debe_echars_agua_thorge_confir_1    TEXT,
  lectur_resist_despue_echar          TEXT,
  observacion                         TEXT,
  fechacarga                          TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 9) IE - SUMINISTRO DE ENERGIA
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.ie_suministro_de_energia (
  task_id                           VARCHAR(255) NOT NULL,
  site_id                           VARCHAR(255) NOT NULL,
  sub_wo_id                         VARCHAR(255) NOT NULL,

  fuente_de_energia                 TEXT,
  compania_electrica                TEXT,
  pertenencia_de_suministro         TEXT,
  tipo_de_tension_del_suministro    TEXT,
  propietario_del_suministro        TEXT,
  num_ro_de_suministro              TEXT,
  num_ro_de_medidor                 TEXT,
  num_ro_de_cliente                 TEXT,
  cantidad_de_fases                 TEXT,
  capacidad_de_itm_de_medidor_a     TEXT,
  calibr_cable_mm2_itm_tab          TEXT,
  calibr_cable_mm2_itm_conces       TEXT,
  voltaje_en_itm_v                  TEXT,
  distan_entre_sumini_estaci_m      TEXT,
  observacion                       TEXT,
  fechacarga                        TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 10) IE - TABLERO PRINCIPAL
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.ie_tablero_principal (
  task_id                         VARCHAR(255) NOT NULL,
  site_id                         VARCHAR(255) NOT NULL,
  sub_wo_id                       VARCHAR(255) NOT NULL,

  nombre_de_tablero               TEXT,
  codigo_de_equipo                TEXT,
  cantidad_de_fases               TEXT,
  capacidad_itm_general_a         TEXT,
  voltaje_l1_l2_v                 TEXT,
  voltaje_l2_l3_v                 TEXT,
  voltaje_l3_l1_v                 TEXT,
  corriente_l1_a                  TEXT,
  corriente_l2_a                  TEXT,
  corriente_l3_a                  TEXT,
  corriente_n_a                   TEXT,
  cantidad_de_itm                 TEXT,
  limp_ajuste_tabler_termin       TEXT,
  repintado_de_areas_aisladas     TEXT,
  tipo_de_cable                   TEXT,
  calibre_de_cable                TEXT,
  tablero_aterrado                TEXT,
  medir_contin_entre_cable        TEXT,
  actual_diagra_unifil            TEXT,
  regist_valor_ajuste_protec      TEXT,
  rotulacion_de_equipos           TEXT,
  observacion                     TEXT,
  fechacarga                      TIMESTAMP(0) NOT NULL
);

-- ============================================================================
-- 11) IE - TABLERO SECUNDARIO
-- ============================================================================
CREATE TABLE IF NOT EXISTS raw.ie_tablero_secundario (
  task_id                          VARCHAR(255) NOT NULL,
  site_id                          VARCHAR(255) NOT NULL,
  sub_wo_id                        VARCHAR(255) NOT NULL,

  nombre_de_tablero                TEXT,
  capacidad_itm_general_a          TEXT,
  voltaje_l1_l2_v                  TEXT,
  voltaje_l2_l3_v                  TEXT,
  voltaje_l3_l1_v                  TEXT,
  corriente_l1_a                   TEXT,
  corriente_l2_a                   TEXT,
  corriente_l3_a                   TEXT,
  corriente_n_a                    TEXT,
  limp_ajuste_estruc_metali        TEXT,
  repintado_de_areas_aisladas      TEXT,
  tipo_de_cable                    TEXT,
  calibre_de_cable                 TEXT,
  aterramiento                     TEXT,
  observacion                      TEXT,
  actual_diagra_unifil             TEXT,
  regist_valor_ajuste_protec       TEXT,
  rotulacion_de_equipos            TEXT,
  tipo_propiedad                   TEXT,
  si_tabler_es_tercer_especi_nom   TEXT,
  fechacarga                       TIMESTAMP(0) NOT NULL
);

------public ------

CREATE TABLE public.error_pago_energia (
	contador_pedido varchar(255) NULL,
	organizacion_compra varchar(255) NULL,
	grupo_compra varchar(255) NULL,
	sociedad varchar(255) NULL,
	nota_al_aprobador_char_40 varchar(255) NULL,
	nombre_pedido_char_40 varchar(255) NULL,
	material varchar(255) NULL,
	texto_breve_del_material varchar(255) NULL,
	cantidad varchar(255) NULL,
	fecha_de_entrega varchar(255) NULL,
	ruc_proveedor varchar(255) NULL,
	condicion_de_pago varchar(255) NULL,
	centro varchar(255) NULL,
	tipo_posicion varchar(255) NULL,
	tipo_imputacion varchar(255) NULL,
	centro_costo varchar(255) NULL,
	orden varchar(255) NULL,
	elemento_pep varchar(255) NULL,
	area_funcional varchar(255) NULL,
	linea_negocio varchar(255) NULL,
	segmento varchar(255) NULL,
	grupo_segmento varchar(255) NULL,
	sub_segmento varchar(255) NULL,
	indicador_de_impuestos varchar(255) NULL,
	moneda varchar(255) NULL,
	licitacion varchar(255) NULL,
	precio_neto varchar(255) NULL,
	solicitante varchar(255) NULL,
	uno varchar(255) NULL,
	dos varchar(255) NULL,
	tres varchar(255) NULL,
	cuatro varchar(255) NULL,
	cinco varchar(255) NULL,
	seis varchar(255) NULL,
	siete varchar(255) NULL,
	ocho varchar(255) NULL,
	nueve varchar(255) NULL,
	diez varchar(255) NULL,
	once varchar(255) NULL,
	proveedor_flm varchar(255) NULL,
	numero_de_hoja varchar(255) NULL,
	concesionario varchar(255) NULL,
	ruc_concesionario varchar(255) NULL,
	tercero varchar(255) NULL,
	tipo_recibo varchar(255) NULL,
	zonal varchar(255) NULL,
	cliente varchar(255) NULL,
	numero_documento varchar(255) NULL,
	numero_suministro varchar(255) NULL,
	nombre_local varchar(255) NULL,
	direccion_local varchar(255) NULL,
	servicio varchar(255) NULL,
	recibo varchar(255) NULL,
	original varchar(255) NULL,
	tipo_recibo_2 varchar(255) NULL,
	tipo_voucher varchar(255) NULL,
	porcentaje_voucher varchar(255) NULL,
	importe_voucher varchar(255) NULL,
	base_imponible varchar(255) NULL,
	pago_inafectos varchar(255) NULL,
	valor_venta_total varchar(255) NULL,
	igv varchar(255) NULL,
	total_pagado varchar(255) NULL,
	fecha_emision varchar(255) NULL,
	fecha_vencimiento varchar(255) NULL,
	periodo_consumo varchar(255) NULL,
	mes_facturacion varchar(255) NULL,
	periodo_reporte varchar(255) NULL,
	observacion varchar(255) NULL,
	clase varchar(255) NULL,
	numero_sap varchar(255) NULL,
	neteo varchar(255) NULL,
	cesta varchar(255) NULL,
	orden_de_compra varchar(255) NULL,
	certificacion varchar(255) NULL,
	soles_comparativo varchar(255) NULL,
	unnamed_76 varchar(255) NULL,
	codigo_unico_local varchar(255) NULL,
	cuenta varchar(255) NULL,
	fe_valor varchar(255) NULL,
	mon varchar(255) NULL,
	importe_en_md varchar(255) NULL,
	texto varchar(255) NULL,
	asignacion varchar(255) NULL,
	deuda_mes_anterior varchar(255) NULL,
	total_pagado_recibo varchar(255) NULL,
	fecha_carga timestamptz NOT NULL,
	tabla_origen text NOT NULL
);
---ODS TABLE 

CREATE TABLE ods.sftp_hm_pago_energia (
	contador_pedido int8 NULL,
	organizacion_compra varchar(250) NULL,
	grupo_compra int8 NULL,
	sociedad int8 NULL,
	nota_al_aprobador_char_40 varchar(250) NULL,
	nombre_pedido_char_40 varchar(250) NULL,
	material int8 NULL,
	texto_breve_del_material varchar(255) NULL,
	cantidad int8 NULL,
	fecha_de_entrega int8 NULL,
	ruc_proveedor int8 NULL,
	condicion_de_pago varchar(250) NULL,
	centro varchar(255) NULL,
	tipo_posicion varchar(250) NULL,
	tipo_imputacion varchar(250) NULL,
	centro_costo varchar(250) NULL,
	orden int8 NULL,
	elemento_pep varchar(250) NULL,
	area_funcional varchar(255) NULL,
	linea_negocio varchar(255) NULL,
	segmento varchar(255) NULL,
	grupo_segmento varchar(255) NULL,
	sub_segmento varchar(255) NULL,
	indicador_de_impuestos varchar(255) NULL,
	moneda varchar(250) NULL,
	licitacion varchar(250) NULL,
	precio_neto numeric(18, 2) NULL,
	solicitante varchar(255) NULL,
	uno varchar(255) NULL,
	dos varchar(255) NULL,
	tres varchar(255) NULL,
	cuatro varchar(255) NULL,
	cinco varchar(255) NULL,
	seis varchar(255) NULL,
	siete varchar(255) NULL,
	ocho varchar(255) NULL,
	nueve varchar(255) NULL,
	diez varchar(255) NULL,
	once varchar(255) NULL,
	proveedor_flm varchar(255) NULL,
	numero_de_hoja varchar(255) NULL,
	concesionario varchar(255) NULL,
	ruc_concesionario int8 NULL,
	tercero varchar(255) NULL,
	tipo_recibo varchar(255) NULL,
	zonal varchar(255) NULL,
	cliente varchar(255) NULL,
	numero_documento varchar(255) NULL,
	numero_suministro varchar(255) NULL,
	nombre_local varchar(255) NULL,
	direccion_local varchar(255) NULL,
	servicio varchar(255) NULL,
	recibo varchar(255) NOT NULL,
	original varchar(255) NULL,
	tipo_recibo_2 varchar(255) NULL,
	tipo_voucher varchar(255) NULL,
	porcentaje_voucher varchar(255) NULL,
	importe_voucher numeric(18, 2) NULL,
	base_imponible numeric(18, 2) NULL,
	pago_inafectos numeric(18, 2) NULL,
	valor_venta_total numeric(18, 2) NULL,
	igv numeric(18, 2) NULL,
	total_pagado numeric(18, 2) NULL,
	fecha_emision date NULL,
	fecha_vencimiento date NULL,
	periodo_consumo varchar(255) NULL,
	mes_facturacion varchar(255) NULL,
	periodo_reporte varchar(255) NULL,
	observacion varchar(255) NULL,
	clase varchar(255) NULL,
	numero_sap varchar(255) NULL,
	neteo varchar(255) NULL,
	cesta varchar(255) NULL,
	orden_de_compra varchar(255) NULL,
	certificacion varchar(255) NULL,
	soles_comparativo int8 NULL,
	unnamed_76 varchar(250) NULL,
	codigo_unico_local int8 NULL,
	cuenta int8 NULL,
	fe_valor date NULL,
	mon varchar(250) NULL,
	importe_en_md numeric(18, 2) NULL,
	texto text NULL,
	asignacion varchar(250) NULL,
	deuda_mes_anterior numeric(18, 2) NULL,
	total_pagado_recibo int8 NULL,
	creation_user varchar(100) DEFAULT (((COALESCE(inet_client_addr()::text, 'local'::text) || '-'::text) || CURRENT_USER::text)) NULL,
	creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0) without time zone NULL,
	creation_ip inet DEFAULT inet_client_addr() NULL,
	CONSTRAINT liq_recibos_de_luz_pk PRIMARY KEY (recibo)
);
----

CREATE TABLE IF NOT EXISTS ods.web_hm_autin_infogeneral (
    task_id TEXT,
    createtime timestamp,
    dispatch_time timestamp,
    accept_time timestamp,
    depart_time timestamp,
    arrive_time timestamp,
    complete_time timestamp,
    require_finish_time TEXT,
    first_complete_time timestamp,
    cancel_time timestamp,
    cancel_operator TEXT,
    cancel_reason TEXT,
    task_status TEXT,
    com_fault_speciality TEXT,
    com_fault_sub_speciality TEXT,
    com_fault_cause TEXT,
    leave_observations TEXT,
    site_id TEXT,
    site_priority TEXT,
    title TEXT,
    description TEXT,
    nro_toa TEXT,
    company_supply TEXT,
    zona TEXT,
    departamento TEXT,
    torrero TEXT,
    task_type TEXT,
    fm_office TEXT,
    region text,
    site_id_name TEXT,
    site_location_type TEXT,
    sla int8 NULL,
    sla_status TEXT,
    suspend_state TEXT,
    create_operator TEXT,
    fault_first_occur_time timestamp,
    schedule_operator TEXT,
    schedule_time timestamp,
    assign_to_fme TEXT,
    assign_to_fme_full_name TEXT,
    dispatch_operator TEXT,
    depart_operator TEXT,
    arrive_operator TEXT,
    complete_operator TEXT,
    reject_time TEXT,
    reject_operator TEXT,
    reject_des TEXT,
    com_level_1_aff_equip TEXT,
    com_level_2_aff_equip TEXT,
    com_level_3_aff_equip TEXT,
    fault_type TEXT,
    task_category TEXT,
    task_subcategory TEXT,
    fme_contrator TEXT,
    contratista_sitio TEXT,
    complete_operator_name TEXT,
    reject_operator_name text,
    arrive_operator_name text,
    depart_operator_name TEXT,
    dispatch_operator_name TEXT,
    cancel_operator_name TEXT,
    schedule_operator_name TEXT,
    create_operator_name TEXT,
    situacion_encontrada TEXT,
    detalle_de_actuacion_realizada TEXT,
    atencion_incidencias TEXT,
    remedy_id TEXT,
    first_pause_time timestamp,
    first_pause_operator TEXT,
    first_pause_reason TEXT,
    first_resume_operator TEXT,
    first_resume_time timestamp,
    second_pause_time timestamp,
    second_pause_reason TEXT,
    second_pause_operator TEXT,
    second_resume_time timestamp,
    second_resume_operator TEXT,
    third_pause_time timestamp,
    third_pause_reason TEXT,
    third_pause_operator TEXT,
    third_resume_time timestamp,
    third_resume_operator TEXT,
    fourth_pause_time timestamp,
    fourth_pause_reason TEXT,
    fourth_pause_operator TEXT,
    fourth_resume_time timestamp,
    fourth_resume_operator TEXT,
    fifth_pause_time timestamp,
    fifth_pause_reason text,
    fifth_pause_operator TEXT,
    fifth_resume_time timestamp,
    fifth_resume_operator TEXT,
    reject_flag TEXT,
    reject_counter int8 NULL,
    fuel_type text,
    creation_user varchar(100) DEFAULT ((COALESCE(inet_client_addr()::text, 'local') || '-' || CURRENT_USER::text)),
    creation_date timestamp(0) DEFAULT clock_timestamp()::timestamp(0),
    creation_ip inet DEFAULT inet_client_addr(),
    CONSTRAINT liq_task_id_de_luz_pk PRIMARY KEY (task_id)
);

-----funcion ods

CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_pago_energia_da()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_sftp_hm_pago_energia_da()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_sftp_hm_pago_energia_da()'::regprocedure::text;

  v_inserted      integer := 0;
  v_err_dups      integer := 0;
  v_err_nulos     integer := 0;
  v_err_total     integer := 0;

  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ========= 1.a) NULOS / VACÍOS en RECIBO ========= */
  WITH cand AS (
    SELECT r.*
    FROM raw.sftp_mm_pago_energia_da r
    WHERE r.recibo IS NULL
       OR btrim(r.recibo) = ''
       OR lower(btrim(r.recibo)) IN ('nan','null')
  )
  INSERT INTO public.error_pago_energia (
    contador_pedido, organizacion_compra, grupo_compra, sociedad,
    nota_al_aprobador_char_40, nombre_pedido_char_40, material, texto_breve_del_material,
    cantidad, fecha_de_entrega, ruc_proveedor, condicion_de_pago, centro, tipo_posicion,
    tipo_imputacion, centro_costo, orden, elemento_pep, area_funcional, linea_negocio,
    segmento, grupo_segmento, sub_segmento, indicador_de_impuestos, moneda, licitacion,
    precio_neto, solicitante, uno, dos, tres, cuatro, cinco, seis, siete, ocho, nueve, diez, once,
    proveedor_flm, numero_de_hoja, concesionario, ruc_concesionario, tercero,
    tipo_recibo, zonal, cliente, numero_documento, numero_suministro, nombre_local, direccion_local,
    servicio, recibo, original, tipo_recibo_2, tipo_voucher, porcentaje_voucher,
    importe_voucher, base_imponible, pago_inafectos, valor_venta_total, igv, total_pagado,
    fecha_emision, fecha_vencimiento, periodo_consumo, mes_facturacion, periodo_reporte,
    observacion, clase, numero_sap, neteo, cesta, orden_de_compra, certificacion,
    soles_comparativo, unnamed_76, codigo_unico_local, cuenta, fe_valor, mon,
    importe_en_md, texto, asignacion, deuda_mes_anterior, total_pagado_recibo,
    fecha_carga, tabla_origen
  )
  SELECT
    r.contador_pedido, r.organizacion_compra, r.grupo_compra, r.sociedad,
    r.nota_al_aprobador_char_40, r.nombre_pedido_char_40, r.material, r.texto_breve_del_material,
    r.cantidad, r.fecha_de_entrega, r.ruc_proveedor, r.condicion_de_pago, r.centro, r.tipo_posicion,
    r.tipo_imputacion, r.centro_costo, r.orden, r.elemento_pep, r.area_funcional, r.linea_negocio,
    r.segmento, r.grupo_segmento, r.sub_segmento, r.indicador_de_impuestos, r.moneda, r.licitacion,
    r.precio_neto, r.solicitante, r.uno, r.dos, r.tres, r.cuatro, r.cinco, r.seis, r.siete, r.ocho, r.nueve, r.diez, r.once,
    r.proveedor_flm, r.numero_de_hoja, r.concesionario, r.ruc_concesionario, r.tercero,
    r.tipo_recibo, r.zonal, r.cliente, r.numero_documento, r.numero_suministro, r.nombre_local, r.direccion_local,
    r.servicio, r.recibo, r.original, r.tipo_recibo_2, r.tipo_voucher, r.porcentaje_voucher,
    r.importe_voucher, r.base_imponible, r.pago_inafectos, r.valor_venta_total, r.igv, r.total_pagado,
    r.fecha_emision, r.fecha_vencimiento, r.periodo_consumo, r.mes_facturacion, r.periodo_reporte,
    r.observacion, r.clase, r.numero_sap, r.neteo, r.cesta, r.orden_de_compra, r.certificacion,
    r.soles_comparativo, r.unnamed_76, r.codigo_unico_local, r.cuenta, r.fe_valor, r.mon,
    r.importe_en_md, r.texto, r.asignacion, r.deuda_mes_anterior, r.total_pagado_recibo,
    clock_timestamp(), 'raw.sftp_mm_pago_energia_da'
  FROM cand r
  LEFT JOIN public.error_pago_energia e
         ON ( (e.recibo IS NULL AND r.recibo IS NULL) OR e.recibo = r.recibo )
        AND e.tabla_origen = 'raw.sftp_mm_pago_energia_da'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.fecha_carga IS NULL;

  GET DIAGNOSTICS v_err_nulos = ROW_COUNT;

  -- Borro NULOS/VACÍOS de RAW
  WITH rid_nulos AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_pago_energia_da r
    WHERE r.recibo IS NULL
       OR btrim(r.recibo) = ''
       OR lower(btrim(r.recibo)) IN ('nan','null')
  )
  DELETE FROM raw.sftp_mm_pago_energia_da r
  USING rid_nulos x
  WHERE r.ctid = x.rid;

  /* ========= 1.b) DUPLICADOS EXACTOS por RECIBO ========= */
  WITH claves_dup AS (
    SELECT r.recibo
    FROM raw.sftp_mm_pago_energia_da r
    GROUP BY r.recibo
    HAVING COUNT(*) > 1
  ),
  cand_dups AS (
    SELECT r.*
    FROM raw.sftp_mm_pago_energia_da r
    JOIN claves_dup d ON d.recibo = r.recibo
  )
  INSERT INTO public.error_pago_energia (
    contador_pedido, organizacion_compra, grupo_compra, sociedad,
    nota_al_aprobador_char_40, nombre_pedido_char_40, material, texto_breve_del_material,
    cantidad, fecha_de_entrega, ruc_proveedor, condicion_de_pago, centro, tipo_posicion,
    tipo_imputacion, centro_costo, orden, elemento_pep, area_funcional, linea_negocio,
    segmento, grupo_segmento, sub_segmento, indicador_de_impuestos, moneda, licitacion,
    precio_neto, solicitante, uno, dos, tres, cuatro, cinco, seis, siete, ocho, nueve, diez, once,
    proveedor_flm, numero_de_hoja, concesionario, ruc_concesionario, tercero,
    tipo_recibo, zonal, cliente, numero_documento, numero_suministro, nombre_local, direccion_local,
    servicio, recibo, original, tipo_recibo_2, tipo_voucher, porcentaje_voucher,
    importe_voucher, base_imponible, pago_inafectos, valor_venta_total, igv, total_pagado,
    fecha_emision, fecha_vencimiento, periodo_consumo, mes_facturacion, periodo_reporte,
    observacion, clase, numero_sap, neteo, cesta, orden_de_compra, certificacion,
    soles_comparativo, unnamed_76, codigo_unico_local, cuenta, fe_valor, mon,
    importe_en_md, texto, asignacion, deuda_mes_anterior, total_pagado_recibo,
    fecha_carga, tabla_origen
  )
  SELECT
    r.contador_pedido, r.organizacion_compra, r.grupo_compra, r.sociedad,
    r.nota_al_aprobador_char_40, r.nombre_pedido_char_40, r.material, r.texto_breve_del_material,
    r.cantidad, r.fecha_de_entrega, r.ruc_proveedor, r.condicion_de_pago, r.centro, r.tipo_posicion,
    r.tipo_imputacion, r.centro_costo, r.orden, r.elemento_pep, r.area_funcional, r.linea_negocio,
    r.segmento, r.grupo_segmento, r.sub_segmento, r.indicador_de_impuestos, r.moneda, r.licitacion,
    r.precio_neto, r.solicitante, r.uno, r.dos, r.tres, r.cuatro, r.cinco, r.seis, r.siete, r.ocho, r.nueve, r.diez, r.once,
    r.proveedor_flm, r.numero_de_hoja, r.concesionario, r.ruc_concesionario, r.tercero,
    r.tipo_recibo, r.zonal, r.cliente, r.numero_documento, r.numero_suministro, r.nombre_local, r.direccion_local,
    r.servicio, r.recibo, r.original, r.tipo_recibo_2, r.tipo_voucher, r.porcentaje_voucher,
    r.importe_voucher, r.base_imponible, r.pago_inafectos, r.valor_venta_total, r.igv, r.total_pagado,
    r.fecha_emision, r.fecha_vencimiento, r.periodo_consumo, r.mes_facturacion, r.periodo_reporte,
    r.observacion, r.clase, r.numero_sap, r.neteo, r.cesta, r.orden_de_compra, r.certificacion,
    r.soles_comparativo, r.unnamed_76, r.codigo_unico_local, r.cuenta, r.fe_valor, r.mon,
    r.importe_en_md, r.texto, r.asignacion, r.deuda_mes_anterior, r.total_pagado_recibo,
    clock_timestamp(), 'raw.sftp_mm_pago_energia_da'
  FROM cand_dups r
  LEFT JOIN public.error_pago_energia e
         ON e.recibo = r.recibo
        AND e.tabla_origen = 'raw.sftp_mm_pago_energia_da'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.recibo IS NULL;

  GET DIAGNOSTICS v_err_dups = ROW_COUNT;

  -- Borro duplicados por RECIBO de RAW (se envían sólo a error)
  WITH claves_dup AS (
    SELECT r.recibo
    FROM raw.sftp_mm_pago_energia_da r
    GROUP BY r.recibo
    HAVING COUNT(*) > 1
  ),
  rid_dup AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_pago_energia_da r
    JOIN claves_dup d ON d.recibo = r.recibo
  )
  DELETE FROM raw.sftp_mm_pago_energia_da r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  v_err_total := COALESCE(v_err_dups,0) + COALESCE(v_err_nulos,0);

  /* ========= 2) TRANSFORMACIÓN + DEDUP + CARGA A ODS ========= */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      trunc(public.try_numeric(r.contador_pedido))::bigint    AS contador_pedido,
      NULLIF(NULLIF(btrim(r.organizacion_compra),'NaN'),'')::varchar(250) AS organizacion_compra,
      trunc(public.try_numeric(r.grupo_compra))::bigint       AS grupo_compra,
      trunc(public.try_numeric(r.sociedad))::bigint           AS sociedad,
      NULLIF(NULLIF(btrim(r.nota_al_aprobador_char_40),'NaN'),'')::varchar(250) AS nota_al_aprobador_char_40,
      NULLIF(NULLIF(btrim(r.nombre_pedido_char_40),'NaN'),'')::varchar(250)    AS nombre_pedido_char_40,
      trunc(public.try_numeric(r.material))::bigint           AS material,
      NULLIF(NULLIF(btrim(r.texto_breve_del_material),'NaN'),'')::varchar(255) AS texto_breve_del_material,
      trunc(public.try_numeric(r.cantidad))::bigint           AS cantidad,
      trunc(public.try_numeric(r.fecha_de_entrega))::bigint   AS fecha_de_entrega,   -- en ODS es int8
      trunc(public.try_numeric(r.ruc_proveedor))::bigint      AS ruc_proveedor,
      NULLIF(NULLIF(btrim(r.condicion_de_pago),'NaN'),'')::varchar(250)  AS condicion_de_pago,
      NULLIF(NULLIF(btrim(r.centro),'NaN'),'')::varchar(255)  AS centro,
      NULLIF(NULLIF(btrim(r.tipo_posicion),'NaN'),'')::varchar(250)      AS tipo_posicion,
      NULLIF(NULLIF(btrim(r.tipo_imputacion),'NaN'),'')::varchar(250)    AS tipo_imputacion,
      NULLIF(NULLIF(btrim(r.centro_costo),'NaN'),'')::varchar(250)       AS centro_costo,
      trunc(public.try_numeric(r.orden))::bigint              AS orden,
      NULLIF(NULLIF(btrim(r.elemento_pep),'NaN'),'')::varchar(250)       AS elemento_pep,
      NULLIF(NULLIF(btrim(r.area_funcional),'NaN'),'')::varchar(255)     AS area_funcional,
      NULLIF(NULLIF(btrim(r.linea_negocio),'NaN'),'')::varchar(255)      AS linea_negocio,
      NULLIF(NULLIF(btrim(r.segmento),'NaN'),'')::varchar(255)           AS segmento,
      NULLIF(NULLIF(btrim(r.grupo_segmento),'NaN'),'')::varchar(255)     AS grupo_segmento,
      NULLIF(NULLIF(btrim(r.sub_segmento),'NaN'),'')::varchar(255)       AS sub_segmento,
      NULLIF(NULLIF(btrim(r.indicador_de_impuestos),'NaN'),'')::varchar(255) AS indicador_de_impuestos,
      NULLIF(NULLIF(btrim(r.moneda),'NaN'),'')::varchar(250)  AS moneda,
      NULLIF(NULLIF(btrim(r.licitacion),'NaN'),'')::varchar(250) AS licitacion,
      public.try_numeric(r.precio_neto)::numeric(18,2)        AS precio_neto,
      NULLIF(NULLIF(btrim(r.solicitante),'NaN'),'')::varchar(255) AS solicitante,
      NULLIF(NULLIF(btrim(r.uno),'NaN'),'')::varchar(255)     AS uno,
      NULLIF(NULLIF(btrim(r.dos),'NaN'),'')::varchar(255)     AS dos,
      NULLIF(NULLIF(btrim(r.tres),'NaN'),'')::varchar(255)    AS tres,
      NULLIF(NULLIF(btrim(r.cuatro),'NaN'),'')::varchar(255)  AS cuatro,
      NULLIF(NULLIF(btrim(r.cinco),'NaN'),'')::varchar(255)   AS cinco,
      NULLIF(NULLIF(btrim(r.seis),'NaN'),'')::varchar(255)    AS seis,
      NULLIF(NULLIF(btrim(r.siete),'NaN'),'')::varchar(255)   AS siete,
      NULLIF(NULLIF(btrim(r.ocho),'NaN'),'')::varchar(255)    AS ocho,
      NULLIF(NULLIF(btrim(r.nueve),'NaN'),'')::varchar(255)   AS nueve,
      NULLIF(NULLIF(btrim(r.diez),'NaN'),'')::varchar(255)    AS diez,
      NULLIF(NULLIF(btrim(r.once),'NaN'),'')::varchar(255)    AS once,
      NULLIF(NULLIF(btrim(r.proveedor_flm),'NaN'),'')::varchar(255) AS proveedor_flm,
      NULLIF(NULLIF(btrim(r.numero_de_hoja),'NaN'),'')::varchar(255)   AS numero_de_hoja,
      NULLIF(NULLIF(btrim(r.concesionario),'NaN'),'')::varchar(255)    AS concesionario,
      trunc(public.try_numeric(r.ruc_concesionario))::bigint  AS ruc_concesionario,
      NULLIF(NULLIF(btrim(r.tercero),'NaN'),'')::varchar(255) AS tercero,
      NULLIF(NULLIF(btrim(r.tipo_recibo),'NaN'),'')::varchar(255)  AS tipo_recibo,
      NULLIF(NULLIF(btrim(r.zonal),'NaN'),'')::varchar(255)   AS zonal,
      NULLIF(NULLIF(btrim(r.cliente),'NaN'),'')::varchar(255) AS cliente,
      NULLIF(NULLIF(btrim(r.numero_documento),'NaN'),'')::varchar(255)  AS numero_documento,
      NULLIF(NULLIF(btrim(r.numero_suministro),'NaN'),'')::varchar(255) AS numero_suministro,
      NULLIF(NULLIF(btrim(r.nombre_local),'NaN'),'')::varchar(255)      AS nombre_local,
      NULLIF(NULLIF(btrim(r.direccion_local),'NaN'),'')::varchar(255)   AS direccion_local,
      NULLIF(NULLIF(btrim(r.servicio),'NaN'),'')::varchar(255)          AS servicio,

      CASE
        WHEN r.recibo IS NULL OR btrim(r.recibo) = '' OR lower(btrim(r.recibo)) IN ('nan','null') THEN NULL
        ELSE left(btrim(r.recibo), 255)
      END::varchar(255) AS recibo,

      NULLIF(NULLIF(btrim(r.original),'NaN'),'')::varchar(255)       AS original,
      NULLIF(NULLIF(btrim(r.tipo_recibo_2),'NaN'),'')::varchar(255)  AS tipo_recibo_2,
      NULLIF(NULLIF(btrim(r.tipo_voucher),'NaN'),'')::varchar(255)   AS tipo_voucher,
      NULLIF(NULLIF(btrim(r.porcentaje_voucher),'NaN'),'')::varchar(255) AS porcentaje_voucher,

      public.try_numeric(r.importe_voucher)::numeric(18,2)    AS importe_voucher,
      public.try_numeric(r.base_imponible)::numeric(18,2)     AS base_imponible,
      public.try_numeric(r.pago_inafectos)::numeric(18,2)     AS pago_inafectos,
      public.try_numeric(r.valor_venta_total)::numeric(18,2)  AS valor_venta_total,
      public.try_numeric(r.igv)::numeric(18,2)                AS igv,
      public.try_numeric(r.total_pagado)::numeric(18,2)       AS total_pagado,

      CASE
        WHEN r.fecha_emision IS NULL OR btrim(r.fecha_emision) = '' OR lower(btrim(r.fecha_emision)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_emision) > 0 THEN to_date(split_part(r.fecha_emision,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_emision,' ',1), 'YYYY-MM-DD')
      END AS fecha_emision,

      CASE
        WHEN r.fecha_vencimiento IS NULL OR btrim(r.fecha_vencimiento) = '' OR lower(btrim(r.fecha_vencimiento)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_vencimiento) > 0 THEN to_date(split_part(r.fecha_vencimiento,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_vencimiento,' ',1), 'YYYY-MM-DD')
      END AS fecha_vencimiento,

      NULLIF(NULLIF(btrim(r.periodo_consumo),'NaN'),'')::varchar(255)  AS periodo_consumo,
      NULLIF(NULLIF(btrim(r.mes_facturacion),'NaN'),'')::varchar(255)  AS mes_facturacion,
      NULLIF(NULLIF(btrim(r.periodo_reporte),'NaN'),'')::varchar(255)  AS periodo_reporte,
      NULLIF(NULLIF(btrim(r.observacion),'NaN'),'')::varchar(255)      AS observacion,
      NULLIF(NULLIF(btrim(r.clase),'NaN'),'')::varchar(255)            AS clase,
      NULLIF(NULLIF(btrim(r.numero_sap),'NaN'),'')::varchar(255)       AS numero_sap,
      NULLIF(NULLIF(btrim(r.neteo),'NaN'),'')::varchar(255)            AS neteo,
      NULLIF(NULLIF(btrim(r.cesta),'NaN'),'')::varchar(255)            AS cesta,
      NULLIF(NULLIF(btrim(r.orden_de_compra),'NaN'),'')::varchar(255)  AS orden_de_compra,
      NULLIF(NULLIF(btrim(r.certificacion),'NaN'),'')::varchar(255)    AS certificacion,

      trunc(public.try_numeric(r.soles_comparativo))::bigint   AS soles_comparativo,
      NULLIF(NULLIF(btrim(r.unnamed_76),'NaN'),'')::varchar(250) AS unnamed_76,
      trunc(public.try_numeric(r.codigo_unico_local))::bigint  AS codigo_unico_local,
      trunc(public.try_numeric(r.cuenta))::bigint              AS cuenta,

      CASE
        WHEN r.fe_valor IS NULL OR btrim(r.fe_valor) = '' OR lower(btrim(r.fe_valor)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fe_valor) > 0 THEN to_date(split_part(r.fe_valor,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fe_valor,' ',1), 'YYYY-MM-DD')
      END AS fe_valor,

      NULLIF(NULLIF(btrim(r.mon),'NaN'),'')::varchar(250)      AS mon,
      public.try_numeric(r.importe_en_md)::numeric(18,2)       AS importe_en_md,
      NULLIF(btrim(r.texto),'')::text                          AS texto,
      NULLIF(NULLIF(btrim(r.asignacion),'NaN'),'')::varchar(250) AS asignacion,
      public.try_numeric(r.deuda_mes_anterior)::numeric(18,2)  AS deuda_mes_anterior,
      trunc(public.try_numeric(r.total_pagado_recibo))::bigint AS total_pagado_recibo

    FROM raw.sftp_mm_pago_energia_da r
  ),
  dedup AS (
    -- PK ODS: recibo (conserva primera aparición)
    SELECT DISTINCT ON (recibo) *
    FROM base
    WHERE recibo IS NOT NULL
    ORDER BY recibo, rid
  )
  INSERT INTO ods.sftp_hm_pago_energia (
    contador_pedido, organizacion_compra, grupo_compra, sociedad,
    nota_al_aprobador_char_40, nombre_pedido_char_40, material, texto_breve_del_material,
    cantidad, fecha_de_entrega, ruc_proveedor, condicion_de_pago, centro, tipo_posicion,
    tipo_imputacion, centro_costo, orden, elemento_pep, area_funcional, linea_negocio,
    segmento, grupo_segmento, sub_segmento, indicador_de_impuestos, moneda, licitacion,
    precio_neto, solicitante, uno, dos, tres, cuatro, cinco, seis, siete, ocho, nueve, diez, once,
    proveedor_flm, numero_de_hoja, concesionario, ruc_concesionario, tercero,
    tipo_recibo, zonal, cliente, numero_documento, numero_suministro, nombre_local, direccion_local,
    servicio, recibo, original, tipo_recibo_2, tipo_voucher, porcentaje_voucher,
    importe_voucher, base_imponible, pago_inafectos, valor_venta_total, igv, total_pagado,
    fecha_emision, fecha_vencimiento, periodo_consumo, mes_facturacion, periodo_reporte,
    observacion, clase, numero_sap, neteo, cesta, orden_de_compra, certificacion,
    soles_comparativo, unnamed_76, codigo_unico_local, cuenta, fe_valor, mon,
    importe_en_md, texto, asignacion, deuda_mes_anterior, total_pagado_recibo
  )
  SELECT
    d.contador_pedido, d.organizacion_compra, d.grupo_compra, d.sociedad,
    d.nota_al_aprobador_char_40, d.nombre_pedido_char_40, d.material, d.texto_breve_del_material,
    d.cantidad, d.fecha_de_entrega, d.ruc_proveedor, d.condicion_de_pago, d.centro, d.tipo_posicion,
    d.tipo_imputacion, d.centro_costo, d.orden, d.elemento_pep, d.area_funcional, d.linea_negocio,
    d.segmento, d.grupo_segmento, d.sub_segmento, d.indicador_de_impuestos, d.moneda, d.licitacion,
    d.precio_neto, d.solicitante, d.uno, d.dos, d.tres, d.cuatro, d.cinco, d.seis, d.siete, d.ocho, d.nueve, d.diez, d.once,
    d.proveedor_flm, d.numero_de_hoja, d.concesionario, d.ruc_concesionario, d.tercero,
    d.tipo_recibo, d.zonal, d.cliente, d.numero_documento, d.numero_suministro, d.nombre_local, d.direccion_local,
    d.servicio, d.recibo, d.original, d.tipo_recibo_2, d.tipo_voucher, d.porcentaje_voucher,
    d.importe_voucher, d.base_imponible, d.pago_inafectos, d.valor_venta_total, d.igv, d.total_pagado,
    d.fecha_emision, d.fecha_vencimiento, d.periodo_consumo, d.mes_facturacion, d.periodo_reporte,
    d.observacion, d.clase, d.numero_sap, d.neteo, d.cesta, d.orden_de_compra, d.certificacion,
    d.soles_comparativo, d.unnamed_76, d.codigo_unico_local, d.cuenta, d.fe_valor, d.mon,
    d.importe_en_md, d.texto, d.asignacion, d.deuda_mes_anterior, d.total_pagado_recibo
  FROM dedup d
  LEFT JOIN ods.sftp_hm_pago_energia o
    ON o.recibo = d.recibo
  WHERE o.recibo IS NULL;

  GET DIAGNOSTICS v_inserted = ROW_COUNT;

  v_estado := 'DONE';
  v_msj := format(
    'Insertados en ODS: %s | Enviados a public.error_pago_energia (hoy): %s (duplicados recibo: %s, nulos/vacíos recibo: %s) | Origen: raw.sftp_mm_pago_energia_da.',
    v_inserted, COALESCE(v_err_total,0), COALESCE(v_err_dups,0), COALESCE(v_err_nulos,0)
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => NULL::integer,
    p_deleted    => NULL::integer,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj    := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;
-------

CREATE OR REPLACE PROCEDURE ods.sp_cargar_sftp_hm_pago_energia_pd()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio        timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp         integer      := 'ods.sp_cargar_sftp_hm_pago_energia_pd()'::regprocedure::oid::int;
  v_sp_name       text         := 'ods.sp_cargar_sftp_hm_pago_energia_pd()'::regprocedure::text;

  v_inserted      integer := 0;
  v_err_dups      integer := 0;
  v_err_nulos     integer := 0;
  v_err_total     integer := 0;

  v_estado        varchar(50);
  v_msj           text;
BEGIN
  /* ========= 1.a) NULOS / VACÍOS en RECIBO ========= */
  WITH cand AS (
    SELECT r.*
    FROM raw.sftp_mm_pago_energia_pd r
    WHERE r.recibo IS NULL
       OR btrim(r.recibo) = ''
       OR lower(btrim(r.recibo)) IN ('nan','null')
  )
  INSERT INTO public.error_pago_energia (
    contador_pedido, organizacion_compra, grupo_compra, sociedad,
    nota_al_aprobador_char_40, nombre_pedido_char_40, material, texto_breve_del_material,
    cantidad, fecha_de_entrega, ruc_proveedor, condicion_de_pago, centro, tipo_posicion,
    tipo_imputacion, centro_costo, orden, elemento_pep, area_funcional, linea_negocio,
    segmento, grupo_segmento, sub_segmento, indicador_de_impuestos, moneda, licitacion,
    precio_neto, solicitante, uno, dos, tres, cuatro, cinco, seis, siete, ocho, nueve, diez, once,
    proveedor_flm, numero_de_hoja, concesionario, ruc_concesionario, tercero,
    tipo_recibo, zonal, cliente, numero_documento, numero_suministro, nombre_local, direccion_local,
    servicio, recibo, original, tipo_recibo_2, tipo_voucher, porcentaje_voucher,
    importe_voucher, base_imponible, pago_inafectos, valor_venta_total, igv, total_pagado,
    fecha_emision, fecha_vencimiento, periodo_consumo, mes_facturacion, periodo_reporte,
    observacion, clase, numero_sap, neteo, cesta, orden_de_compra, certificacion,
    soles_comparativo, unnamed_76, codigo_unico_local, cuenta, fe_valor, mon,
    importe_en_md, texto, asignacion, deuda_mes_anterior, total_pagado_recibo,
    fecha_carga, tabla_origen
  )
  SELECT
    r.contador_pedido, r.organizacion_compra, r.grupo_compra, r.sociedad,
    r.nota_al_aprobador_char_40, r.nombre_pedido_char_40, r.material, r.texto_breve_del_material,
    r.cantidad, r.fecha_de_entrega, r.ruc_proveedor, r.condicion_de_pago, r.centro, r.tipo_posicion,
    r.tipo_imputacion, r.centro_costo, r.orden, r.elemento_pep, r.area_funcional, r.linea_negocio,
    r.segmento, r.grupo_segmento, r.sub_segmento, r.indicador_de_impuestos, r.moneda, r.licitacion,
    r.precio_neto, r.solicitante, r.uno, r.dos, r.tres, r.cuatro, r.cinco, r.seis, r.siete, r.ocho, r.nueve, r.diez, r.once,
    r.proveedor_flm, r.numero_de_hoja, r.concesionario, r.ruc_concesionario, r.tercero,
    r.tipo_recibo, r.zonal, r.cliente, r.numero_documento, r.numero_suministro, r.nombre_local, r.direccion_local,
    r.servicio, r.recibo, r.original, r.tipo_recibo_2, r.tipo_voucher, r.porcentaje_voucher,
    r.importe_voucher, r.base_imponible, r.pago_inafectos, r.valor_venta_total, r.igv, r.total_pagado,
    r.fecha_emision, r.fecha_vencimiento, r.periodo_consumo, r.mes_facturacion, r.periodo_reporte,
    r.observacion, r.clase, r.numero_sap, r.neteo, r.cesta, r.orden_de_compra, r.certificacion,
    r.soles_comparativo, r.unnamed_76, r.codigo_unico_local, r.cuenta, r.fe_valor, r.mon,
    r.importe_en_md, r.texto, r.asignacion, r.deuda_mes_anterior, r.total_pagado_recibo,
    clock_timestamp(), 'raw.sftp_mm_pago_energia_pd'
  FROM cand r
  LEFT JOIN public.error_pago_energia e
         ON ( (e.recibo IS NULL AND r.recibo IS NULL) OR e.recibo = r.recibo )
        AND e.tabla_origen = 'raw.sftp_mm_pago_energia_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.fecha_carga IS NULL;

  GET DIAGNOSTICS v_err_nulos = ROW_COUNT;

  -- Borro NULOS/VACÍOS de RAW
  WITH rid_nulos AS (
    SELECT r.ctid AS rid
    FROM raw.sftp_mm_pago_energia_pd r
    WHERE r.recibo IS NULL
       OR btrim(r.recibo) = ''
       OR lower(btrim(r.recibo)) IN ('nan','null')
  )
  DELETE FROM raw.sftp_mm_pago_energia_pd r
  USING rid_nulos x
  WHERE r.ctid = x.rid;

  /* ========= 1.b) DUPLICADOS por RECIBO (normalizado como ODS) ========= */
  WITH norm AS (
    SELECT r.ctid AS rid,
           LOWER(LEFT(BTRIM(r.recibo),255)) AS k_recibo,
           r.*
    FROM raw.sftp_mm_pago_energia_pd r
    WHERE r.recibo IS NOT NULL AND BTRIM(r.recibo) <> '' AND LOWER(BTRIM(r.recibo)) NOT IN ('nan','null')
  ),
  claves_dup AS (
    SELECT k_recibo
    FROM norm
    GROUP BY k_recibo
    HAVING COUNT(*) > 1
  ),
  cand_dups AS (
    SELECT n.*
    FROM norm n
    JOIN claves_dup d ON d.k_recibo = n.k_recibo
  )
  INSERT INTO public.error_pago_energia (
    contador_pedido, organizacion_compra, grupo_compra, sociedad,
    nota_al_aprobador_char_40, nombre_pedido_char_40, material, texto_breve_del_material,
    cantidad, fecha_de_entrega, ruc_proveedor, condicion_de_pago, centro, tipo_posicion,
    tipo_imputacion, centro_costo, orden, elemento_pep, area_funcional, linea_negocio,
    segmento, grupo_segmento, sub_segmento, indicador_de_impuestos, moneda, licitacion,
    precio_neto, solicitante, uno, dos, tres, cuatro, cinco, seis, siete, ocho, nueve, diez, once,
    proveedor_flm, numero_de_hoja, concesionario, ruc_concesionario, tercero,
    tipo_recibo, zonal, cliente, numero_documento, numero_suministro, nombre_local, direccion_local,
    servicio, recibo, original, tipo_recibo_2, tipo_voucher, porcentaje_voucher,
    importe_voucher, base_imponible, pago_inafectos, valor_venta_total, igv, total_pagado,
    fecha_emision, fecha_vencimiento, periodo_consumo, mes_facturacion, periodo_reporte,
    observacion, clase, numero_sap, neteo, cesta, orden_de_compra, certificacion,
    soles_comparativo, unnamed_76, codigo_unico_local, cuenta, fe_valor, mon,
    importe_en_md, texto, asignacion, deuda_mes_anterior, total_pagado_recibo,
    fecha_carga, tabla_origen
  )
  SELECT
    r.contador_pedido, r.organizacion_compra, r.grupo_compra, r.sociedad,
    r.nota_al_aprobador_char_40, r.nombre_pedido_char_40, r.material, r.texto_breve_del_material,
    r.cantidad, r.fecha_de_entrega, r.ruc_proveedor, r.condicion_de_pago, r.centro, r.tipo_posicion,
    r.tipo_imputacion, r.centro_costo, r.orden, r.elemento_pep, r.area_funcional, r.linea_negocio,
    r.segmento, r.grupo_segmento, r.sub_segmento, r.indicador_de_impuestos, r.moneda, r.licitacion,
    r.precio_neto, r.solicitante, r.uno, r.dos, r.tres, r.cuatro, r.cinco, r.seis, r.siete, r.ocho, r.nueve, r.diez, r.once,
    r.proveedor_flm, r.numero_de_hoja, r.concesionario, r.ruc_concesionario, r.tercero,
    r.tipo_recibo, r.zonal, r.cliente, r.numero_documento, r.numero_suministro, r.nombre_local, r.direccion_local,
    r.servicio, r.recibo, r.original, r.tipo_recibo_2, r.tipo_voucher, r.porcentaje_voucher,
    r.importe_voucher, r.base_imponible, r.pago_inafectos, r.valor_venta_total, r.igv, r.total_pagado,
    r.fecha_emision, r.fecha_vencimiento, r.periodo_consumo, r.mes_facturacion, r.periodo_reporte,
    r.observacion, r.clase, r.numero_sap, r.neteo, r.cesta, r.orden_de_compra, r.certificacion,
    r.soles_comparativo, r.unnamed_76, r.codigo_unico_local, r.cuenta, r.fe_valor, r.mon,
    r.importe_en_md, r.texto, r.asignacion, r.deuda_mes_anterior, r.total_pagado_recibo,
    clock_timestamp(), 'raw.sftp_mm_pago_energia_pd'
  FROM cand_dups r
  LEFT JOIN public.error_pago_energia e
         ON LOWER(LEFT(BTRIM(e.recibo),255)) = LOWER(LEFT(BTRIM(r.recibo),255))
        AND e.tabla_origen = 'raw.sftp_mm_pago_energia_pd'
        AND e.fecha_carga::date = clock_timestamp()::date
  WHERE e.recibo IS NULL;

  GET DIAGNOSTICS v_err_dups = ROW_COUNT;

  -- Borro duplicados normalizados de RAW (si no hay, no elimina nada)
  WITH norm AS (
    SELECT r.ctid AS rid, LOWER(LEFT(BTRIM(r.recibo),255)) AS k_recibo
    FROM raw.sftp_mm_pago_energia_pd r
    WHERE r.recibo IS NOT NULL AND BTRIM(r.recibo) <> '' AND LOWER(BTRIM(r.recibo)) NOT IN ('nan','null')
  ),
  claves_dup AS ( SELECT k_recibo FROM norm GROUP BY k_recibo HAVING COUNT(*) > 1 ),
  rid_dup AS (
    SELECT n.rid
    FROM norm n
    JOIN claves_dup d ON d.k_recibo = n.k_recibo
  )
  DELETE FROM raw.sftp_mm_pago_energia_pd r
  USING rid_dup x
  WHERE r.ctid = x.rid;

  v_err_total := COALESCE(v_err_dups,0) + COALESCE(v_err_nulos,0);

  /* ========= 2) TRANSFORMACIÓN + DEDUP + CARGA A ODS ========= */
  WITH base AS (
    SELECT
      r.ctid AS rid,

      trunc(public.try_numeric(r.contador_pedido))::bigint    AS contador_pedido,
      NULLIF(NULLIF(btrim(r.organizacion_compra),'NaN'),'')::varchar(250) AS organizacion_compra,
      trunc(public.try_numeric(r.grupo_compra))::bigint       AS grupo_compra,
      trunc(public.try_numeric(r.sociedad))::bigint           AS sociedad,
      NULLIF(NULLIF(btrim(r.nota_al_aprobador_char_40),'NaN'),'')::varchar(250) AS nota_al_aprobador_char_40,
      NULLIF(NULLIF(btrim(r.nombre_pedido_char_40),'NaN'),'')::varchar(250)    AS nombre_pedido_char_40,
      trunc(public.try_numeric(r.material))::bigint           AS material,
      NULLIF(NULLIF(btrim(r.texto_breve_del_material),'NaN'),'')::varchar(255) AS texto_breve_del_material,
      trunc(public.try_numeric(r.cantidad))::bigint           AS cantidad,
      trunc(public.try_numeric(r.fecha_de_entrega))::bigint   AS fecha_de_entrega,
      trunc(public.try_numeric(r.ruc_proveedor))::bigint      AS ruc_proveedor,
      NULLIF(NULLIF(btrim(r.condicion_de_pago),'NaN'),'')::varchar(250)  AS condicion_de_pago,
      NULLIF(NULLIF(btrim(r.centro),'NaN'),'')::varchar(255)  AS centro,
      NULLIF(NULLIF(btrim(r.tipo_posicion),'NaN'),'')::varchar(250)      AS tipo_posicion,
      NULLIF(NULLIF(btrim(r.tipo_imputacion),'NaN'),'')::varchar(250)    AS tipo_imputacion,
      NULLIF(NULLIF(btrim(r.centro_costo),'NaN'),'')::varchar(250)       AS centro_costo,
      trunc(public.try_numeric(r.orden))::bigint              AS orden,
      NULLIF(NULLIF(btrim(r.elemento_pep),'NaN'),'')::varchar(250)       AS elemento_pep,
      NULLIF(NULLIF(btrim(r.area_funcional),'NaN'),'')::varchar(255)     AS area_funcional,
      NULLIF(NULLIF(btrim(r.linea_negocio),'NaN'),'')::varchar(255)      AS linea_negocio,
      NULLIF(NULLIF(btrim(r.segmento),'NaN'),'')::varchar(255)           AS segmento,
      NULLIF(NULLIF(btrim(r.grupo_segmento),'NaN'),'')::varchar(255)     AS grupo_segmento,
      NULLIF(NULLIF(btrim(r.sub_segmento),'NaN'),'')::varchar(255)       AS sub_segmento,
      NULLIF(NULLIF(btrim(r.indicador_de_impuestos),'NaN'),'')::varchar(255) AS indicador_de_impuestos,
      NULLIF(NULLIF(btrim(r.moneda),'NaN'),'')::varchar(250)  AS moneda,
      NULLIF(NULLIF(btrim(r.licitacion),'NaN'),'')::varchar(250) AS licitacion,
      public.try_numeric(r.precio_neto)::numeric(18,2)        AS precio_neto,
      NULLIF(NULLIF(btrim(r.solicitante),'NaN'),'')::varchar(255) AS solicitante,
      NULLIF(NULLIF(btrim(r.uno),'NaN'),'')::varchar(255)     AS uno,
      NULLIF(NULLIF(btrim(r.dos),'NaN'),'')::varchar(255)     AS dos,
      NULLIF(NULLIF(btrim(r.tres),'NaN'),'')::varchar(255)    AS tres,
      NULLIF(NULLIF(btrim(r.cuatro),'NaN'),'')::varchar(255)  AS cuatro,
      NULLIF(NULLIF(btrim(r.cinco),'NaN'),'')::varchar(255)   AS cinco,
      NULLIF(NULLIF(btrim(r.seis),'NaN'),'')::varchar(255)    AS seis,
      NULLIF(NULLIF(btrim(r.siete),'NaN'),'')::varchar(255)   AS siete,
      NULLIF(NULLIF(btrim(r.ocho),'NaN'),'')::varchar(255)    AS ocho,
      NULLIF(NULLIF(btrim(r.nueve),'NaN'),'')::varchar(255)   AS nueve,
      NULLIF(NULLIF(btrim(r.diez),'NaN'),'')::varchar(255)    AS diez,
      NULLIF(NULLIF(btrim(r.once),'NaN'),'')::varchar(255)    AS once,
      NULLIF(NULLIF(btrim(r.proveedor_flm),'NaN'),'')::varchar(255) AS proveedor_flm,
      NULLIF(NULLIF(btrim(r.numero_de_hoja),'NaN'),'')::varchar(255)   AS numero_de_hoja,
      NULLIF(NULLIF(btrim(r.concesionario),'NaN'),'')::varchar(255)    AS concesionario,
      trunc(public.try_numeric(r.ruc_concesionario))::bigint  AS ruc_concesionario,
      NULLIF(NULLIF(btrim(r.tercero),'NaN'),'')::varchar(255) AS tercero,
      NULLIF(NULLIF(btrim(r.tipo_recibo),'NaN'),'')::varchar(255)  AS tipo_recibo,
      NULLIF(NULLIF(btrim(r.zonal),'NaN'),'')::varchar(255)   AS zonal,
      NULLIF(NULLIF(btrim(r.cliente),'NaN'),'')::varchar(255) AS cliente,
      NULLIF(NULLIF(btrim(r.numero_documento),'NaN'),'')::varchar(255)  AS numero_documento,
      NULLIF(NULLIF(btrim(r.numero_suministro),'NaN'),'')::varchar(255) AS numero_suministro,
      NULLIF(NULLIF(btrim(r.nombre_local),'NaN'),'')::varchar(255)      AS nombre_local,
      NULLIF(NULLIF(btrim(r.direccion_local),'NaN'),'')::varchar(255)   AS direccion_local,
      NULLIF(NULLIF(btrim(r.servicio),'NaN'),'')::varchar(255)          AS servicio,

      CASE
        WHEN r.recibo IS NULL OR btrim(r.recibo) = '' OR lower(btrim(r.recibo)) IN ('nan','null') THEN NULL
        ELSE left(btrim(r.recibo), 255)
      END::varchar(255) AS recibo,

      NULLIF(NULLIF(btrim(r.original),'NaN'),'')::varchar(255)       AS original,
      NULLIF(NULLIF(btrim(r.tipo_recibo_2),'NaN'),'')::varchar(255)  AS tipo_recibo_2,
      NULLIF(NULLIF(btrim(r.tipo_voucher),'NaN'),'')::varchar(255)   AS tipo_voucher,
      NULLIF(NULLIF(btrim(r.porcentaje_voucher),'NaN'),'')::varchar(255) AS porcentaje_voucher,

      public.try_numeric(r.importe_voucher)::numeric(18,2)    AS importe_voucher,
      public.try_numeric(r.base_imponible)::numeric(18,2)     AS base_imponible,
      public.try_numeric(r.pago_inafectos)::numeric(18,2)     AS pago_inafectos,
      public.try_numeric(r.valor_venta_total)::numeric(18,2)  AS valor_venta_total,
      public.try_numeric(r.igv)::numeric(18,2)                AS igv,
      public.try_numeric(r.total_pagado)::numeric(18,2)       AS total_pagado,

      CASE
        WHEN r.fecha_emision IS NULL OR btrim(r.fecha_emision) = '' OR lower(btrim(r.fecha_emision)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_emision) > 0 THEN to_date(split_part(r.fecha_emision,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_emision,' ',1), 'YYYY-MM-DD')
      END AS fecha_emision,

      CASE
        WHEN r.fecha_vencimiento IS NULL OR btrim(r.fecha_vencimiento) = '' OR lower(btrim(r.fecha_vencimiento)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fecha_vencimiento) > 0 THEN to_date(split_part(r.fecha_vencimiento,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fecha_vencimiento,' ',1), 'YYYY-MM-DD')
      END AS fecha_vencimiento,

      NULLIF(NULLIF(btrim(r.periodo_consumo),'NaN'),'')::varchar(255)  AS periodo_consumo,
      NULLIF(NULLIF(btrim(r.mes_facturacion),'NaN'),'')::varchar(255)  AS mes_facturacion,
      NULLIF(NULLIF(btrim(r.periodo_reporte),'NaN'),'')::varchar(255)  AS periodo_reporte,
      NULLIF(NULLIF(btrim(r.observacion),'NaN'),'')::varchar(255)      AS observacion,
      NULLIF(NULLIF(btrim(r.clase),'NaN'),'')::varchar(255)            AS clase,
      NULLIF(NULLIF(btrim(r.numero_sap),'NaN'),'')::varchar(255)       AS numero_sap,
      NULLIF(NULLIF(btrim(r.neteo),'NaN'),'')::varchar(255)            AS neteo,
      NULLIF(NULLIF(btrim(r.cesta),'NaN'),'')::varchar(255)            AS cesta,
      NULLIF(NULLIF(btrim(r.orden_de_compra),'NaN'),'')::varchar(255)  AS orden_de_compra,
      NULLIF(NULLIF(btrim(r.certificacion),'NaN'),'')::varchar(255)    AS certificacion,

      trunc(public.try_numeric(r.soles_comparativo))::bigint   AS soles_comparativo,
      NULLIF(NULLIF(btrim(r.unnamed_76),'NaN'),'')::varchar(250) AS unnamed_76,
      trunc(public.try_numeric(r.codigo_unico_local))::bigint  AS codigo_unico_local,
      trunc(public.try_numeric(r.cuenta))::bigint              AS cuenta,

      CASE
        WHEN r.fe_valor IS NULL OR btrim(r.fe_valor) = '' OR lower(btrim(r.fe_valor)) IN ('nan','null') THEN NULL
        WHEN position('/' in r.fe_valor) > 0 THEN to_date(split_part(r.fe_valor,' ',1), 'DD/MM/YYYY')
        ELSE to_date(split_part(r.fe_valor,' ',1), 'YYYY-MM-DD')
      END AS fe_valor,

      NULLIF(NULLIF(btrim(r.mon),'NaN'),'')::varchar(250)      AS mon,
      public.try_numeric(r.importe_en_md)::numeric(18,2)       AS importe_en_md,
      NULLIF(btrim(r.texto),'')::text                          AS texto,
      NULLIF(NULLIF(btrim(r.asignacion),'NaN'),'')::varchar(250) AS asignacion,
      public.try_numeric(r.deuda_mes_anterior)::numeric(18,2)  AS deuda_mes_anterior,
      trunc(public.try_numeric(r.total_pagado_recibo))::bigint AS total_pagado_recibo

    FROM raw.sftp_mm_pago_energia_pd r
  ),
  dedup AS (
    -- PK ODS: recibo (conserva primera aparición con la clave ya normalizada)
    SELECT DISTINCT ON (recibo) *
    FROM base
    WHERE recibo IS NOT NULL
    ORDER BY recibo, rid
  )
  INSERT INTO ods.sftp_hm_pago_energia (
    contador_pedido, organizacion_compra, grupo_compra, sociedad,
    nota_al_aprobador_char_40, nombre_pedido_char_40, material, texto_breve_del_material,
    cantidad, fecha_de_entrega, ruc_proveedor, condicion_de_pago, centro, tipo_posicion,
    tipo_imputacion, centro_costo, orden, elemento_pep, area_funcional, linea_negocio,
    segmento, grupo_segmento, sub_segmento, indicador_de_impuestos, moneda, licitacion,
    precio_neto, solicitante, uno, dos, tres, cuatro, cinco, seis, siete, ocho, nueve, diez, once,
    proveedor_flm, numero_de_hoja, concesionario, ruc_concesionario, tercero,
    tipo_recibo, zonal, cliente, numero_documento, numero_suministro, nombre_local, direccion_local,
    servicio, recibo, original, tipo_recibo_2, tipo_voucher, porcentaje_voucher,
    importe_voucher, base_imponible, pago_inafectos, valor_venta_total, igv, total_pagado,
    fecha_emision, fecha_vencimiento, periodo_consumo, mes_facturacion, periodo_reporte,
    observacion, clase, numero_sap, neteo, cesta, orden_de_compra, certificacion,
    soles_comparativo, unnamed_76, codigo_unico_local, cuenta, fe_valor, mon,
    importe_en_md, texto, asignacion, deuda_mes_anterior, total_pagado_recibo
  )
  SELECT
    d.contador_pedido, d.organizacion_compra, d.grupo_compra, d.sociedad,
    d.nota_al_aprobador_char_40, d.nombre_pedido_char_40, d.material, d.texto_breve_del_material,
    d.cantidad, d.fecha_de_entrega, d.ruc_proveedor, d.condicion_de_pago, d.centro, d.tipo_posicion,
    d.tipo_imputacion, d.centro_costo, d.orden, d.elemento_pep, d.area_funcional, d.linea_negocio,
    d.segmento, d.grupo_segmento, d.sub_segmento, d.indicador_de_impuestos, d.moneda, d.licitacion,
    d.precio_neto, d.solicitante, d.uno, d.dos, d.tres, d.cuatro, d.cinco, d.seis, d.siete, d.ocho, d.nueve, d.diez, d.once,
    d.proveedor_flm, d.numero_de_hoja, d.concesionario, d.ruc_concesionario, d.tercero,
    d.tipo_recibo, d.zonal, d.cliente, d.numero_documento, d.numero_suministro, d.nombre_local, d.direccion_local,
    d.servicio, d.recibo, d.original, d.tipo_recibo_2, d.tipo_voucher, d.porcentaje_voucher,
    d.importe_voucher, d.base_imponible, d.pago_inafectos, d.valor_venta_total, d.igv, d.total_pagado,
    d.fecha_emision, d.fecha_vencimiento, d.periodo_consumo, d.mes_facturacion, d.periodo_reporte,
    d.observacion, d.clase, d.numero_sap, d.neteo, d.cesta, d.orden_de_compra, d.certificacion,
    d.soles_comparativo, d.unnamed_76, d.codigo_unico_local, d.cuenta, d.fe_valor, d.mon,
    d.importe_en_md, d.texto, d.asignacion, d.deuda_mes_anterior, d.total_pagado_recibo
  FROM dedup d
  LEFT JOIN ods.sftp_hm_pago_energia o
    ON o.recibo = d.recibo
  WHERE o.recibo IS NULL;

  GET DIAGNOSTICS v_inserted = ROW_COUNT;

  v_estado := 'DONE';
  v_msj := format(
    'Insertados en ODS: %s | Enviados a public.error_pago_energia (hoy): %s (duplicados normalizados: %s, nulos/vacíos recibo: %s) | Origen: raw.sftp_mm_pago_energia_pd.',
    v_inserted, COALESCE(v_err_total,0), COALESCE(v_err_dups,0), COALESCE(v_err_nulos,0)
  );

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => NULL::integer,
    p_deleted    => NULL::integer,
    p_nulls      => NULL::integer,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj    := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => NULL::integer,
      p_updated    => NULL::integer,
      p_deleted    => NULL::integer,
      p_nulls      => NULL::integer,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

-----
CREATE OR REPLACE PROCEDURE ods.sp_validacion_hm_checklist(IN p_fecha date DEFAULT CURRENT_DATE)
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio    timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp     integer      := 'ods.sp_validacion_hm_checklist(date)'::regprocedure::oid::int;
  v_sp_name   text         := 'ods.sp_validacion_hm_checklist(date)'::regprocedure::text;

  v_inserted  integer := 0;
  v_updated   integer := 0;
  v_deleted   integer := 0;
  v_nulls     integer := NULL;
  v_estado    varchar(50);
  v_msj       text;

  v_tablas CONSTANT text[] := ARRAY[
    'raw.cf_banco_de_baterias',
    'raw.cf_bastidor_distribucion',
    'raw.cf_cuadro_de_fuerza',
    'raw.cf_modulos_rectificadores',
    'raw.cf_tablero_ac_de_cuadro_de_fu',
    'raw.cf_descarga_controlada_bater',
    'raw.ie_datos_spat_general',
    'raw.ie_mantenimiento_pozo_por_poz',
    'raw.ie_suministro_de_energia',
    'raw.ie_tablero_principal',
    'raw.ie_tablero_secundario'
  ];

  v_t        text;
  v_keep_ts  timestamp;
  v_borradas bigint;
  v_detalle  text := '';
BEGIN
  FOREACH v_t IN ARRAY v_tablas LOOP
    BEGIN
      EXECUTE format(
        'CREATE INDEX IF NOT EXISTS %I ON %s (fechacarga)',
        replace(v_t, '.', '_') || '_fechacarga_idx', v_t
      );

      EXECUTE format(
        'SELECT MAX(fechacarga) FROM %s WHERE fechacarga::date = $1', v_t
      ) USING p_fecha INTO v_keep_ts;

      IF v_keep_ts IS NULL THEN
        v_detalle := v_detalle || format('%s: sin filas %s; ', v_t, p_fecha);
        CONTINUE;
      END IF;

      EXECUTE format(
        'DELETE FROM %s WHERE fechacarga::date = $1 AND fechacarga <> $2', v_t
      ) USING p_fecha, v_keep_ts;

      GET DIAGNOSTICS v_borradas = ROW_COUNT;
      v_deleted := v_deleted + COALESCE(v_borradas,0);

      v_detalle := v_detalle
        || format('%s: keep=%s; borradas=%s; ',
                  v_t, to_char(v_keep_ts,'YYYY-MM-DD HH24:MI:SS'), v_borradas);
    EXCEPTION
      WHEN undefined_column THEN
        v_detalle := v_detalle || format('%s: ERROR sin columna fechacarga; ', v_t);
      WHEN OTHERS THEN
        v_detalle := v_detalle || format('%s: ERROR %s; ', v_t, SQLERRM);
    END;
  END LOOP;

  v_estado := 'DONE';
  v_msj := format('Validación HM Checklist (fecha=%s). Borradas=%s. %s',
                  p_fecha, v_deleted, v_detalle);

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,
    p_deleted    => v_deleted,
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );
EXCEPTION
  WHEN OTHERS THEN
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => 'ERROR',
      p_msj_error  => SQLERRM,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

------
-- DROP PROCEDURE ods.sp_cargar_web_hm_autin_infogeneral();

CREATE OR REPLACE PROCEDURE ods.sp_cargar_web_hm_autin_infogeneral()
 LANGUAGE plpgsql
AS $procedure$
DECLARE
  v_inicio   timestamp(0) := clock_timestamp()::timestamp(0);
  v_id_sp    integer      := 'ods.sp_cargar_web_hm_autin_infogeneral()'::regprocedure::oid::int;
  v_sp_name  text         := 'ods.sp_cargar_web_hm_autin_infogeneral()';
  v_inserted integer := 0;
  v_updated  integer := 0;  -- no actualiza
  v_deleted  integer := 0;  -- no borra
  v_nulls    integer := NULL;
  v_estado   varchar(50);
  v_msj      text;
BEGIN
  /*
    1) STG: limpia y castea tipos.
    2) DEDUP: toma 1 fila por task_id (DISTINCT ON).
    3) INSERTA solo los task_id que NO existen en ODS.
  */
  WITH
  stg AS (
    SELECT
      NULLIF(btrim(r.task_id), '') AS task_id,

      /* --------- Timestamp helpers (varios formatos) --------- */
      -- createtime
      CASE
        WHEN NULLIF(btrim(r.createtime),'') IS NULL THEN NULL
        WHEN regexp_replace(r.createtime,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.createtime,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.createtime ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.createtime::date::timestamp
        WHEN r.createtime ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.createtime,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.createtime ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.createtime,'DD/MM/YYYY HH24:MI')
        WHEN r.createtime ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.createtime,'DD/MM/YYYY')::timestamp
        WHEN r.createtime ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.createtime,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.createtime ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.createtime,'DD-MM-YYYY HH24:MI')
        WHEN r.createtime ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.createtime,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS createtime,

      -- dispatch_time
      CASE
        WHEN NULLIF(btrim(r.dispatch_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.dispatch_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.dispatch_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.dispatch_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.dispatch_time::date::timestamp
        WHEN r.dispatch_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.dispatch_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.dispatch_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.dispatch_time,'DD/MM/YYYY HH24:MI')
        WHEN r.dispatch_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.dispatch_time,'DD/MM/YYYY')::timestamp
        WHEN r.dispatch_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.dispatch_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.dispatch_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.dispatch_time,'DD-MM-YYYY HH24:MI')
        WHEN r.dispatch_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.dispatch_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS dispatch_time,

      -- accept_time
      CASE
        WHEN NULLIF(btrim(r.accept_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.accept_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.accept_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.accept_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.accept_time::date::timestamp
        WHEN r.accept_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.accept_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.accept_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.accept_time,'DD/MM/YYYY HH24:MI')
        WHEN r.accept_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.accept_time,'DD/MM/YYYY')::timestamp
        WHEN r.accept_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.accept_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.accept_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.accept_time,'DD-MM-YYYY HH24:MI')
        WHEN r.accept_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.accept_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS accept_time,

      -- depart_time
      CASE
        WHEN NULLIF(btrim(r.depart_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.depart_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.depart_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.depart_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.depart_time::date::timestamp
        WHEN r.depart_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.depart_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.depart_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.depart_time,'DD/MM/YYYY HH24:MI')
        WHEN r.depart_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.depart_time,'DD/MM/YYYY')::timestamp
        WHEN r.depart_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.depart_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.depart_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.depart_time,'DD-MM-YYYY HH24:MI')
        WHEN r.depart_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.depart_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS depart_time,

      -- arrive_time
      CASE
        WHEN NULLIF(btrim(r.arrive_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.arrive_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.arrive_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.arrive_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.arrive_time::date::timestamp
        WHEN r.arrive_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.arrive_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.arrive_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.arrive_time,'DD/MM/YYYY HH24:MI')
        WHEN r.arrive_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.arrive_time,'DD/MM/YYYY')::timestamp
        WHEN r.arrive_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.arrive_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.arrive_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.arrive_time,'DD-MM-YYYY HH24:MI')
        WHEN r.arrive_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.arrive_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS arrive_time,

      -- complete_time
      CASE
        WHEN NULLIF(btrim(r.complete_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.complete_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.complete_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.complete_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.complete_time::date::timestamp
        WHEN r.complete_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.complete_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.complete_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.complete_time,'DD/MM/YYYY HH24:MI')
        WHEN r.complete_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.complete_time,'DD/MM/YYYY')::timestamp
        WHEN r.complete_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.complete_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.complete_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.complete_time,'DD-MM-YYYY HH24:MI')
        WHEN r.complete_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.complete_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS complete_time,

      /* TEXT plano en ODS */
      left(NULLIF(btrim(r.require_finish_time),''), 500) AS require_finish_time,

      -- first_complete_time
      CASE
        WHEN NULLIF(btrim(r.first_complete_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.first_complete_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.first_complete_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.first_complete_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.first_complete_time::date::timestamp
        WHEN r.first_complete_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.first_complete_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.first_complete_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.first_complete_time,'DD/MM/YYYY HH24:MI')
        WHEN r.first_complete_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.first_complete_time,'DD/MM/YYYY')::timestamp
        WHEN r.first_complete_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.first_complete_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.first_complete_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.first_complete_time,'DD-MM-YYYY HH24:MI')
        WHEN r.first_complete_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.first_complete_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS first_complete_time,

      -- cancel_time
      CASE
        WHEN NULLIF(btrim(r.cancel_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.cancel_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.cancel_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.cancel_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.cancel_time::date::timestamp
        WHEN r.cancel_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.cancel_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.cancel_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.cancel_time,'DD/MM/YYYY HH24:MI')
        WHEN r.cancel_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.cancel_time,'DD/MM/YYYY')::timestamp
        WHEN r.cancel_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.cancel_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.cancel_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.cancel_time,'DD-MM-YYYY HH24:MI')
        WHEN r.cancel_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.cancel_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS cancel_time,

      NULLIF(btrim(r.cancel_operator),'')            AS cancel_operator,
      NULLIF(btrim(r.cancel_reason),'')              AS cancel_reason,
      NULLIF(btrim(r.task_status),'')                AS task_status,
      NULLIF(btrim(r.com_fault_speciality),'')       AS com_fault_speciality,
      NULLIF(btrim(r.com_fault_sub_speciality),'')   AS com_fault_sub_speciality,
      NULLIF(btrim(r.com_fault_cause),'')            AS com_fault_cause,
      NULLIF(btrim(r.leave_observations),'')         AS leave_observations,
      NULLIF(btrim(r.site_id),'')                    AS site_id,
      NULLIF(btrim(r.site_priority),'')              AS site_priority,
      NULLIF(btrim(r.title),'')                      AS title,
      NULLIF(btrim(r.description),'')                AS description,
      NULLIF(btrim(r.nro_toa),'')                    AS nro_toa,
      NULLIF(btrim(r.company_supply),'')             AS company_supply,
      NULLIF(btrim(r.zona),'')                       AS zona,
      NULLIF(btrim(r.departamento),'')               AS departamento,
      NULLIF(btrim(r.torrero),'')                    AS torrero,
      NULLIF(btrim(r.task_type),'')                  AS task_type,
      NULLIF(btrim(r.fm_office),'')                  AS fm_office,
      NULLIF(btrim(r.region),'')                     AS region,
      NULLIF(btrim(r.site_id_name),'')               AS site_id_name,
      NULLIF(btrim(r.site_location_type),'')         AS site_location_type,

      CASE WHEN NULLIF(btrim(r.sla),'') ~ '^-?\d+$'
           THEN r.sla::bigint ELSE NULL END          AS sla,
      NULLIF(btrim(r.sla_status),'')                 AS sla_status,
      NULLIF(btrim(r.suspend_state),'')              AS suspend_state,
      NULLIF(btrim(r.create_operator),'')            AS create_operator,

      -- fault_first_occur_time
      CASE
        WHEN NULLIF(btrim(r.fault_first_occur_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.fault_first_occur_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.fault_first_occur_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.fault_first_occur_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.fault_first_occur_time::date::timestamp
        WHEN r.fault_first_occur_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fault_first_occur_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.fault_first_occur_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fault_first_occur_time,'DD/MM/YYYY HH24:MI')
        WHEN r.fault_first_occur_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.fault_first_occur_time,'DD/MM/YYYY')::timestamp
        WHEN r.fault_first_occur_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fault_first_occur_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.fault_first_occur_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fault_first_occur_time,'DD-MM-YYYY HH24:MI')
        WHEN r.fault_first_occur_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.fault_first_occur_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS fault_first_occur_time,

      NULLIF(btrim(r.schedule_operator),'')          AS schedule_operator,

      -- schedule_time
      CASE
        WHEN NULLIF(btrim(r.schedule_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.schedule_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.schedule_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.schedule_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.schedule_time::date::timestamp
        WHEN r.schedule_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.schedule_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.schedule_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.schedule_time,'DD/MM/YYYY HH24:MI')
        WHEN r.schedule_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.schedule_time,'DD/MM/YYYY')::timestamp
        WHEN r.schedule_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.schedule_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.schedule_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.schedule_time,'DD-MM-YYYY HH24:MI')
        WHEN r.schedule_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.schedule_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS schedule_time,

      NULLIF(btrim(r.assign_to_fme),'')              AS assign_to_fme,
      NULLIF(btrim(r.assign_to_fme_full_name),'')    AS assign_to_fme_full_name,
      NULLIF(btrim(r.dispatch_operator),'')          AS dispatch_operator,
      NULLIF(btrim(r.depart_operator),'')            AS depart_operator,
      NULLIF(btrim(r.arrive_operator),'')            AS arrive_operator,
      NULLIF(btrim(r.complete_operator),'')          AS complete_operator,

      /* TEXT en ODS */
      NULLIF(btrim(r.reject_time),'')                AS reject_time,
      NULLIF(btrim(r.reject_operator),'')            AS reject_operator,
      NULLIF(btrim(r.reject_des),'')                 AS reject_des,
      NULLIF(btrim(r.com_level_1_aff_equip),'')      AS com_level_1_aff_equip,
      NULLIF(btrim(r.com_level_2_aff_equip),'')      AS com_level_2_aff_equip,
      NULLIF(btrim(r.com_level_3_aff_equip),'')      AS com_level_3_aff_equip,
      NULLIF(btrim(r.fault_type),'')                 AS fault_type,
      NULLIF(btrim(r.task_category),'')              AS task_category,
      NULLIF(btrim(r.task_subcategory),'')           AS task_subcategory,
      NULLIF(btrim(r.fme_contrator),'')              AS fme_contrator,
      NULLIF(btrim(r.contratista_sitio),'')          AS contratista_sitio,
      NULLIF(btrim(r.complete_operator_name),'')     AS complete_operator_name,
      NULLIF(btrim(r.reject_operator_name),'')       AS reject_operator_name,
      NULLIF(btrim(r.arrive_operator_name),'')       AS arrive_operator_name,
      NULLIF(btrim(r.depart_operator_name),'')       AS depart_operator_name,
      NULLIF(btrim(r.dispatch_operator_name),'')     AS dispatch_operator_name,
      NULLIF(btrim(r.cancel_operator_name),'')       AS cancel_operator_name,
      NULLIF(btrim(r.schedule_operator_name),'')     AS schedule_operator_name,
      NULLIF(btrim(r.create_operator_name),'')       AS create_operator_name,
      NULLIF(btrim(r.situacion_encontrada),'')       AS situacion_encontrada,
      NULLIF(btrim(r.detalle_de_actuacion_realizada),'') AS detalle_de_actuacion_realizada,
      NULLIF(btrim(r.atencion_incidencias),'')       AS atencion_incidencias,
      NULLIF(btrim(r.remedy_id),'')                  AS remedy_id,

      -- first_pause_time
      CASE
        WHEN NULLIF(btrim(r.first_pause_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.first_pause_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.first_pause_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.first_pause_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.first_pause_time::date::timestamp
        WHEN r.first_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.first_pause_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.first_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.first_pause_time,'DD/MM/YYYY HH24:MI')
        WHEN r.first_pause_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.first_pause_time,'DD/MM/YYYY')::timestamp
        WHEN r.first_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.first_pause_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.first_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.first_pause_time,'DD-MM-YYYY HH24:MI')
        WHEN r.first_pause_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.first_pause_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS first_pause_time,

      NULLIF(btrim(r.first_pause_operator),'')       AS first_pause_operator,
      NULLIF(btrim(r.first_pause_reason),'')         AS first_pause_reason,
      NULLIF(btrim(r.first_resume_operator),'')      AS first_resume_operator,

      -- first_resume_time
      CASE
        WHEN NULLIF(btrim(r.first_resume_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.first_resume_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.first_resume_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.first_resume_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.first_resume_time::date::timestamp
        WHEN r.first_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.first_resume_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.first_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.first_resume_time,'DD/MM/YYYY HH24:MI')
        WHEN r.first_resume_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.first_resume_time,'DD/MM/YYYY')::timestamp
        WHEN r.first_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.first_resume_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.first_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.first_resume_time,'DD-MM-YYYY HH24:MI')
        WHEN r.first_resume_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.first_resume_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS first_resume_time,

      -- second_pause_time
      CASE
        WHEN NULLIF(btrim(r.second_pause_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.second_pause_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.second_pause_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.second_pause_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.second_pause_time::date::timestamp
        WHEN r.second_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.second_pause_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.second_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.second_pause_time,'DD/MM/YYYY HH24:MI')
        WHEN r.second_pause_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.second_pause_time,'DD/MM/YYYY')::timestamp
        WHEN r.second_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.second_pause_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.second_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.second_pause_time,'DD-MM-YYYY HH24:MI')
        WHEN r.second_pause_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.second_pause_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS second_pause_time,

      NULLIF(btrim(r.second_pause_reason),'')        AS second_pause_reason,
      NULLIF(btrim(r.second_pause_operator),'')      AS second_pause_operator,

      -- second_resume_time
      CASE
        WHEN NULLIF(btrim(r.second_resume_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.second_resume_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.second_resume_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.second_resume_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.second_resume_time::date::timestamp
        WHEN r.second_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.second_resume_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.second_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.second_resume_time,'DD/MM/YYYY HH24:MI')
        WHEN r.second_resume_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.second_resume_time,'DD/MM/YYYY')::timestamp
        WHEN r.second_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.second_resume_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.second_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.second_resume_time,'DD-MM-YYYY HH24:MI')
        WHEN r.second_resume_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.second_resume_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS second_resume_time,

      -- *** FIX agregado ***
      NULLIF(btrim(r.second_resume_operator),'')     AS second_resume_operator,

      -- third_pause_time
      CASE
        WHEN NULLIF(btrim(r.third_pause_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.third_pause_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.third_pause_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.third_pause_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.third_pause_time::date::timestamp
        WHEN r.third_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.third_pause_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.third_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.third_pause_time,'DD/MM/YYYY HH24:MI')
        WHEN r.third_pause_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.third_pause_time,'DD/MM/YYYY')::timestamp
        WHEN r.third_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.third_pause_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.third_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.third_pause_time,'DD-MM-YYYY HH24:MI')
        WHEN r.third_pause_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.third_pause_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS third_pause_time,

      NULLIF(btrim(r.third_pause_reason),'')         AS third_pause_reason,
      NULLIF(btrim(r.third_pause_operator),'')       AS third_pause_operator,

      -- third_resume_time
      CASE
        WHEN NULLIF(btrim(r.third_resume_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.third_resume_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.third_resume_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.third_resume_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.third_resume_time::date::timestamp
        WHEN r.third_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.third_resume_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.third_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.third_resume_time,'DD/MM/YYYY HH24:MI')
        WHEN r.third_resume_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.third_resume_time,'DD/MM/YYYY')::timestamp
        WHEN r.third_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.third_resume_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.third_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.third_resume_time,'DD-MM-YYYY HH24:MI')
        WHEN r.third_resume_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.third_resume_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS third_resume_time,

      NULLIF(btrim(r.third_resume_operator),'')      AS third_resume_operator,

      -- fourth_pause_time
      CASE
        WHEN NULLIF(btrim(r.fourth_pause_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.fourth_pause_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.fourth_pause_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.fourth_pause_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.fourth_pause_time::date::timestamp
        WHEN r.fourth_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_pause_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.fourth_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_pause_time,'DD/MM/YYYY HH24:MI')
        WHEN r.fourth_pause_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.fourth_pause_time,'DD/MM/YYYY')::timestamp
        WHEN r.fourth_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_pause_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.fourth_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_pause_time,'DD-MM-YYYY HH24:MI')
        WHEN r.fourth_pause_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.fourth_pause_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS fourth_pause_time,

      NULLIF(btrim(r.fourth_pause_reason),'')        AS fourth_pause_reason,
      NULLIF(btrim(r.fourth_pause_operator),'')      AS fourth_pause_operator,

      -- fourth_resume_time
      CASE
        WHEN NULLIF(btrim(r.fourth_resume_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.fourth_resume_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.fourth_resume_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.fourth_resume_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.fourth_resume_time::date::timestamp
        WHEN r.fourth_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_resume_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.fourth_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_resume_time,'DD/MM/YYYY HH24:MI')
        WHEN r.fourth_resume_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.fourth_resume_time,'DD/MM/YYYY')::timestamp
        WHEN r.fourth_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_resume_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.fourth_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fourth_resume_time,'DD-MM-YYYY HH24:MI')
        WHEN r.fourth_resume_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.fourth_resume_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS fourth_resume_time,

      NULLIF(btrim(r.fourth_resume_operator),'')     AS fourth_resume_operator,

      -- fifth_pause_time
      CASE
        WHEN NULLIF(btrim(r.fifth_pause_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.fifth_pause_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.fifth_pause_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.fifth_pause_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.fifth_pause_time::date::timestamp
        WHEN r.fifth_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_pause_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.fifth_pause_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_pause_time,'DD/MM/YYYY HH24:MI')
        WHEN r.fifth_pause_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.fifth_pause_time,'DD/MM/YYYY')::timestamp
        WHEN r.fifth_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_pause_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.fifth_pause_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_pause_time,'DD-MM-YYYY HH24:MI')
        WHEN r.fifth_pause_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.fifth_pause_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS fifth_pause_time,

      NULLIF(btrim(r.fifth_pause_reason),'')         AS fifth_pause_reason,
      NULLIF(btrim(r.fifth_pause_operator),'')       AS fifth_pause_operator,

      -- fifth_resume_time
      CASE
        WHEN NULLIF(btrim(r.fifth_resume_time),'') IS NULL THEN NULL
        WHEN regexp_replace(r.fifth_resume_time,'Z$','') ~ '^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}(\.\d+)?$'
          THEN replace(split_part(regexp_replace(r.fifth_resume_time,'Z$',''),'.',1),'T',' ')::timestamp
        WHEN r.fifth_resume_time ~ '^\d{4}-\d{2}-\d{2}$'
          THEN r.fifth_resume_time::date::timestamp
        WHEN r.fifth_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_resume_time,'DD/MM/YYYY HH24:MI:SS')
        WHEN r.fifth_resume_time ~ '^\d{2}/\d{2}/\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_resume_time,'DD/MM/YYYY HH24:MI')
        WHEN r.fifth_resume_time ~ '^\d{2}/\d{2}/\d{4}$'
          THEN to_date(r.fifth_resume_time,'DD/MM/YYYY')::timestamp
        WHEN r.fifth_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_resume_time,'DD-MM-YYYY HH24:MI:SS')
        WHEN r.fifth_resume_time ~ '^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$'
          THEN to_timestamp(r.fifth_resume_time,'DD-MM-YYYY HH24:MI')
        WHEN r.fifth_resume_time ~ '^\d{2}-\d{2}-\d{4}$'
          THEN to_date(r.fifth_resume_time,'DD-MM-YYYY')::timestamp
        ELSE NULL
      END AS fifth_resume_time,

      NULLIF(btrim(r.fifth_resume_operator),'')      AS fifth_resume_operator,

      NULLIF(btrim(r.reject_flag),'')                AS reject_flag,
      CASE WHEN NULLIF(btrim(r.reject_counter),'') ~ '^-?\d+$'
           THEN r.reject_counter::bigint ELSE NULL END AS reject_counter,
      NULLIF(btrim(r.fuel_type),'')                  AS fuel_type
    FROM raw.web_mm_autin_infogeneral r
    WHERE NULLIF(btrim(r.task_id),'') IS NOT NULL
  ),
  dedup AS (
    SELECT DISTINCT ON (task_id) *
    FROM stg
    ORDER BY task_id
  ),
  ins AS (
    INSERT INTO ods.web_hm_autin_infogeneral (
      task_id, createtime, dispatch_time, accept_time, depart_time, arrive_time, complete_time,
      require_finish_time, first_complete_time, cancel_time, cancel_operator, cancel_reason, task_status,
      com_fault_speciality, com_fault_sub_speciality, com_fault_cause, leave_observations, site_id,
      site_priority, title, description, nro_toa, company_supply, zona, departamento, torrero, task_type,
      fm_office, region, site_id_name, site_location_type, sla, sla_status, suspend_state, create_operator,
      fault_first_occur_time, schedule_operator, schedule_time, assign_to_fme, assign_to_fme_full_name,
      dispatch_operator, depart_operator, arrive_operator, complete_operator, reject_time, reject_operator,
      reject_des, com_level_1_aff_equip, com_level_2_aff_equip, com_level_3_aff_equip, fault_type,
      task_category, task_subcategory, fme_contrator, contratista_sitio, complete_operator_name,
      reject_operator_name, arrive_operator_name, depart_operator_name, dispatch_operator_name,
      cancel_operator_name, schedule_operator_name, create_operator_name, situacion_encontrada,
      detalle_de_actuacion_realizada, atencion_incidencias, remedy_id, first_pause_time, first_pause_operator,
      first_pause_reason, first_resume_operator, first_resume_time, second_pause_time, second_pause_reason,
      second_pause_operator, second_resume_time, second_resume_operator, third_pause_time, third_pause_reason,
      third_pause_operator, third_resume_time, third_resume_operator, fourth_pause_time, fourth_pause_reason,
      fourth_pause_operator, fourth_resume_time, fourth_resume_operator, fifth_pause_time, fifth_pause_reason,
      fifth_pause_operator, fifth_resume_time, fifth_resume_operator, reject_flag, reject_counter, fuel_type
    )
    SELECT
      s.task_id, s.createtime, s.dispatch_time, s.accept_time, s.depart_time, s.arrive_time, s.complete_time,
      s.require_finish_time, s.first_complete_time, s.cancel_time, s.cancel_operator, s.cancel_reason, s.task_status,
      s.com_fault_speciality, s.com_fault_sub_speciality, s.com_fault_cause, s.leave_observations, s.site_id,
      s.site_priority, s.title, s.description, s.nro_toa, s.company_supply, s.zona, s.departamento, s.torrero, s.task_type,
      s.fm_office, s.region, s.site_id_name, s.site_location_type, s.sla, s.sla_status, s.suspend_state, s.create_operator,
      s.fault_first_occur_time, s.schedule_operator, s.schedule_time, s.assign_to_fme, s.assign_to_fme_full_name,
      s.dispatch_operator, s.depart_operator, s.arrive_operator, s.complete_operator, s.reject_time, s.reject_operator,
      s.reject_des, s.com_level_1_aff_equip, s.com_level_2_aff_equip, s.com_level_3_aff_equip, s.fault_type,
      s.task_category, s.task_subcategory, s.fme_contrator, s.contratista_sitio, s.complete_operator_name,
      s.reject_operator_name, s.arrive_operator_name, s.depart_operator_name, s.dispatch_operator_name,
      s.cancel_operator_name, s.schedule_operator_name, s.create_operator_name, s.situacion_encontrada,
      s.detalle_de_actuacion_realizada, s.atencion_incidencias, s.remedy_id, s.first_pause_time, s.first_pause_operator,
      s.first_pause_reason, s.first_resume_operator, s.first_resume_time, s.second_pause_time, s.second_pause_reason,
      s.second_pause_operator, s.second_resume_time, s.second_resume_operator, s.third_pause_time, s.third_pause_reason,
      s.third_pause_operator, s.third_resume_time, s.third_resume_operator, s.fourth_pause_time, s.fourth_pause_reason,
      s.fourth_pause_operator, s.fourth_resume_time, s.fourth_resume_operator, s.fifth_pause_time, s.fifth_pause_reason,
      s.fifth_pause_operator, s.fifth_resume_time, s.fifth_resume_operator, s.reject_flag, s.reject_counter, s.fuel_type
    FROM dedup s
    LEFT JOIN ods.web_hm_autin_infogeneral t
      ON t.task_id = s.task_id
    WHERE t.task_id IS NULL
    RETURNING 1
  )
  SELECT COALESCE((SELECT COUNT(*) FROM ins), 0)
  INTO v_inserted;

  v_estado := 'DONE';
  v_msj := format('Insertados en ODS: %s | Upd: %s | Del: %s | Origen: raw.web_mm_autin_infogeneral',
                  v_inserted, v_updated, v_deleted);

  CALL public.sp_grabar_log_sp(
    p_id_sp      => v_id_sp,
    p_inicio     => v_inicio,
    p_fin        => clock_timestamp()::timestamp(0),
    p_inserted   => v_inserted,
    p_updated    => v_updated,
    p_deleted    => v_deleted,
    p_nulls      => v_nulls,
    p_estado     => v_estado,
    p_msj_error  => v_msj,
    p_sp         => v_sp_name
  );

EXCEPTION
  WHEN OTHERS THEN
    v_estado := 'ERROR';
    v_msj := SQLERRM;
    CALL public.sp_grabar_log_sp(
      p_id_sp      => v_id_sp,
      p_inicio     => v_inicio,
      p_fin        => clock_timestamp()::timestamp(0),
      p_inserted   => v_inserted,
      p_updated    => v_updated,
      p_deleted    => v_deleted,
      p_nulls      => v_nulls,
      p_estado     => v_estado,
      p_msj_error  => v_msj,
      p_sp         => v_sp_name
    );
    RAISE;
END;
$procedure$
;

